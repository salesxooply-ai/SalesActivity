<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sales (Hibrida)</title>
    <link rel="icon" type="image/png" href="xooply2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Menggunakan Inter sebagai font utama, dengan fallback ke font sistem sans-serif */
        body { font-family: 'Inter', sans-serif; }
        
        /* Style untuk tombol filter periode yang aktif */
        .filter-btn.active { background-color: #3b82f6; color: white; }
        
        /* Style untuk tooltip (saat ini tidak digunakan, tapi ada di kode asli) */
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Custom style untuk status deal (Sekarang hanya label statis) */
        .status-label {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Warna spesifik untuk setiap status */
        .status-Awareness { background-color: #2563eb22; color: #3b82f6; border: 1px solid #3b82f6; } 
        .status-Interest { background-color: #05966922; color: #10b981; border: 1px solid #10b981; } 
        .status-Desire { background-color: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b; } 
        .status-ProcessClosing { background-color: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b; } 
        .status-Action { background-color: #ef444422; color: #ef4444; border: 1px solid #ef4444; } 
        .status-Delivery { background-color: #3b82f622; color: #3b82f6; border: 1px solid #3b82f6; } 
        .status-Payment { background-color: #10b98122; color: #10b981; border: 1px solid #10b981; } 
        .status-Lost { background-color: #7f1d1d22; color: #f87171; border: 1px solid #f87171; } 

        /* Style untuk AIDA progress bar */
        .progress-bar-container {
            display: flex;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            background-color: #374151; /* Darker background for empty space */
        }

        .progress-segment {
            height: 100%;
            transition: width 0.5s ease-out;
            border-right: 1px solid #1f2937; /* Pemisah tipis antar segmen */
        }
        .progress-segment:last-child {
            border-right: none;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .grid-cols-2-mobile {
                grid-template-columns: 1fr;
            }
        }

        /* --- PERBAIKAN TATA LETAK KALENDER (TINGGI BARU) --- */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #374151; 
            border: 1px solid #374151; 
        }
        .calendar-day-header { 
            font-size: 0.75rem; 
            text-align: center; 
            padding: 8px 0; 
            font-weight: 500; 
            color: #9ca3af; 
            background-color: #374151; 
        }
        .calendar-cell { 
            background-color: #1f293b; 
            padding: 4px; 
            min-height: 95px; /* Disesuaikan agar sejajar dengan 3 grafik di kanan */
            position: relative; 
            display: flex; 
            flex-direction: column;
            overflow: hidden; /* **PENTING**: Mencegah event keluar dari batas sel */
        }
        .calendar-date { 
            font-size: 0.8rem; 
            font-weight: 500; 
            margin-bottom: 4px; 
            color: #d1d5db; 
        }
        /* Style .calendar-event LAMA diganti di bawah */
        .calendar-event { 
            background-color: #3b82f6; 
            border-left: 3px solid #60a5fa; 
            color: white; 
            padding: 1px 4px; /* Padding dikurangi */
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; /* Font size dikurangi */
            cursor: pointer; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .today .calendar-date { 
            background-color: #3b82f6; 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 2px;
        }
        
        /* Style untuk tabel baru */
        #supportTableContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #supportTableContainer th, #supportTableContainer td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151; /* Garis pemisah abu-abu tua */
        }
        #supportTableContainer th {
            background-color: #1f293b; /* Header abu-abu gelap */
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af; /* Teks abu-abu terang */
            font-weight: 600;
        }
        #supportTableContainer tr:hover {
            background-color: #2a3447; /* Hover row yang lebih gelap */
        }
        #supportTableContainer td {
            font-size: 0.875rem;
            color: #d1d5db; /* Teks putih keabu-abuan */
        }
         /* Style untuk tombol "+ Lainnya" di kalender */
        .calendar-others {
            font-size: 0.7rem;
            color: #a5f3fc; /* text-cyan-200 */
            text-align: center;
            padding: 1px 4px; /* Padding dikurangi */
            margin-top: 2px;
            border-radius: 2px;
            background-color: #334155; /* bg-slate-700 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-others:hover {
            background-color: #475569; /* bg-slate-600 */
        }

        /* --- FADE-IN BARU UNTUK DASHBOARD (DURASI LEBIH LAMA) --- */
        .fade-in-dashboard {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out; /* Ditingkatkan ke 0.8s */
        }
        .fade-in-dashboard.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* --- AKHIR FADE-IN BARU --- */

        /* --- STYLE BARU UNTUK TAB --- */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .active-tab {
            color: #3b82f6; /* text-blue-500 */
            border-bottom-color: #3b82f6;
        }
        .inactive-tab {
            color: #9ca3af; /* text-gray-400 */
        }
        .inactive-tab:hover {
            color: #d1d5db; /* text-gray-300 */
            border-bottom-color: #4b5563; /* border-gray-600 */
        }
        
        /* --- STYLE BARU UNTUK EVENT KALENDER --- */
        .calendar-event-realized { 
            background-color: #3b82f6; /* Solid Biru (Realisasi) */
            border-left: 3px solid #60a5fa; 
            color: white; 
            padding: 1px 4px; 
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; 
            cursor: pointer; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .calendar-event-planned { 
            background-color: transparent;
            border: 1px dashed #475569; /* Garis putus-putus (Rencana) */
            color: #9ca3af; /* text-gray-400 */
            padding: 1px 4px; 
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }

.tab-count-active {
            display: inline-block;
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 9999px; /* rounded-full */
            margin-left: 4px;
        }
        .tab-count-zero {
            display: inline-block;
            background-color: #4b5563; /* bg-gray-600 */
            color: #d1d5db; /* text-gray-300 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 9999px; /* rounded-full */
            margin-left: 4px;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="loginScreen" class="flex min-h-screen w-full bg-gray-900 overflow-hidden">

    <div class="relative flex-1 hidden md:block bg-black">
        <video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
            <source src="https://www.dropbox.com/scl/fi/42ebnwuhxvcwptzutqjty/WhatsApp-Video-2025-11-30-at-11.43.54.mp4?rlkey=3e3riklu66q50oxz8se49cxp4&st=gspzbs5r&raw=1" type="video/mp4">
            Browser Anda tidak mendukung tag video.
        </video>
        <div class="absolute inset-0 bg-black/20"></div>
    </div>

    <div class="w-full md:w-[450px] bg-gray-800 border-l border-gray-700 flex flex-col justify-center p-8 relative z-10 shadow-2xl">
        
        <div class="w-full max-w-sm mx-auto space-y-6">
            
            <div class="text-center mb-8">
                <img src="https://info.xooply.id/wp-content/uploads/2023/01/Xooply-New-Fix.png" alt="Company Logo" class="h-14 w-auto mx-auto mb-4 bg-white p-2 rounded-lg">
                <h1 class="text-2xl font-bold text-white tracking-tight">Sales Dashboard</h1>
                <p class="text-sm text-gray-400 mt-1">Silakan login untuk melanjutkan</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="roleSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Peran</label>
                    <select id="roleSelector" class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="sales">Sales Person</option>
                        <option value="manager">Manager</option>
                        <option value="head_sales">Head Sales</option>
                    </select>
                </div>

                <div id="managerSelectorContainer" class="hidden">
                    <label for="managerSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Manager</label>
                    <select id="managerSelector" class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>

                <div id="salesPersonSelectorContainer">
                    <label for="salesPersonSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Nama Anda</label>
                    <select id="salesPersonSelector" class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>

                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="passwordInput" class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="••••••••">
                </div>

                <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 shadow-lg mt-4">
                    Masuk Dashboard
                </button>

                <p id="loginError" class="text-red-400 text-sm text-center pt-2 hidden bg-red-900/20 p-2 rounded border border-red-900/50">
                    <i data-lucide="alert-circle" class="inline w-4 h-4 mr-1"></i> Password atau username salah.
                </p>
            </div>

            <div class="text-center mt-8 pt-6 border-t border-gray-700">
                <p class="text-xs text-gray-500">&copy; 2025 Xooply. All rights reserved.</p>
            </div>
        </div>
    </div>
</div>
    <div id="loadingIndicator" class="flex flex-col items-center justify-center min-h-screen p-4 text-center hidden bg-black">
    <img src="https://i.pinimg.com/originals/71/3a/32/713a3272124cc57ba9e9fb7f59e9ab3b.gif" 
         alt="Loading..." 
         class="h-32 w-auto mx-auto object-contain">
    
    <p class="text-blue-400 mt-2 font-mono text-sm tracking-widest animate-pulse">MEMUAT DATA DASHBOARD...</p>
</div>

    <div id="mainContent" class="hidden container mx-auto p-4 md:p-8 fade-in-dashboard">

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                 <h1 class="text-3xl font-bold text-white mb-2">Dashboard Sales Activity</h1>
                 <p id="dashboardSubtitle" class="text-gray-400">Analisis Gabungan Kinerja dan Aktivitas Harian.</p> 
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <button id="logoutBtn" class="flex items-center bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm border border-gray-600 hover:bg-gray-600 transition-colors">
                    <i data-lucide="log-out" class="mr-2 h-5 w-5"></i>
                    Logout
                </button>
            </div>
        </header>

        <div id="salesTabsContainer" class="mb-6 border-b border-gray-700 hidden">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-btn-1" data-tab="1" 
                        class="tab-button active-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="calendar-plus" class="inline-block h-5 w-5 mr-2"></i>
                    1. Perencanaan
                </button>
                <button id="tab-btn-2" data-tab="2" 
                        class="tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="edit-3" class="inline-block h-5 w-5 mr-2"></i>
                    2. Realisasi
                </button>
                <button id="tab-btn-3" data-tab="3" 
                        class="tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="layout-dashboard" class="inline-block h-5 w-5 mr-2"></i>
                    3. Dashboard Summary
                </button>
            </nav>
        </div>
        
        <div id="tab-content">
            
            <div id="tab-panel-1" class="tab-panel hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-semibold text-white">Total Aktivitas Terjadwal</h2>
                            <i data-lucide="calendar-check-2" class="h-6 w-6 text-green-400"></i>
                        </div>
                        <p class="text-5xl font-bold text-white mb-3" id="metricRencanaTotal">0</p>
                        <div class="flex items-center text-sm text-green-400">
                            <i data-lucide="check-circle-2" class="h-4 w-4 mr-2"></i>
                            <span id="metricRencanaSelesai" class="font-medium mr-1">0</span> Selesai
                        </div>
                        <div class="flex items-center text-sm text-yellow-400 mt-1">
                            <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                            <span id="metricRencanaMenunggu" class="font-medium mr-1">0</span> Menunggu
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-semibold text-white">Rata-rata Realisasi Harian</h2>
                            <i data-lucide="map-pin" class="h-6 w-6 text-blue-400"></i>
                        </div>
                        <p class="text-5xl font-bold text-white mb-3" id="metricAvgRealisasi">0.0</p>
                        <p class="text-sm text-gray-400">Target Harian: <span id="metricTargetHarian">8</span> Aktivitas</p>
                        <div id="metricSelisihWrapper">
                            <p class="text-base font-medium text-red-400 mt-1" id="metricSelisihHarian">Perlu +8.0 Aktivitas/Hari</p>
                        </div>
                    </div>

                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Buat Rencana Aktivitas</h2>
                        <div id="planSuccessMessage" class="hidden bg-emerald-900 text-emerald-300 p-3 rounded-lg mb-4 text-sm border border-emerald-700"></div>
                        <form id="planForm">
    <div class="mb-4">
        <label for="planDate" class="block text-sm font-medium text-gray-400">Tgl Rencana</label>
        <input type="date" id="planDate" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" style="color-scheme: dark;" required>
    </div>

    <div class="mb-4">
        <label for="planClientName" class="block text-sm font-medium text-gray-400">Nama Klien</label>
        <input type="text" id="planClientName" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" list="clientList" required>
        <datalist id="clientList"></datalist>
    </div>

    <div class="mb-4">
        <label for="planActivityType" class="block text-sm font-medium text-gray-400">Tipe Aktivitas</label>
        <select id="planActivityType" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
            <option value="Online Meeting">Online Meeting</option>
            <option value="Kunjungan">Kunjungan</option>
            <option value="Telepon">Telepon</option>
            <option value="Follow Up Email">Follow Up Email</option>
        </select>
    </div>

    <div class="mb-4">
        <label for="planCapability" class="block text-sm font-medium text-gray-400">Capability</label>
        <select id="planCapability" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
            <option value="SIPLah">SIPLah</option>
            <option value="IT Outsourcing">IT Outsourcing</option>
        </select>
    </div>

    <div class="mb-4">
        <label for="planObjective" class="block text-sm font-medium text-gray-400">Tujuan Meeting</label>
        <select id="planObjective" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
            <option value="Perkenalan dan mencari Leads">Perkenalan dan mencari Leads</option>
            <option value="Follow up inisiasi atau Leads">Follow up inisiasi atau Leads</option>
        </select>
    </div>

    <div id="planFollowUpContainer" class="mb-4 hidden">
        <label for="planFollowUpLead" class="block text-sm font-medium text-gray-400">Pilih Inisiasi / Lead</label>
        <select id="planFollowUpLead" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
            <option value="">-- Memuat data --</option>
        </select>
    </div>

    <div class="mb-4">
        <label for="planNotes" class="block text-sm font-medium text-gray-400">Objektif / Catatan</label>
        <textarea id="planNotes" rows="3" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></textarea>
    </div>

    <button type="submit" id="savePlanBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana
    </button>
</form>
                    </div>

                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Daftar Rencana Aktivitas (Belum Realisasi)</h2>
                        <div id="planListContainer" class="space-y-3 max-h-[500px] overflow-y-auto">
                            <p id="noPlansText" class="text-gray-500">Belum ada rencana yang dibuat.</p>
                        </div>
</div> </div> <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mt-8 w-full">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-white">Reminder: Lead ID Tanpa Follow-Up (> 30 Hari)</h2>
                        <span class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded border border-gray-600">Action Needed</span>
                    </div>
                    
                    <div class="overflow-x-auto w-full">
                        <table class="w-full divide-y divide-gray-700 table-fixed">
                            <thead>
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[20%]">Nama Klien</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[25%]">Nama Project</th> <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[15%]">Estimasi</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[15%]">Status</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider w-[15%]">Vakum (Hari)</th> <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider w-[10%]">Aksi</th>
                </tr>
            </thead>
                            <tbody id="staleLeadsTableBody" class="divide-y divide-gray-700 bg-gray-800">
                                <tr><td colspan="5" class="text-center text-gray-500 py-4">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="staleLeadsPaginationContainer" class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700"></div>
                </div>
                </div>

            <div id="tab-panel-2" class="tab-panel hidden">
                
                <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
                    <label for="planSelector" class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-lucide="check-square" class="inline-block h-5 w-5 mr-1 text-green-400"></i>
                        <strong>Pilih Rencana yang Direalisasi</strong> <span class="text-red-400">*</span>
                </label>
                <p class="text-xs text-gray-400 mb-2">Pilih rencana untuk mengisi form di bawah ini secara otomatis.</p>
                    <select id="planSelector" class="w-full mt-1 px-3 py-2 border border-gray-500 bg-gray-600 text-white rounded-lg" required>
                        <option value="">-- Tidak, ini aktivitas baru --</option>
                        </select>
                </div>

                <div id="inputFormContainer" class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 border border-gray-700">
    <h2 class="text-xl font-semibold mb-4 text-white">Tambah Aktivitas Baru</h2>
    <div id="successMessage" class="hidden bg-emerald-900 text-emerald-300 p-3 rounded-lg mb-4 text-sm border border-emerald-700"></div>
    <div id="errorMessage" class="hidden bg-red-900 text-red-300 p-3 rounded-lg mb-4 text-sm border border-red-700"></div>
    
    <form id="activityForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="clientName" class="block text-sm font-medium text-gray-400">Nama Klien</label>
                <input type="text" id="clientName" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
            </div>
            <div>
                <label for="meetingDate" class="block text-sm font-medium text-gray-400">Tgl Meeting</label>
                <input type="date" id="meetingDate" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" style="color-scheme: dark;" required>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="lokasiProvinsi" class="block text-sm font-medium text-gray-400">Provinsi</label>
                <select id="lokasiProvinsi" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                    <option value="">-- Pilih Provinsi --</option>
                </select>
            </div>
            <div>
                <label for="lokasiKota" class="block text-sm font-medium text-gray-400">Kota/Kabupaten</label>
                <select id="lokasiKota" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                    <option value="">-- Pilih Provinsi Dulu --</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="clientSegment" class="block text-sm font-medium text-gray-400">Segmen Klien</label>
                <select id="clientSegment" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                    <option value="Enterprise">Enterprise</option>
                    <option value="Government">Government</option>
                    <option value="Education">Education</option>
                </select>
            </div>
            <div>
                <label for="salesPerson" class="block text-sm font-medium text-gray-400">Nama Sales</label>
                <select id="salesPerson" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-600 text-white rounded-lg" required disabled></select>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-400">Tipe Klien</label>
            <div class="flex gap-4">
                <label class="flex items-center"><input type="radio" name="clientType" value="new" class="h-4 w-4 text-blue-500" checked><span class="ml-2">Klien Baru</span></label>
                <label class="flex items-center"><input type="radio" name="clientType" value="existing" class="h-4 w-4 text-blue-500"><span class="ml-2">Klien Existing</span></label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="nomorRFQ" class="block text-sm font-medium text-gray-400">Lead ID (Opsional)</label>
                <input type="text" id="nomorRFQ" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
            </div>
            <div>
                <label for="namaProject" class="block text-sm font-medium text-gray-400">Nama Project</label>
                <input type="text" id="namaProject" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
            </div>
        </div>

        <div class="mb-4">
            <label for="meetingNotes" class="block text-sm font-medium text-gray-400">Hasil Meeting</label>
            <textarea id="meetingNotes" rows="3" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="meetingType" class="block text-sm font-medium text-gray-400">Type Aktivitas</label>
                <select id="meetingType" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                    <option>Awareness</option>
                    <option>Interest</option>
                    <option>Desire</option>
                    <option>Process Closing</option>
                    <option>Action</option>
                    <option>Delivery</option>
                    <option>Payment</option>
                    <option>Lost</option>
                </select>
            </div>
            <div>
                <label for="dealValue" class="block text-sm font-medium text-gray-400">Estimasi Amount (Rp)</label>
                <input type="text" id="dealValue" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" oninput="formatRupiah(this)" required>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="capability" class="block text-sm font-medium text-gray-400">Capability</label>
                <select id="capability" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                    <option>SIPLah</option>
                    <option>IT Outsourcing</option>
                </select>
            </div>
            <div>
                <label for="programChampion" class="block text-sm font-medium text-gray-400">Program Champion</label>
                <select id="programChampion" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                    <option value="">-- Pilih Program --</option>
<option value="SIPLah">SIPLah</option>
                    <option value="SPBE">SPBE</option>
                    <option value="Zoom">Zoom</option>
                    <option value="Sekolah Rujukan Google">Sekolah Rujukan Google</option>
                    <option value="Gadget">Gadget</option>
                    <option value="STEM Development">STEM Development</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="unitInCharge" class="block text-sm font-medium text-gray-400">Unit in Charge (Support)</label>
                <select id="unitInCharge" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></select>
            </div>
            <div>
                <label for="supportCategory" class="block text-sm font-medium text-gray-400">Kategori Support</label>
                <select id="supportCategory" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></select>
            </div>
        </div>

        
        <div id="obstacleSection" class="mb-6 hidden">
            <label for="salesObstacle" class="block text-sm font-medium text-gray-400">Hambatan</label>
            <select id="salesObstacle" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                <option>Harga Terlalu Tinggi</option>
                <option>Kalah dari Kompetitor</option>
                <option>Fitur Produk Kurang</option>
                <option>Waktu Tidak Tepat</option>
                <option>Lainnya</option>
            </select>
        </div>

        <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">Simpan</button>
    </form>
</div>
</div>
            <div id="tab-panel-3" class="tab-panel">
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-sm mb-8 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-white">Filter Global</h2>
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        
                        <div id="managerFilterContainer" class="w-full sm:w-auto hidden">
                            <label for="salesFilter" class="block text-sm font-medium text-gray-400 mb-1 sr-only">Filter Sales</label>
                            <select id="salesFilter" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                         </div>
                        
                        <div id="globalPeriodFilters" class="flex items-center bg-gray-700 rounded-lg p-1 text-sm shrink-0">
    <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600" data-period="this-week">Minggu Ini</button>
    <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600" data-period="this-month">Bulan Ini</button>
    <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600 active" data-period="this-year">Tahun Ini</button>
    <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600" data-period="custom">Custom</button>
</div>
                        
                        <div id="customDateContainer" class="hidden sm:flex items-center gap-2 text-sm">
    <input type="date" id="startDate" class="px-2 py-1 border border-gray-600 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" style="color-scheme: dark;">
    <span class="text-gray-400">-</span>
    <input type="date" id="endDate" class="px-2 py-1 border border-gray-600 bg-gray-700 text-white rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" style="color-scheme: dark;">
    
    <button id="refreshFilterBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-md transition-colors flex items-center gap-1 shadow-sm border border-blue-500" title="Terapkan Filter Tanggal">
        <i data-lucide="refresh-cw" class="h-3 w-3"></i>
        <span class="text-xs font-semibold">Terapkan</span>
    </button>
<button onclick="window.auditDateSequence()" class="bg-purple-900/50 hover:bg-purple-800 text-purple-200 px-2 py-1.5 rounded-md transition-colors border border-purple-700 ml-1" title="Cek Kerancuan Tanggal (Timeline Error)">
    <i data-lucide="history" class="h-3 w-3"></i>
</button>
</div>
                    </div>

        <div id="managerTabsContainer" class="mb-6 border-b border-gray-700 overflow-x-auto"> <nav class="flex space-x-4" aria-label="Tabs">
        <button id="manager-tab-btn-1" data-manager-tab="1" 
                class="manager-tab-button tab-button active-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="bar-chart-3" class="inline-block h-5 w-5 mr-2"></i>
            Dashboard Utama & KPI
        </button>
        <button id="manager-tab-btn-2" data-manager-tab="2" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="calendar-search" class="inline-block h-5 w-5 mr-2"></i>
            Analisis Aktivitas & Support
        </button>
        <button id="manager-tab-btn-4" data-manager-tab="4" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium hidden">
            <i data-lucide="layout-grid" class="inline-block h-5 w-5 mr-2"></i>
            Performance (Looker)
        </button>
        <button id="manager-tab-btn-5" data-manager-tab="5" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="shopping-bag" class="inline-block h-5 w-5 mr-2"></i>
            Client Analytic
        </button>
        
        <button id="manager-tab-btn-6" data-manager-tab="6" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="scatter-chart" class="inline-block h-5 w-5 mr-2"></i>
            Project Analytic
        </button>
<button id="manager-tab-btn-strategy" data-manager-tab="strategy" 
        class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
    <i data-lucide="crosshair" class="inline-block h-5 w-5 mr-2"></i>
    How to Achieve
</button>
    </nav>
</div>
<div id="manager-tab-panel-6" class="manager-tab-panel hidden space-y-6">
    
    <div class="bg-gray-800 p-2 rounded-lg border border-gray-700 inline-flex mb-4">
        <button id="subtab-proj-ito" onclick="window.switchProjectTab('IT Outsourcing')" 
                class="px-4 py-2 rounded-md text-sm font-semibold transition-colors bg-blue-600 text-white">
            IT Outsourcing
        </button>
        <button id="subtab-proj-siplah" onclick="window.switchProjectTab('SIPLah')" 
                class="px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-400 hover:text-white hover:bg-gray-700">
            SIPLah
        </button>
    </div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-emerald-500 border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-sm font-semibold text-emerald-400">Potensi Besar (High Value)</h3>
                    <p class="text-xs text-gray-400 mt-1">Jarang disentuh, nilai besar.</p>
                </div>
                <i data-lucide="gem" class="h-5 w-5 text-emerald-400"></i>
            </div>
            <div class="mt-3">
                <div id="recHighValueList" class="space-y-2 text-xs">
                    <p class="text-gray-500 italic">Menganalisa data...</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-red-500 border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-sm font-semibold text-red-400">Macet / Stuck</h3>
                    <p class="text-xs text-gray-400 mt-1">Lama di tahap awal (>30 hari).</p>
                </div>
                <i data-lucide="alert-octagon" class="h-5 w-5 text-red-400"></i>
            </div>
            <div class="mt-3">
                <div id="recStuckList" class="space-y-2 text-xs">
                    <p class="text-gray-500 italic">Menganalisa data...</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500 border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-sm font-semibold text-yellow-400">Warning: Inefisien</h3>
                    <p class="text-xs text-gray-400 mt-1">Terlalu banyak meeting, nilai kecil.</p>
                </div>
                <i data-lucide="gauge" class="h-5 w-5 text-yellow-400"></i>
            </div>
            <div class="mt-3">
                <div id="recInefficientList" class="space-y-2 text-xs">
                    <p class="text-gray-500 italic">Menganalisa data...</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-blue-500 border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-sm font-semibold text-blue-400">Fokus Closing</h3>
                    <p class="text-xs text-gray-400 mt-1">Tahap akhir, butuh dorongan.</p>
                </div>
                <i data-lucide="trophy" class="h-5 w-5 text-blue-400"></i>
            </div>
            <div class="mt-3">
                <div id="recClosingList" class="space-y-2 text-xs">
                    <p class="text-gray-500 italic">Menganalisa data...</p>
                </div>
            </div>
        </div>

    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
    <div class="flex justify-between items-start mb-4">
    <div>
        <h2 class="text-xl font-semibold text-white">
    Project Activity Matrix (<span id="projectAnalyticTitleCap">IT Outsourcing</span>)
</h2>
        <p class="text-xs text-gray-400 mt-1">Sumbu X: Jumlah Aktivitas | Sumbu Y: Estimasi Nilai (Rp)</p>
    </div>
    
    <div class="flex flex-col items-end gap-2">
        <div class="bg-gray-700 p-2 rounded text-xs text-gray-300">
            <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> Won
            <span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-1 ml-2"></span> Open
            <span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1 ml-2"></span> Lost
        </div>
        
        <button id="resetZoomBtn" class="text-xs bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded border border-gray-500 transition">
    <i data-lucide="zoom-out" class="inline w-3 h-3 mr-1"></i> Reset Zoom
</button>
    </div>
</div>
    <div class="h-[800px] w-full">
    <canvas id="projectScatterChart"></canvas>
</div>
</div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
        <h2 class="text-xl font-semibold text-white mb-4">
    Detail Analisa Project (<span id="tableTitleCap">IT Outsourcing</span>)
</h2>
        <div class="max-h-[500px] overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="sticky top-0 bg-gray-800 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Nama Sales</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Klien / Project</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status Terakhir</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Mulai - Akhir</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase text-center">Durasi (Hari)</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase text-center">Total Aktivitas</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Amount</th>
                    </tr>
                </thead>
                <tbody id="projectDurationTableBody" class="divide-y divide-gray-700">
                    </tbody>
            </table>
        </div>
    </div>
</div>
                <div id="manager-tab-content">
                    
                    <div id="manager-tab-panel-1" class="manager-tab-panel space-y-8">

    <div id="summaryContainer" class="mt-8 hidden">
        <div id="summaryText" class="bg-gray-800 p-6 rounded-xl shadow-lg text-gray-300 border border-gray-700">
        </div>
    </div>

    <div id="managerPlanningMetricsWrapper" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-white">Total Aktivitas Terjadwal</h2>
                    <i data-lucide="calendar-check-2" class="h-6 w-6 text-green-400"></i>
                </div>
                <p class="text-5xl font-bold text-white mb-3" id="mgr-metricRencanaTotal">0</p>
                <div class="flex items-center text-sm text-green-400">
                    <i data-lucide="check-circle-2" class="h-4 w-4 mr-2"></i>
                    <span id="mgr-metricRencanaSelesai" class="font-medium mr-1">0</span> Selesai
                </div>
                <div class="flex items-center text-sm text-yellow-400 mt-1">
                    <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                    <span id="mgr-metricRencanaMenunggu" class="font-medium mr-1">0</span> Menunggu
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-lg font-semibold text-white">Rata-rata Realisasi Harian</h2>
                    <i data-lucide="map-pin" class="h-6 w-6 text-blue-400"></i>
                </div>
                <p class="text-5xl font-bold text-white mb-3" id="mgr-metricAvgRealisasi">0.0</p>
                <p class="text-sm text-gray-400">Target Harian: <span id="mgr-metricTargetHarian">8</span> Aktivitas</p>
                <div id="metricSelisihWrapper">
                    <p class="text-base font-medium text-red-400 mt-1" id="mgr-metricSelisihHarian">Perlu +8.0 Aktivitas/Hari</p>
                </div>
            </div>
        </div>
    </div>

    <div id="metricsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
            <p class="text-sm font-medium text-gray-400 flex items-center">Total Aktivitas Realisasi <i data-lucide="calendar" class="w-4 h-4 ml-1 text-blue-400"></i></p>
            <p id="metricTotalMeetings" class="text-3xl font-bold text-white mt-1">0</p>
        </div>
        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
            <p class="text-sm font-medium text-gray-400 flex items-center">Total Klien Baru <i data-lucide="user-plus" class="w-4 h-4 ml-1 text-red-400"></i></p>
            <p id="metricNewClients" class="text-3xl font-bold text-white mt-1">0</p>
        </div>
        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
            <p class="text-sm font-medium text-gray-400 flex items-center">Total Klien Existing <i data-lucide="users" class="w-4 h-4 ml-1 text-yellow-400"></i></p>
            <p id="metricExistingClients" class="text-3xl font-bold text-white mt-1">0</p>
        </div>
        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
            <p class="text-sm font-medium text-gray-400 flex items-center">Total Lead ID Unik <i data-lucide="folder-open" class="w-4 h-4 ml-1 text-purple-400"></i></p>
            <p id="metricTotalRFQs" class="text-3xl font-bold text-white mt-1">0</p>
        </div>
    </div>
<div id="worryListCard" class="bg-red-900/10 border border-red-500/30 p-6 rounded-xl shadow-lg mt-6 mb-6 hidden">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-xl font-bold text-red-100 flex items-center">
                <i data-lucide="siren" class="w-6 h-6 mr-2 text-red-500 animate-pulse"></i>
                The Worry List (High Value, High Risk)
            </h2>
            <p class="text-xs text-gray-400 mt-1">Deal > 500Jt yang vakum aktivitas > 30 hari.</p>
        </div>
        <span id="worryCountBadge" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded font-bold">0 Deal</span>
    </div>
    <div id="worryListContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
</div>
    <div class="flex flex-col xl:flex-row gap-6">

        <div class="w-full xl:w-[70%] space-y-6">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">Distribusi Pipeline (AIDA)</h2>
                        <div id="aidaProgressBar" class="progress-bar-container mb-2"></div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span class="text-blue-400">Awareness</span>
                            <span class="text-green-400">Interest</span>
                            <span class="text-yellow-400">Desire</span>
                            <span class="text-red-400">Action</span>
                        </div>
                        <div id="aidaLegend" class="mt-4 grid grid-cols-2 gap-2 text-xs"></div>
<div id="funnelAnalysis" class="mt-4 pt-4 border-t border-gray-700">
    <h3 class="text-xs font-bold text-gray-300 mb-2">Conversion Health:</h3>
    <div class="flex justify-between items-center text-[10px] bg-gray-900/50 p-2 rounded">
        <div class="text-center">
            <span class="block text-gray-500">Aware -> Interest</span>
            <span class="block font-bold text-emerald-400" id="convRate1">--%</span>
        </div>
        <div class="text-gray-600">→</div>
        <div class="text-center">
            <span class="block text-gray-500">Interest -> Proposal</span>
            <span class="block font-bold text-yellow-400" id="convRate2">--%</span>
        </div>
        <div class="text-gray-600">→</div>
        <div class="text-center">
            <span class="block text-gray-500">Proposal -> Closing</span>
            <span class="block font-bold text-blue-400" id="convRate3">--%</span>
        </div>
    </div>
</div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">Distribusi Segmen Klien</h2>
                        <div id="clientSegmentProgressBar" class="progress-bar-container mb-2"></div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span class="text-purple-400">Enterprise</span>
                            <span class="text-orange-400">Government</span>
                            <span class="text-cyan-400">Education</span>
                        </div>
                        <div id="clientSegmentLegend" class="mt-4 grid grid-cols-3 gap-2 text-xs"></div>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Program Champion</h2>
                        <span class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">by Amount</span>
                    </div>
                    <div class="relative flex-grow min-h-[300px]">
                        <canvas id="programChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 flex flex-col justify-center">
                    <h2 class="text-sm font-semibold text-gray-400 mb-1">Rata-rata Durasi Sales Cycle</h2>
                    <div class="flex items-end mt-1">
                        <p id="avgSalesCycleDuration" class="text-3xl font-bold text-purple-400">0</p>
                        <p class="text-lg text-gray-400 ml-2">hari</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">(Awareness ke Action)</p>
                </div>
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <p class="text-sm font-medium text-gray-400">Avg. Pergerakan Tahap</p>
                    <p id="metricAvgSteps" class="text-3xl font-bold text-white mt-1">0</p>
                    <p class="text-xs text-gray-500 mt-1">Meeting / Lead ID Won</p>
                </div>
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <p class="text-sm font-medium text-gray-400">Rasio Lead ID Existing</p>
                    <p id="metricExistingRatio" class="text-3xl font-bold text-white mt-1">0%</p>
                    <p class="text-xs text-gray-500 mt-1">Indikator Engagement</p>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                <div class="mb-6 border-b border-gray-700">
                    <nav id="leadsStatusTabsContainer" class="flex space-x-4" aria-label="Tabs">
                        <button data-status="Awareness" class="leads-status-tab tab-button active-tab whitespace-nowrap py-3 px-2 text-sm font-medium">Awareness</button>
                        <button data-status="Interest" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">Interest</button>
                        <button data-status="Desire" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">Desire/Process</button>
                        <button data-status="Action" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">Action/Delivery/Payment</button>
                    </nav>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 id="activeLeadsTableTitle" class="text-sm font-semibold text-gray-400 whitespace-nowrap">Daftar Leads: Awareness</h2>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div class="relative w-full md:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="search" class="h-4 w-4 text-gray-500"></i>
                            </div>
                            <input type="text" id="searchActiveLeadsInput" class="bg-gray-700 border border-gray-600 text-white text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2" placeholder="Cari Client atau Project...">
                        </div>
                        <button id="downloadActiveLeadsBtn" class="bg-green-700 hover:bg-green-600 text-white text-xs px-3 py-2 rounded-lg flex items-center gap-2 transition-colors border border-green-600">
                            <i data-lucide="download" class="h-4 w-4"></i>
                            <span class="hidden sm:inline">CSV</span>
                        </button>
                    </div>
                </div>

                <div class="min-w-full">
                    <table class="min-w-full divide-y divide-gray-700">
    <thead>
        <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Sales</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Segmen</th>
            
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Lead ID</th>
            
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Klien</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Project</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status Terakhir</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Estimasi Amount</th>
        </tr>
    </thead>
    <tbody id="activeLeadsTableBody" class="divide-y divide-gray-700"></tbody>
</table>
                </div>
                <div id="activeLeadsPaginationContainer" class="flex justify-between items-center mt-4"></div>
            </div>

        </div> <div class="w-full xl:w-[30%] space-y-6">
            
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-white">Type Aktivitas</h2>
                <div class="h-64 relative">
                    <canvas id="topMeetingTypesChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-white">Fokus Capability</h2>
                <div class="h-64 relative">
                    <canvas id="capabilityChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-white">Win Rate (per Lead ID)</h2>
                <div class="h-64 relative">
                    <canvas id="winRateChart"></canvas>
                </div>
            </div>
<div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mt-6">
    <h2 class="text-lg font-semibold mb-2 text-white flex items-center">
        <i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-green-400"></i> Konsistensi Sales
    </h2>
    <p class="text-[10px] text-gray-400 mb-4">Konsistensi closing project setiap tahunnya.</p>
    <div id="efficiencyLeaderboard" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
    </div>
</div>
        </div> </div> </div>
                       
                    </div>
                    
                    <div id="manager-tab-panel-2" class="manager-tab-panel hidden space-y-6">
                        
                        <div id="dailyActivityTrendContainer" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hidden">
                            <div class="flex justify-between items-center mb-1">
                                <h2 class="text-xl font-semibold text-white">Tren Fokus Aktivitas Harian</h2>
                                 <div id="trendIndicator" class="flex items-center text-sm font-semibold"></div>
                            </div>
                             <p class="text-xs text-gray-500 mb-4">Perbandingan dengan periode sebelumnya</p>
                            <div class="h-96">
                                <canvas id="dailyActivityChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-white">Kalender Aktivitas</h2>
                                <div class="flex items-center gap-2">
                                    <button id="prevMonthBtn" class="p-1 rounded-md hover:bg-gray-700 text-gray-400"><i data-lucide="chevron-left" class="h-5 w-5"></i></button>
                                    <span id="currentMonthYear" class="font-semibold w-24 text-center text-white text-sm"></span>
                                    <button id="nextMonthBtn" class="p-1 rounded-md hover:bg-gray-700 text-gray-400"><i data-lucide="chevron-right" class="h-5 w-5"></i></button>
                                </div>
                            </div>
                            <div id="calendarContainer">
                                <div class="calendar-grid">
                                    <div class="calendar-day-header">Sen</div>
                                    <div class="calendar-day-header">Sel</div>
                                    <div class="calendar-day-header">Rab</div>
                                    <div class="calendar-day-header">Kam</div>
                                    <div class="calendar-day-header">Jum</div>
                                    <div class="calendar-day-header">Sab</div>
                                    <div class="calendar-day-header">Min</div>
                                    </div>
                            </div>
                        </div>
                        
                       <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                        <h2 class="text-xl font-semibold text-white mb-4">Analisa Support Needed (Non-Closed Deals)</h2>
                        <div id="supportTableContainer" class="min-w-full">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="whitespace-nowrap">Client</th>
                                        <th class="whitespace-nowrap">Project</th>
                                        <th class="whitespace-nowrap">Est. Amount</th>
                                        <th class="whitespace-nowrap">Support Unit</th>
                                        <th class="whitespace-nowrap">Kategori Support</th>
                                        <th class="whitespace-nowrap">Status Support</th>
                                    </tr>
                                </thead>
                                <tbody id="supportTableBody">
                                    <tr><td colspan="6" class="text-center text-gray-500 py-4">Memuat data support...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="supportPaginationContainer" class="flex justify-between items-center mt-4">
                        </div>
                    </div>

                </div>

</div> <div id="manager-tab-panel-4" class="manager-tab-panel hidden space-y-6">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">
            Dashboard Performa Looker Studio
        </h2>

        <iframe 
            width="100%" 
            height="700" 
            src="https://lookerstudio.google.com/embed/reporting/99dc80ee-a592-4ea1-bf11-629cd901fc31/page/7OVlF" 
            frameborder="0" 
            style="border:0" 
            allowfullscreen 
            sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
        </iframe>
    </div>
</div>

<div id="manager-tab-panel-5" class="manager-tab-panel hidden space-y-8">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-t-4 border-purple-500 border-gray-700 flex flex-col h-[500px]">
            <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <i data-lucide="crown" class="w-5 h-5 mr-2 text-yellow-400 fill-yellow-400"></i> 
                        The Champions
                    </h3>
                    <p class="text-xs text-purple-300">Key Accounts (>1M berturut 2 Tahun)</p>
                </div>
                <span class="text-xs font-bold bg-purple-900 text-purple-200 px-2 py-1 rounded" id="badgeKeyAccountCount">0</span>
            </div>
            <div id="keyAccountListContainer" class="overflow-y-auto flex-1 custom-scrollbar space-y-3 pr-2">
                </div>
        </div>

        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-t-4 border-blue-500 border-gray-700 flex flex-col h-[500px]">
            <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <i data-lucide="rocket" class="w-5 h-5 mr-2 text-blue-400"></i> 
                        Incubator Focus
                    </h3>
                    <p class="text-xs text-blue-300">Rev >500Jt / Freq >3x / High Pipeline</p>
                </div>
                <span class="text-xs font-bold bg-blue-900 text-blue-200 px-2 py-1 rounded" id="badgeIncubatorCount">0</span>
            </div>
            <div id="incubatorList" class="overflow-y-auto flex-1 custom-scrollbar space-y-3 pr-2">
                </div>
        </div>

        <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-t-4 border-emerald-500 border-gray-700 flex flex-col h-[500px]">
            <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center">
                        <i data-lucide="target" class="w-5 h-5 mr-2 text-emerald-400"></i> 
                        Milestone 500 Juta
                    </h3>
                    <p class="text-xs text-emerald-300">Progress Revenue Tahun Ini</p>
                </div>
                <span class="text-xs font-bold bg-emerald-900 text-emerald-200 px-2 py-1 rounded" id="badgeMilestoneCount">0</span>
            </div>
            <div id="targetTrackingChart" class="overflow-y-auto flex-1 custom-scrollbar space-y-4 pr-2">
                </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-sm font-medium text-gray-400">Total Key Accounts</h2>
                    <p class="text-xs text-gray-500 mt-1">Revenue > 1 Miliar</p>
                </div>
                <i data-lucide="crown" class="h-8 w-8 text-yellow-400"></i>
            </div>
            <div class="mt-4">
                <span class="text-4xl font-bold text-white" id="metricKeyAccountCount">0</span>
                <span class="text-sm text-gray-400 ml-2">Klien</span>
            </div>
             <p class="text-sm text-yellow-300 mt-2 font-medium" id="metricKeyAccountRev">Rp 0</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-blue-500 border-gray-700">
             <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-sm font-medium text-gray-400">Active Accounts</h2>
                    <p class="text-xs text-gray-500 mt-1">Pernah Order (Non-Key)</p>
                </div>
                <i data-lucide="briefcase" class="h-8 w-8 text-blue-400"></i>
            </div>
             <div class="mt-4">
                <span class="text-4xl font-bold text-white" id="metricActiveAccountCount">0</span>
                <span class="text-sm text-gray-400 ml-2">Klien</span>
            </div>
             <p class="text-sm text-blue-300 mt-2 font-medium" id="metricActiveAccountRev">Rp 0</p>
        </div>

        <div id="potentialClientsCard" class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-gray-500 border-gray-700">
     <div class="flex justify-between items-start">
        <div>
            <h2 class="text-sm font-medium text-gray-400">Potential Clients</h2>
            <p class="text-xs text-gray-500 mt-1">Belum pernah closing</p>
        </div>
        <i data-lucide="users" class="h-8 w-8 text-gray-400"></i>
    </div>
     <div class="mt-4">
        <span class="text-4xl font-bold text-white" id="metricPotentialCount">0</span>
        <span class="text-sm text-gray-400 ml-2">Klien</span>
    </div>
     <p class="text-xs text-gray-500 mt-2">Masih di tahap Awareness/Interest</p>
</div>
    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
        <h2 class="text-xl font-semibold text-white mb-2">Portfolio Matrix & Optimalisasi</h2>
        <p class="text-xs text-gray-400 mb-4">Analisa Klien berdasarkan Tipe, Cross-Selling (Program Champion), dan Revenue Tahunan.</p>
        
        <table class="min-w-full divide-y divide-gray-700">
            <thead>
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Nama Klien</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Tipe Account</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status Cross-Sell</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Total Revenue (All Time)</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase">Riwayat Project</th> 
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase">Action</th>
                </tr>
            </thead>
            <tbody id="buyerPortfolioBody" class="divide-y divide-gray-700"></tbody>
        </table>
        <div id="buyerPortfolioPagination" class="flex justify-end mt-4 gap-2"></div>
    </div>


    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-orange-500/50 overflow-x-auto mt-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
        <div>
            <div class="flex items-center">
                <i data-lucide="zap" class="h-6 w-6 text-orange-400 mr-2"></i>
                <h2 class="text-xl font-semibold text-white">Target Reaktivasi & Scale Up (Sleeper Assets)</h2>
            </div>
            <p class="text-xs text-gray-400 mt-1">Daftar akun Pernah Aktif namun TIDAK ADA TRANSAKSI > 6 Bulan.</p>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-3 w-3 text-gray-500"></i>
                </div>
                <input type="text" id="reactivationSearchInput" 
                       class="bg-gray-700 border border-gray-600 text-white text-xs rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-48 pl-8 p-1.5" 
                       placeholder="Cari Klien / Sales...">
            </div>
            <span class="bg-orange-900/50 text-orange-300 border border-orange-700 px-3 py-1 rounded text-xs font-bold whitespace-nowrap" id="reactivationCountBadge">0 Akun</span>
        </div>
    </div>
        <table class="min-w-full divide-y divide-gray-700">
            <thead>
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Nama Klien</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Sales PIC</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Total Revenue (History)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Terakhir Order</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Lama Tidur</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase">Aksi</th>
                </tr>
            </thead>
            <tbody id="reactivationTableBody" class="divide-y divide-gray-700"></tbody>
        </table>
    </div>
</div>
<div id="manager-tab-panel-strategy" class="manager-tab-panel hidden space-y-6">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <label class="text-sm font-medium text-gray-400 mb-2 block">Target Tahunan (Rp)</label>
            <div class="relative">
                <span class="absolute left-3 top-2 text-gray-400 font-bold">Rp</span>
                <input type="text" id="strategyTargetInput" value="0" 
       readonly 
       class="w-full bg-gray-800 border border-transparent rounded-lg py-2 pl-10 pr-4 text-blue-400 font-mono text-2xl font-bold outline-none cursor-default">
<p class="text-[10px] text-gray-500 mt-2">Target resmi berdasarkan KPI tahun berjalan.</p>
            </div>
            <p class="text-xs text-gray-500 mt-2">Ubah angka di atas sesuai target sales.</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 mb-1">Pencapaian Saat Ini (YTD)</h3>
            <p id="strategyCurrentRev" class="text-3xl font-bold text-emerald-400 mt-1">Rp 0</p>
            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-4">
                <div id="strategyProgressBar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <p id="strategyProgressText" class="text-xs text-right text-emerald-300 mt-1">0%</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 mb-1">GAP (Sisa Target)</h3>
            <p id="strategyGap" class="text-3xl font-bold text-red-400 mt-1">Rp 0</p>
            <p class="text-xs text-gray-400 mt-2 flex items-center">
                <i data-lucide="alert-triangle" class="w-3 h-3 mr-1 text-red-400"></i>
                Harus dikejar dalam sisa tahun ini.
            </p>
        </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-blue-500/30">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
            <i data-lucide="sliders" class="w-5 h-5 mr-2 text-blue-400"></i> Pilih Strategi Pencapaian
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="border border-gray-600 rounded-lg p-4 hover:bg-gray-700/50 transition cursor-pointer relative overflow-hidden group">
                <input type="radio" name="strategyType" id="stratBig" value="big" class="absolute top-4 right-4 w-5 h-5 accent-blue-500" checked onchange="window.calculateStrategy()">
                <label for="stratBig" class="cursor-pointer block">
                    <div class="flex items-center mb-2">
                        <div class="p-2 bg-purple-900/50 rounded-lg mr-3 text-purple-300"><i data-lucide="crown" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="font-bold text-white text-sm">Big Project</h3>
                            <p class="text-[10px] text-gray-400">@ 1 Milyar / Project</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-900 p-3 rounded text-center">
                        <p class="text-[10px] text-gray-400">Target Closing:</p>
                        <p id="reqBigCount" class="text-xl font-bold text-purple-400">0 Deal</p>
                    </div>
                </label>
            </div>

            <div class="border border-gray-600 rounded-lg p-4 hover:bg-gray-700/50 transition cursor-pointer relative overflow-hidden group">
                <input type="radio" name="strategyType" id="stratMix" value="mix" class="absolute top-4 right-4 w-5 h-5 accent-blue-500" onchange="window.calculateStrategy()">
                <label for="stratMix" class="cursor-pointer block">
                    <div class="flex items-center mb-2">
                        <div class="p-2 bg-emerald-900/50 rounded-lg mr-3 text-emerald-300"><i data-lucide="shuffle" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="font-bold text-white text-sm">Mix Strategy</h3>
                            <p class="text-[10px] text-gray-400">50% Big + 50% Volume</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-900 p-3 rounded text-center">
                        <p class="text-[10px] text-gray-400">Target Closing:</p>
                        <p id="reqMixCount" class="text-sm font-bold text-emerald-400">0 Big + 0 Vol</p>
                    </div>
                </label>
            </div>

            <div class="border border-gray-600 rounded-lg p-4 hover:bg-gray-700/50 transition cursor-pointer relative overflow-hidden group">
                <input type="radio" name="strategyType" id="stratSmall" value="small" class="absolute top-4 right-4 w-5 h-5 accent-blue-500" onchange="window.calculateStrategy()">
                <label for="stratSmall" class="cursor-pointer block">
                    <div class="flex items-center mb-2">
                        <div class="p-2 bg-blue-900/50 rounded-lg mr-3 text-blue-300"><i data-lucide="layers" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="font-bold text-white text-sm">Volume Project</h3>
                            <p class="text-[10px] text-gray-400">@ 100 Juta / Project</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-900 p-3 rounded text-center">
                        <p class="text-[10px] text-gray-400">Target Closing:</p>
                        <p id="reqSmallCount" class="text-xl font-bold text-blue-400">0 Deal</p>
                    </div>
                </label>
            </div>

        </div>
    </div>
<div id="strategyRecommendationCard" class="mb-6"></div>
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-2">Insight: Target Eksekusi</h2>
        <p id="strategyCoverageText" class="text-sm text-gray-400 mb-4 transition-colors duration-300">
            Menghitung kecukupan potensi...
        </p>
        <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar"> 
            <table class="w-full text-left border-collapse relative">
                <thead class="sticky top-0 bg-gray-800 z-10 shadow-sm">
                    <tr class="border-b border-gray-600 text-xs text-gray-400 uppercase">
                        <th class="py-3 px-4 w-[50%] text-left">Nama Klien / Project</th>
                        <th class="py-3 px-2 w-[15%] text-left">Status / Kategori</th>
                        <th class="py-3 px-2 w-[25%] text-right">Potensi (Est)</th>
                        <th class="py-3 px-2 w-[10%] text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="strategyInsightBody" class="text-sm divide-y divide-gray-700"></tbody>
            </table>
        </div>
    </div>
</div>
    </div>
    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full border border-gray-700">
        <h3 id="modalTitle" class="text-lg font-semibold text-white mb-3">Notifikasi</h3>
        <p id="modalMessage" class="text-gray-300 mb-4"></p>
        <div class="flex justify-end space-x-2">
    <button id="modalCopyButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 flex items-center">
        <i data-lucide="copy" class="w-4 h-4 mr-2"></i> Salin Error
    </button>

    <button id="modalCancelButton" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Batal</button>
    <button id="modalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Tutup</button>
</div>
    </div>
</div>

<div id="calendarModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full border border-gray-700 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="calendarModalTitle" class="text-xl font-bold text-white">Detail Aktivitas Tanggal</h3>
            <button id="calendarModalCloseButton" class="text-gray-400 hover:text-white p-1 rounded-full">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        <div id="calendarModalContent" class="space-y-4">
            </div>
    </div>
</div>
<div id="projectHistoryModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center p-4 z-[60]">
    <div class="bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl border border-gray-700 flex flex-col max-h-[85vh]">
        
        <div class="p-5 border-b border-gray-700 flex justify-between items-start bg-gray-900/50 rounded-t-xl">
            <div>
                <h3 class="text-lg font-bold text-white" id="histModalTitle">Nama Project</h3>
                <p class="text-xs text-gray-400 mt-1" id="histModalSubtitle">Client Name</p>
            </div>
            <button onclick="document.getElementById('projectHistoryModal').classList.add('hidden'); document.getElementById('projectHistoryModal').classList.remove('flex');" class="text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>

        <div class="p-0 overflow-y-auto flex-1 custom-scrollbar">
            <div id="histModalContent" class="space-y-0">
                </div>
        </div>

        <div class="p-4 border-t border-gray-700 bg-gray-900/30 rounded-b-xl flex justify-between items-center">
            <span class="text-xs text-gray-500" id="histModalFooter">Total Aktivitas: 0</span>
            <button onclick="document.getElementById('projectHistoryModal').classList.add('hidden'); document.getElementById('projectHistoryModal').classList.remove('flex');" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-semibold rounded-lg transition">
                Tutup
            </button>
        </div>
    </div>
</div>
<div id="auditReportModal" class="fixed top-24 right-4 z-[70] hidden w-96 bg-gray-800 rounded-xl shadow-2xl border border-red-500/30 transform transition-all">
    <div class="p-3 border-b border-gray-700 flex justify-between items-center bg-red-900/20 rounded-t-xl">
        <h3 class="text-sm font-bold text-white flex items-center">
            <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400 mr-2"></i> 
            Laporan Inkonsistensi
        </h3>
        <button onclick="document.getElementById('auditReportModal').classList.add('hidden')" class="text-gray-400 hover:text-white transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>
    
    <div class="p-4">
        <p id="auditMsgBody" class="text-xs text-gray-300 mb-2 leading-relaxed">
            Ditemukan data ganda. Silakan salin ID berikut untuk pengecekan:
        </p>
        
        <div class="relative group">
            <textarea id="auditErrorBox" class="w-full h-40 bg-gray-900 text-red-300 text-[10px] p-3 rounded-lg border border-gray-700 font-mono focus:outline-none focus:border-red-500 resize-none custom-scrollbar" readonly></textarea>
            
            <button id="auditCopyBtn" class="absolute top-2 right-2 bg-gray-800 hover:bg-gray-700 text-white text-[10px] px-2 py-1 rounded border border-gray-600 flex items-center transition shadow-sm">
                <i data-lucide="copy" class="w-3 h-3 mr-1"></i> Salin
            </button>
        </div>
    </div>
</div>
<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzoO5n7dvtDNsZMs4L4YpxxabTdXg_SPjiw-n57kmwIdnQi4P7AT_ZC1Pd3BjjB9SK-/exec'; 
// --- KONFIGURASI BARU: DATABASE CSV ---
// PENTING: Ganti URL di bawah dengan Link CSV Anda dari: File > Share > Publish to web
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtGEzG2KG3AtPueHdoduYCWEpv5BN4VcOso8-PBke5dOoApSji2wG9DJyvwIZO7ZDgxvb80xQmLSJm/pub?gid=1366271794&single=true&output=csv'; 

// Fungsi Helper Pembaca CSV (Versi Debugging)
function loadTargetsFromCSV() {
    return new Promise((resolve, reject) => {
        // Cek Library
        if (typeof Papa === 'undefined') {
            console.error("❌ ERROR FATAL: Library PapaParse tidak ditemukan. Pastikan script CDN ada di <head>.");
            alert("Sistem Error: Library CSV hilang.");
            resolve([]);
            return;
        }

        console.log("🔄 Memulai download CSV dari:", SHEET_CSV_URL);

        Papa.parse(SHEET_CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: 'greedy', // Paksa skip baris kosong
            complete: function(results) {
                console.log("✅ Download Selesai. Raw Data:", results.data);

                // Mapping dengan Logika Pembersihan Ekstra
                const cleanData = results.data.map(row => {
                    // Ambil kolom dengan berbagai kemungkinan nama (Case insensitive protection)
                    const nama = row['Nama Target'] || row['nama target'] || row['Nama'] || '';
                    const tipe = row['Tipe'] || row['tipe'] || row['Type'] || '';

                    return {
                        name: nama.trim(),
                        type: tipe.trim()
                    };
                }).filter(item => item.name && item.name !== '');

                console.log("📊 Data Bersih Terproses:", cleanData.length, "baris.");
                
                // Simpan ke Global Variable secara Paksa agar bisa dicek di console
                window.allTargetsGlobal = cleanData; 
                
                resolve(cleanData);
            },
            error: function(err) {
                console.error("❌ Gagal Download CSV:", err);
                resolve([]);
            }
        });
    });
}
document.addEventListener('DOMContentLoaded', () => {
    // --- KONFIGURASI APLIKASI ---
    const USE_MOCK_DATA = false;
    
    // --- STRUKTUR TIM & USER (Diambil dari Dasboard 28 oct 25.txt) ---
    const managers = ['Toni Ardiyanto', 'Andhika Adhigunanto'];
    const teamToni = ['Aldi Apriliano', 'Ardi Ardiansyah', 'Fitri Alifia', 'Wiwin Winarti', 'Sari Widiastuti', 'Syafitri Handayani']; 
    const teamAndhika = ['Mayumi', 'Tomi Dwi Jans', 'Siti Maryam'];
    const allSales = [...teamToni, ...teamAndhika];
    
    const managerTeamMap = {
        'Toni Ardiyanto': teamToni,
        'Andhika Adhigunanto': teamAndhika
    };

    const userCredentials = { 
        'head_sales': 'Xooplyer25',
        'Toni Ardiyanto': 'Toni123!',
        'Andhika Adhigunanto': 'Andhika123!',
        'Aldi Apriliano': 'aldi123!',
        'Ardi Ardiansyah': 'ardi123!',
        'Fitri Alifia': 'fitri123!', 
        'Wiwin Winarti': 'wiwin123!',
        'Sari Widiastuti': 'sari123!',
        'Syafitri Handayani': 'syafitri123!',
        'Mayumi': 'mayumi123!',
        'Tomi Dwi Jans': 'tomi123!',
        'Siti Maryam': 'siti123!'
    };
// Daftar Target Tahunan Statis per Sales
const salesTargets = {
    'Aldi Apriliano': 15032000000,
    'Ardi Ardiansyah': 15032000000,
    'Fitri Alifia': 33200000000,
    'Wiwin Winarti': 18444000000,
    'Sari Widiastuti': 20024000000,
    'Syafitri Handayani': 22133000000,
    'Mayumi': 25533000000,
    'Tomi Dwi Jans': 25533000000,
    'Siti Maryam': 34041000000,
    'Toni Ardiyanto': 123883000000, // Target Manager (Total Tim)
    'Andhika Adhigunanto': 85092000000,
    'Head Sales': 208978000000      // Target Total Perusahaan
};
    // --- AKHIR STRUKTUR TIM ---

    // --- STATE GLOBAL ---
    // --- KONFIGURASI BARU UNTUK RENCANA ---
    let allPlans = []; // Ini HANYA akan menyimpan rencana 'planned'
let allPlansFull = []; // Ini akan menyimpan SEMUA rencana (termasuk 'realized')

    let allDeals = []; 
let allTargetsGlobal = [];
    let filteredDeals = []; 
    let currentRole = null;
    let currentUser = null;
    let dailyActivityChartInstance = null;
    let currentCalendarDate = new Date(); 
    let charts = {}; 
    let lastDealId = 1000; // Untuk auto-ID jika diperlukan di mock

    // --- State Baru untuk Paginasi Support ---
    let supportCurrentPage = 1;
    const SUPPORT_ROWS_PER_PAGE = 5;
    let currentSupportDeals = []; // Menyimpan daftar yang sudah difilter
    
    // (BARU) State untuk tab Leads Aktif & Paginasi
    let currentActiveLeadStatusTab = 'Awareness'; // Tab default
    let activeLeadsCurrentPage = 1;
    const ACTIVE_LEADS_PER_PAGE = 10;
let activeLeadsSearchTerm = '';
// --- TAMBAHAN BARU DI SINI (Variabel Stale Leads) ---
    let staleLeadsCurrentPage = 1;
    const STALE_LEADS_PER_PAGE = 8; // Maksimal 8 baris per halaman
    let currentStaleLeads = []; // Menyimpan data leads macet yang sudah diproses
// [BARU] State untuk Sub-Tab Project Analytic
let currentProjectCapability = 'IT Outsourcing'; // Default
const AIDA_PIPELINE_ORDER = [
    'Awareness', 
    'Interest', 
    'Desire', 
    'Process Closing', 
    'Action', 
    'Delivery', 
    'Payment', 
    'Lost'
];

    // (PERBAIKAN) State untuk modal konfirmasi
    let modalConfirmCallback = null; 

    // --- DATA WILAYAH INDONESIA (BARU) ---
    const allWilayah = {
        "Aceh": ["Kab. Aceh Selatan", "Kab. Aceh Tenggara", "Kab. Aceh Timur", "Kab. Aceh Tengah", "Kab. Aceh Barat", "Kab. Aceh Besar", "Kab. Pidie", "Kab. Aceh Utara", "Kab. Simeulue", "Kab. Aceh Singkil", "Kab. Bireuen", "Kab. Aceh Barat Daya", "Kab. Gayo Lues", "Kab. Aceh Jaya", "Kab. Nagan Raya", "Kab. Aceh Tamiang", "Kab. Bener Meriah", "Kab. Pidie Jaya", "Kota Banda Aceh", "Kota Sabang", "Kota Lhokseumawe", "Kota Langsa", "Kota Subulussalam"],
        "Sumatera Utara": ["Kab. Tapanuli Tengah", "Kab. Tapanuli Utara", "Kab. Tapanuli Selatan", "Kab. Nias", "Kab. Langkat", "Kab. Karo", "Kab. Deli Serdang", "Kab. Simalungun", "Kab. Asahan", "Kab. Labuhanbatu", "Kab. Dairi", "Kab. Toba Samosir", "Kab. Mandailing Natal", "Kab. Nias Selatan", "Kab. Pakpak Bharat", "Kab. Humbang Hasundutan", "Kab. Samosir", "Kab. Serdang Bedagai", "Kab. Batubara", "Kab. Padang Lawas Utara", "Kab. Padang Lawas", "Kab. Labuhanbatu Selatan", "Kab. Labuhanbatu Utara", "Kab. Nias Utara", "Kab. Nias Barat", "Kota Medan", "Kota Pematangsiantar", "Kota Sibolga", "Kota Tanjung Balai", "Kota Binjai", "Kota Tebing Tinggi", "Kota Padangsidimpuan", "Kota Gunungsitoli"],
        "Sumatera Barat": ["Kab. Pesisir Selatan", "Kab. Solok", "Kab. Sijunjung", "Kab. Tanah Datar", "Kab. Padang Pariaman", "Kab. Agam", "Kab. Lima Puluh Kota", "Kab. Pasaman", "Kab. Kepulauan Mentawai", "Kab. Dharmasraya", "Kab. Solok Selatan", "Kab. Pasaman Barat", "Kota Padang", "Kota Solok", "Kota Sawahlunto", "Kota Padang Panjang", "Kota Bukittinggi", "Kota Payakuh", "Kota Pariaman"],
        "Riau": ["Kab. Kampar", "Kab. Indragiri Hulu", "Kab. Bengkalis", "Kab. Indragiri Hilir", "Kab. Pelalawan", "Kab. Rokan Hulu", "Kab. Rokan Hilir", "Kab. Siak", "Kab. Kuantan Singingi", "Kab. Kepulauan Meranti", "Kota Pekanbaru", "Kota Dumai"],
        "Jambi": ["Kab. Kerinci", "Kab. Merangin", "Kab. Sarolangun", "Kab. Batanghari", "Kab. Muaro Jambi", "Kab. Tanjung Jabung Barat", "Kab. Tanjung Jabung Timur", "Kab. Bungo", "Kab. Tebo", "Kota Jambi", "Kota Sungai Penuh"],
        "Sumatera Selatan": ["Kab. Ogan Komering Ulu", "Kab. Ogan Komering Ilir", "Kab. Muara Enim", "Kab. Lahat", "Kab. Musi Rawas", "Kab. Musi Banyuasin", "Kab. Banyuasin", "Kab. Ogan Komering Ulu Timur", "Kab. Ogan Komering Ulu Selatan", "Kab. Ogan Ilir", "Kab. Empat Lawang", "Kab. Penukal Abab Lematang Ilir", "Kab. Musi Rawas Utara", "Kota Palembang", "Kota Pagar Alam", "Kota Lubuk Linggau", "Kota Prabumulih"],
        "Bengkulu": ["Kab. Bengkulu Selatan", "Kab. Rejang Lebong", "Kab. Bengkulu Utara", "Kab. Kaur", "Kab. Seluma", "Kab. Muko Muko", "Kab. Lebong", "Kab. Kepahiang", "Kab. Bengkulu Tengah", "Kota Bengkulu"],
        "Lampung": ["Kab. Lampung Selatan", "Kab. Lampung Tengah", "Kab. Lampung Utara", "Kab. Lampung Barat", "Kab. Tulang Bawang", "Kab. Tanggamus", "Kab. Lampung Timur", "Kab. Way Kanan", "Kab. Pesawaran", "Kab. Pringsewu", "Kab. Mesuji", "Kab. Tulang Bawang Barat", "Kab. Pesisir Barat", "Kota Bandar Lampung", "Kota Metro"],
        "Kep. Bangka Belitung": ["Kab. Bangka", "Kab. Belitung", "Kab. Bangka Selatan", "Kab. Bangka Tengah", "Kab. Bangka Barat", "Kab. Belitung Timur", "Kota Pangkal Pinang"],
        "Kep. Riau": ["Kab. Bintan", "Kab. Karimun", "Kab. Natuna", "Kab. Lingga", "Kab. Kepulauan Anambas", "Kota Batam", "Kota Tanjung Pinang"],
        "DKI Jakarta": ["Kab. Kepulauan Seribu", "Kota Jakarta Pusat", "Kota Jakarta Utara", "Kota Jakarta Barat", "Kota Jakarta Selatan", "Kota Jakarta Timur"],
        "Jawa Barat": ["Kab. Bogor", "Kab. Sukabumi", "Kab. Cianjur", "Kab. Bandung", "Kab. Garut", "Kab. Tasikmalaya", "Kab. Ciamis", "Kab. Kuningan", "Kab. Cirebon", "Kab. Majalengka", "Kab. Sumedang", "Kab. Indramayu", "Kab. Subang", "Kab. Purwakarta", "Kab. Karawang", "Kab. Bekasi", "Kab. Bandung Barat", "Kab. Pangandaran", "Kota Bogor", "Kota Sukabumi", "Kota Bandung", "Kota Cirebon", "Kota Bekasi", "Kota Depok", "Kota Cimahi", "Kota Tasikmalaya", "Kota Banjar"],
        "Jawa Tengah": ["Kab. Cilacap", "Kab. Banyumas", "Kab. Purbalingga", "Kab. Banjarnegara", "Kab. Kebumen", "Kab. Purworejo", "Kab. Wonosobo", "Kab. Magelang", "Kab. Boyolali", "Kab. Klaten", "Kab. Sukoharjo", "Kab. Wonogiri", "Kab. Karanganyar", "Kab. Sragen", "Kab. Grobogan", "Kab. Blora", "Kab. Rembang", "Kab. Pati", "Kab. Kudus", "Kab. Jepara", "Kab. Demak", "Kab. Semarang", "Kab. Temanggung", "Kab. Kendal", "Kab. Batang", "Kab. Pekalongan", "Kab. Pemalang", "Kab. Tegal", "Kab. Brebes", "Kota Magelang", "Kota Surakarta", "Kota Salatiga", "Kota Semarang", "Kota Pekalongan", "Kota Tegal"],
        "DI Yogyakarta": ["Kab. Kulon Progo", "Kab. Bantul", "Kab. Gunung Kidul", "Kab. Sleman", "Kota Yogyakarta"],
        "Jawa Timur": ["Kab. Pacitan", "Kab. Ponorogo", "Kab. Trenggalek", "Kab. Tulungagung", "Kab. Blitar", "Kab. Kediri", "Kab. Malang", "Kab. Lumajang", "Kab. Jember", "Kab. Banyuwangi", "Kab. Bondowoso", "Kab. Situbondo", "Kab. Probolinggo", "Kab. Pasuruan", "Kab. Sidoarjo", "Kab. Mojokerto", "Kab. Jombang", "Kab. Nganjuk", "Kab. Madiun", "Kab. Magetan", "Kab. Ngawi", "Kab. Bojonegoro", "Kab. Tuban", "Kab. Lamongan", "Kab. Gresik", "Kab. Bangkalan", "Kab. Sampang", "Kab. Pamekasan", "Kab. Sumenep", "Kota Kediri", "Kota Blitar", "Kota Malang", "Kota Probolinggo", "Kota Pasuruan", "Kota Mojokerto", "Kota Madiun", "Kota Surabaya", "Kota Batu"],
        "Banten": ["Kab. Pandeglang", "Kab. Lebak", "Kab. Tangerang", "Kab. Serang", "Kota Tangerang", "Kota Cilegon", "Kota Serang", "Kota Tangerang Selatan"],
        "Bali": ["Kab. Jembrana", "Kab. Tabanan", "Kab. Badung", "Kab. Gianyar", "Kab. Klungkung", "Kab. Bangli", "Kab. Karangasem", "Kab. Buleleng", "Kota Denpasar"],
        "Nusa Tenggara Barat": ["Kab. Lombok Barat", "Kab. Lombok Tengah", "Kab. Lombok Timur", "Kab. Sumbawa", "Kab. Dompu", "Kab. Bima", "Kab. Sumbawa Barat", "Kab. Lombok Utara", "Kota Mataram", "Kota Bima"],
        "Nusa Tenggara Timur": ["Kab. Kupang", "Kab. Timor Tengah Selatan", "Kab. Timor Tengah Utara", "Kab. Belu", "Kab. Alor", "Kab. Flores Timur", "Kab. Sikka", "Kab. Ende", "Kab. Ngada", "Kab. Manggarai", "Kab. Sumba Timur", "Kab. Sumba Barat", "Kab. Lembata", "Kab. Rote Ndao", "Kab. Manggarai Barat", "Kab. Nagekeo", "Kab. Sumba Tengah", "Kab. Sumba Barat Daya", "Kab. Manggarai Timur", "Kab. Sabu Raijua", "Kab. Malaka", "Kota Kupang"],
        "Kalimantan Barat": ["Kab. Sambas", "Kab. Mempawah", "Kab. Sanggau", "Kab. Ketapang", "Kab. Sintang", "Kab. Kapuas Hulu", "Kab. Bengkayang", "Kab. Landak", "Kab. Sekadau", "Kab. Melawi", "Kab. Kayong Utara", "Kab. Kubu Raya", "Kota Pontianak", "Kota Singkawang"],
        "Kalimantan Tengah": ["Kab. Kotawaringin Barat", "Kab. Kotawaringin Timur", "Kab. Kapuas", "Kab. Barito Selatan", "Kab. Barito Utara", "Kab. Katingan", "Kab. Seruyan", "Kab. Sukamara", "Kab. Lamandau", "Kab. Gunung Mas", "Kab. Pulang Pisau", "Kab. Murung Raya", "Kab. Barito Timur", "Kota Palangka Raya"],
        "Kalimantan Selatan": ["Kab. Tanah Laut", "Kab. Kotobaru", "Kab. Banjar", "Kab. Barito Kuala", "Kab. Tapin", "Kab. Hulu Sungai Selatan", "Kab. Hulu Sungai Tengah", "Kab. Hulu Sungai Utara", "Kab. Tabalong", "Kab. Tanah Bumbu", "Kab. Balangan", "Kota Banjarmasin", "Kota Banjarbaru"],
        "Kalimantan Timur": ["Kab. Paser", "Kab. Kutai Kartanegara", "Kab. Berau", "Kab. Kutai Barat", "Kab. Kutai Timur", "Kab. Penajam Paser Utara", "Kab. Mahakam Ulu", "Kota Balikpapan", "Kota Samarinda", "Kota Bontang"],
        "Kalimantan Utara": ["Kab. Bulungan", "Kab. Malinau", "Kab. Nunukan", "Kab. Tana Tidung", "Kota Tarakan"],
        "Sulawesi Utara": ["Kab. Bolaang Mongondow", "Kab. Minahasa", "Kab. Kepulauan Sangihe", "Kab. Kepulauan Talaud", "Kab. Minahasa Selatan", "Kab. Minahasa Utara", "Kab. Minahasa Tenggara", "Kab. Bolaang Mongondow Utara", "Kab. Kepulauan Siau Tagulandang Biaro", "Kab. Bolaang Mongondow Timur", "Kab. Bolaang Mongondow Selatan", "Kota Manado", "Kota Bitung", "Kota Tomohon", "Kota Kotamobagu"],
        "Sulawesi Tengah": ["Kab. Banggai", "Kab. Poso", "Kab. Donggala", "Kab. Toli Toli", "Kab. Buol", "Kab. Morowali", "Kab. Banggai Kepulauan", "Kab. Parigi Moutong", "Kab. Tojo Una Una", "Kab. Sigi", "Kab. Banggai Laut", "Kab. Morowali Utara", "Kota Palu"],
        "Sulawesi Selatan": ["Kab. Kepulauan Selayar", "Kab. Bulukumba", "Kab. Bantaeng", "Kab. Jeneponto", "Kab. Takalar", "Kab. Gowa", "Kab. Sinjai", "Kab. Bone", "Kab. Maros", "Kab. Pangkajene Kepulauan", "Kab. Barru", "Kab. Soppeng", "Kab. Wajo", "Kab. Sidenreng Rappang", "Kab. Pinrang", "Kab. Enrekang", "Kab. Luwu", "Kab. Tana Toraja", "Kab. Luwu Utara", "Kab. Luwu Timur", "Kab. Toraja Utara", "Kota Makassar", "Kota Pare Pare", "Kota Palopo"],
        "Sulawesi Tenggara": ["Kab. Kolaka", "Kab. Konawe", "Kab. Muna", "Kab. Buton", "Kab. Konawe Selatan", "Kab. Bombana", "Kab. Wakatobi", "Kab. Kolaka Utara", "Kab. Konawe Utara", "Kab. Buton Utara", "Kab. Kolaka Timur", "Kab. Konawe Kepulauan", "Kab. Muna Barat", "Kab. Buton Tengah", "Kab. Buton Selatan", "Kota Kendari", "Kota Bau Bau"],
        "Gorontalo": ["Kab. Gorontalo", "Kab. Boalemo", "Kab. Bone Bolango", "Kab. Pahuwato", "Kab. Gorontalo Utara", "Kota Gorontalo"],
        "Sulawesi Barat": ["Kab. Mamuju", "Kab. Pasangkayu", "Kab. Polewali Mandar", "Kab. Mamasa", "Kab. Mamuju Tengah"],
        "Maluku": ["Kab. Maluku Tengah", "Kab. Maluku Tenggara", "Kab. Kepulauan Tanimbar", "Kab. Buru", "Kab. Seram Bagian Timur", "Kab. Seram Bagian Barat", "Kab. Kepulauan Aru", "Kab. Maluku Barat Daya", "Kab. Buru Selatan", "Kota Ambon", "Kota Tual"],
        "Maluku Utara": ["Kab. Halmahera Barat", "Kab. Halmahera Tengah", "Kab. Halmahera Utara", "Kab. Halmahera Selatan", "Kab. Kepulauan Sula", "Kab. Halmahera Timur", "Kab. Pulau Morotai", "Kab. Pulau Taliabu", "Kota Ternate", "Kota Tidore Kepulauan"],
        "Papua": ["Kab. Merauke", "Kab. Jayawijaya", "Kab. Jayapura", "Kab. Nabire", "Kab. Kepulauan Yapen", "Kab. Biak Numfor", "Kab. Puncak Jaya", "Kab. Paniai", "Kab. Mimika", "Kab. Sarmi", "Kab. Keerom", "Kab. Waropen", "Kab. Mamberamo Raya", "Kab. Supiori", "Kab. Asmat", "Kab. Mappi", "Kab. Boven Digoel", "Kab. Yahukimo", "Kab. Pegunungan Bintang", "Kab. Tolikara", "Kab. Lanny Jaya", "Kab. Mamberamo Tengah", "Kab. Yalimo", "Kab. Nduga", "Kab. Puncak", "Kab. Dogiyai", "Kab. Intan Jaya", "Kab. Deiyai", "Kota Jayapura"],
        "Papua Barat": ["Kab. Sorong", "Kab. Manokwari", "Kab. Fak Fak", "Kab. Kaimana", "Kab. Teluk Bintuni", "Kab. Teluk Wondama", "Kab. Sorong Selatan", "Kab. Raja Ampat", "Kab. Tambrauw", "Kab. Maybrat", "Kab. Manokwari Selatan", "Kab. Pegunungan Arfak", "Kota Sorong"],
        "Papua Selatan": ["Kab. Merauke", "Kab. Mappi", "Kab. Asmat", "Kab. Boven Digoel"],
        "Papua Tengah": ["Kab. Nabire", "Kab. Puncak Jaya", "Kab. Paniai", "Kab. Mimika", "Kab. Puncak", "Kab. Dogiyai", "Kab. Intan Jaya", "Kab. Deiyai"],
        "Papua Pegunungan": ["Kab. Jayawijaya", "Kab. Pegunungan Bintang", "Kab. Yahukimo", "Kab. Tolikara", "Kab. Mamberamo Tengah", "Kab. Yalimo", "Kab. Lanny Jaya", "Kab. Nduga"],
        "Papua Barat Daya": ["Kab. Sorong", "Kab. Sorong Selatan", "Kab. Raja Ampat", "Kab. Tambrauw", "Kab. Maybrat", "Kota Sorong"],
    };
    // --- AKHIR DATA WILAYAH ---

    // Struktur Data untuk Support
    const supportCategories = {
        'Tidak perlu support': ['N/A'],
        'Legal & Risk': ['Review Document Kontrak', 'AKC', 'AKP'],
        'Solution & Delivery': ['Sizing project', 'Presales', 'Update Delivery'],
        'PMO': ['Proses Invoicing dan penagihan'],
        'Sales support': ['AM PDD', 'Sirkulir Doc kontrak']
    };
    
    // --- PERBAIKAN: Deklarasi const dipisah ---
    const loginScreen = document.getElementById('loginScreen');
    const mainContent = document.getElementById('mainContent');
    const roleSelector = document.getElementById('roleSelector');
    const salesPersonSelectorContainer = document.getElementById('salesPersonSelectorContainer');
    const salesPersonSelector = document.getElementById('salesPersonSelector');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSubtitle = document.getElementById('dashboardSubtitle');

    const globalPeriodFilters = document.getElementById('globalPeriodFilters');
    const customDateContainer = document.getElementById('customDateContainer');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const managerFilterContainer = document.getElementById('managerFilterContainer');
    const salesFilter = document.getElementById('salesFilter');

    const managerSelectorContainer = document.getElementById('managerSelectorContainer');
    const managerSelector = document.getElementById('managerSelector');
    const currentMonthYearEl = document.getElementById('currentMonthYear');

    const inputFormContainer = document.getElementById('inputFormContainer');
    const activityForm = document.getElementById('activityForm');
    const meetingTypeSelect = document.getElementById('meetingType');
    const obstacleSection = document.getElementById('obstacleSection');
    const recurringOption = document.getElementById('recurringOption');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const salesPersonInput = document.getElementById('salesPerson');
    const submitBtn = document.getElementById('submitBtn');

    const summaryContainer = document.getElementById('summaryContainer');
    const summaryTextEl = document.getElementById('summaryText');
    const calendarContainer = document.getElementById('calendarContainer');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const trendIndicator = document.getElementById('trendIndicator');
    const dailyActivityTrendContainer = document.getElementById('dailyActivityTrendContainer');
    
    // Metrik Hibrida
    const metricTotalMeetingsEl = document.getElementById('metricTotalMeetings');
    const metricNewClientsEl = document.getElementById('metricNewClients');
    const metricExistingClientsEl = document.getElementById('metricExistingClients');
    const metricTotalRFQsEl = document.getElementById('metricTotalRFQs');
    
    const avgSalesCycleDurationEl = document.getElementById('avgSalesCycleDuration');
    const metricAvgStepsEl = document.getElementById('metricAvgSteps');
    const metricExistingRatioEl = document.getElementById('metricExistingRatio');
    // --- AKHIR PERBAIKAN ---
    // Modal Hibrida
    const calendarModal = document.getElementById('calendarModal'), calendarModalContent = document.getElementById('calendarModalContent'), calendarModalCloseButton = document.getElementById('calendarModalCloseButton');
    // Form Input
    const unitInChargeSelect = document.getElementById('unitInCharge');
    const supportCategorySelect = document.getElementById('supportCategory');
    const lokasiProvinsiSelect = document.getElementById('lokasiProvinsi');
    const lokasiKotaSelect = document.getElementById('lokasiKota');
    const clientSegmentSelect = document.getElementById('clientSegment'); // NEW

    // --- DOM ELEMENTS BARU ---
    const salesTabsContainer = document.getElementById('salesTabsContainer');
    const tabButtons = document.querySelectorAll('#salesTabsContainer .tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const planForm = document.getElementById('planForm');
    const planSuccessMessage = document.getElementById('planSuccessMessage');
    const planListContainer = document.getElementById('planListContainer');
    const noPlansText = document.getElementById('noPlansText');
    const planSelector = document.getElementById('planSelector'); // Dropdown di Tab 2


    function setupTabListeners() {
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.tab;

            // Update Tombol Visual
            tabButtons.forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            button.classList.add('active-tab');
            button.classList.remove('inactive-tab');

            // Sembunyikan panel sales standar
            tabPanels.forEach(panel => panel.classList.add('hidden'));
            
            // Sembunyikan panel manager jika ada
            const buyerAnalyticPanel = document.getElementById('manager-tab-panel-5');
            if(buyerAnalyticPanel) buyerAnalyticPanel.classList.add('hidden');

            // Logika Switching
            if (tabId === '4') {
                // KASUS KHUSUS: Sales Buka Tab Buyer Analytic
                if(buyerAnalyticPanel) buyerAnalyticPanel.classList.remove('hidden');
                renderFilteredDashboard(); // <--- PENTING: Render ulang agar data muncul
            } else {
                const targetPanel = document.getElementById(`tab-panel-${tabId}`);
                if (targetPanel) targetPanel.classList.remove('hidden');
                
                if(tabId === '3') {
                    renderFilteredDashboard(); 
                }
            }
            
            lucide.createIcons();
        });
    });
}
// --- FUNGSI BARU: Logika Tab Switching (Khusus Manager)
function setupManagerTabListeners() {
    const managerTabButtons = document.querySelectorAll('.manager-tab-button');
    const managerTabPanels = document.querySelectorAll('.manager-tab-panel');

    managerTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.managerTab; // '1', '2', 'strategy', dst

            // Update UI Tombol
            managerTabButtons.forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            button.classList.add('active-tab');
            button.classList.remove('inactive-tab');

            // Update UI Panel
            managerTabPanels.forEach(panel => {
                // Trik: Panel ID kita formatnya 'manager-tab-panel-{tabId}'
                // Jadi 'manager-tab-panel-strategy' akan otomatis cocok
                if (panel.id === `manager-tab-panel-${tabId}`) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            // Trigger render khusus jika tab Strategy dibuka
            if (tabId === 'strategy') {
                 // Ambil sales yang sedang difilter
                 let salesToDisplay = [currentUser];
                 if (currentRole === 'manager') {
                     salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
                 } else if (currentRole === 'head_sales') {
                     salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
                 }
                 
                 renderStrategySimulator(allDeals, salesToDisplay);
            } else if (tabId !== '4') {
                renderFilteredDashboard();
            }
            
            lucide.createIcons();
        });
    });
}
    // --- FUNGSI BARU: Manajemen Rencana (Planning) ---
    
    // (Helper) Generate ID unik untuk Rencana

    // (Renderer) Tampilkan daftar rencana di Tab 1
    function renderPlanList() {
        if (!planListContainer) return; 
        
        // --- [PERBAIKAN] Filter: Sales hanya melihat miliknya sendiri ---
        let plansToDisplay = allPlans;
        if (currentRole === 'sales') {
            plansToDisplay = allPlans.filter(p => p.salesPerson === currentUser);
        }
        // ---------------------------------------------------------------

        if (plansToDisplay.length === 0) {
            planListContainer.innerHTML = '';
            noPlansText.classList.remove('hidden');
            return;
        }
        
        noPlansText.classList.add('hidden');
        planListContainer.innerHTML = plansToDisplay
            .sort((a,b) => new Date(a.plan_date) - new Date(b.plan_date)) 
            .map(plan => {
                let dateDisplay = plan.plan_date;
                try {
                    const dateObj = new Date(plan.plan_date);
                    if (!isNaN(dateObj.getTime())) {
                        dateDisplay = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                    }
                } catch (e) { }

                return `
                <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-white">${plan.clientName}</p>
                        
                        <p class="text-sm text-gray-300">
                            ${plan.activityType} <span class="text-blue-400 font-medium">(${plan.capability || '-'})</span> pada <strong>${dateDisplay}</strong>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${plan.notes || 'Tidak ada catatan.'}</p>
                    </div>
                    <button title="Hapus Rencana" class="delete-plan-btn text-red-400 hover:text-red-300 p-2" data-plan-id="${plan.plan_id}">
                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                    </button>
                </div>
            `}).join('');
        
        lucide.createIcons();
    }

    // (Renderer) Tampilkan opsi rencana di dropdown Tab 2
    function renderPlanSelector() {
        if (!planSelector) return; 

        // --- [PERBAIKAN] Filter: Sales hanya melihat miliknya sendiri ---
        let plansToDisplay = allPlans;
        if (currentRole === 'sales') {
            plansToDisplay = allPlans.filter(p => p.salesPerson === currentUser);
        }
        // ---------------------------------------------------------------

        if (plansToDisplay.length === 0) {
            planSelector.innerHTML = '<option value="">-- Tidak ada rencana --</option>';
            return;
        }

        const optionsHTML = plansToDisplay
            .sort((a,b) => new Date(a.plan_date) - new Date(b.plan_date))
            .map(plan => {
                let displayDate = plan.plan_date;
                try {
                    const dateObj = new Date(plan.plan_date);
                    if (!isNaN(dateObj.getTime())) {
                        displayDate = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                    }
                } catch (e) { }

                return `<option value="${plan.plan_id}">
                    ${displayDate} - ${plan.clientName} (${plan.activityType})
                </option>`;
            }).join('');

        planSelector.innerHTML = '<option value="">-- Pilih Rencana Aktif --</option>' + optionsHTML;
    }

// (MODIFIKASI) Renderer untuk dropdown Follow Up (Filter Tahun Berjalan)
function renderFollowUpLeadSelector(clientNameFilter = '') {
    const selectEl = document.getElementById('planFollowUpLead');
    if (!selectEl) return;

    // Jika tidak ada nama klien, tampilkan pesan prompt dan nonaktifkan
    if (!clientNameFilter || clientNameFilter.trim() === '') {
        selectEl.innerHTML = '<option value="">-- Ketik Nama Klien Dulu --</option>';
        selectEl.disabled = true; 
        return;
    }

    selectEl.disabled = false; 
    let optionsHTML = `<option value="">-- Pilih Lead (Tahun Ini) --</option>`;
    let planOptionsFound = 0;
    let dealOptionsFound = 0;

    // --- [PERUBAHAN 1] Tentukan Tahun Berjalan ---
    const currentYear = new Date().getFullYear(); 

    // 1. Ambil dari Rencana Aktif (allPlans) 
    // Syarat: Nama Klien Cocok DAN Tahun Rencana = Tahun Ini
    const filteredPlans = allPlans.filter(plan => {
        const nameMatch = plan.clientName.toLowerCase() === clientNameFilter.toLowerCase();
        
        let isCurrentYear = false;
        if (plan.plan_date) {
            const pDate = new Date(plan.plan_date);
            if (!isNaN(pDate.getTime())) {
                isCurrentYear = pDate.getFullYear() === currentYear;
            }
        }
        return nameMatch && isCurrentYear;
    });

    let planOptions = filteredPlans.map(plan => {
        planOptionsFound++;
        return `<option value="plan_${plan.plan_id}">[Rencana] ${plan.clientName} (${plan.activityType})</option>`
    }).join('');

    if (planOptions) {
        optionsHTML += `<optgroup label="Rencana Aktif (Tahun Ini)">${planOptions}</optgroup>`;
    }

    // 2. Ambil dari Lead Terealisasi (allDeals)
    // Syarat: Nama Klien Cocok DAN Tanggal Meeting = Tahun Ini
    const latestDealsMap = new Map();
    allDeals
        .filter(deal => {
            const nameMatch = deal.client.toLowerCase() === clientNameFilter.toLowerCase();
            
            // --- [PERUBAHAN 2] Filter Tahun ---
            const dealDate = deal.meetingDateObj;
            const isCurrentYear = dealDate && dealDate.getFullYear() === currentYear;

            return nameMatch && isCurrentYear; 
        }) 
        .forEach(deal => {
            const key = deal.projectGUID || deal.id; 
            const dealDate = deal.meetingDateObj?.getTime();
            if (dealDate && (!latestDealsMap.has(key) || dealDate > (latestDealsMap.get(key).meetingDateObj?.getTime() || 0))) {
                latestDealsMap.set(key, deal);
            }
        });

    let dealOptions = Array.from(latestDealsMap.values())
        .sort((a,b) => b.meetingDateObj?.getTime() - a.meetingDateObj?.getTime())
        .map(deal => {
            dealOptionsFound++;
            // Format tanggal pendek untuk info
            const dateStr = deal.meetingDateObj ? deal.meetingDateObj.toLocaleDateString('id-ID') : '';
            return `<option value="deal_${deal.projectGUID || deal.id}">[Lead] ${deal.namaProject || 'No Project'} (${dateStr})</option>`
        }).join('');

    if (dealOptions) {
        optionsHTML += `<optgroup label="Lead Terealisasi (Tahun Ini)">${dealOptions}</optgroup>`;
    }

    // Jika tidak ada data ditemukan
    if (planOptionsFound === 0 && dealOptionsFound === 0) {
        optionsHTML = `<option value="">-- Tidak ada history tahun ${currentYear} --</option>`;
    }

    selectEl.innerHTML = optionsHTML;
}
// (BARU) Mengisi datalist untuk autocomplete Nama Klien
function populateClientDatalist() {
    const datalistEl = document.getElementById('clientList');
    if (!datalistEl) return;

    // 1. Ambil nama klien dari data Realisasi (allDeals)
    const dealClients = allDeals.map(deal => deal.client);

    // 2. Ambil nama klien dari data Rencana (menggunakan fungsi yang sudah ada)
    const planClients = allPlansFull.map(plan => plan.clientName);

    // 3. Gabungkan, saring unik, dan filter nama kosong
    const allClientNames = [...new Set([...dealClients, ...planClients])];

    const validClientNames = allClientNames
        .filter(name => name && name.trim() !== '') // Filter nama kosong
        .sort(); // Urutkan A-Z

    // 4. Buat HTML <option>
    datalistEl.innerHTML = validClientNames
        .map(clientName => `<option value="${clientName}"></option>`)
        .join('');
}
    // --- UTILITY FUNCTIONS ---

    // Format mata uang IDR
    const formatIDR = (number) => {
        if (number === null || number === undefined || isNaN(number)) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

// (BARU) Format mata uang singkat (Jt, M, T)
const formatIDRShort = (number) => {
    if (number === null || number === undefined || isNaN(number) || number === 0) return 'Rp 0';

    const num = Math.abs(Number(number));
    const tiers = [
        { value: 1e12, symbol: 'T' }, // Triliun
        { value: 1e9,  symbol: 'M' }, // Miliar
        { value: 1e6,  symbol: 'Jt' }, // Juta
        { value: 1e3,  symbol: 'Rb' }  // Ribu
    ];

    // Cari tier yang sesuai
    const tier = tiers.find(t => num >= t.value);

    if (tier) {
        // Format angka, hapus .0 jika tidak perlu (misal 1.5 Jt, bukan 1.0 Jt)
        const formattedNum = (num / tier.value).toFixed(1).replace(/\.0$/, '');
        return `Rp ${formattedNum} ${tier.symbol}`;
    }

    return 'Rp ' + num.toLocaleString('id-ID'); // Fallback untuk angka < 1000
};

    // Format tanggal ke YYYY-MM-DD
    const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        date.setHours(12, 0, 0, 0); 
        return date.toISOString().split('T')[0];
    };
    // --- UTILITY BARU: Pembersih Tanggal ---
    const getCleanDateString = (rawDate) => {
        if (!rawDate) return '';
        try {
            // Jika input sudah berupa object Date
            if (rawDate instanceof Date) {
                return `${rawDate.getFullYear()}-${String(rawDate.getMonth() + 1).padStart(2, '0')}-${String(rawDate.getDate()).padStart(2, '0')}`;
            }
            // Jika string, potong bagian jam (T) jika ada
            return String(rawDate).split('T')[0];
        } catch (e) {
            return '';
        }
    };
    // (PERBAIKAN) Modifikasi fungsi modal untuk mendukung Notifikasi
    const showCustomModal = (title, message) => {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        // Pastikan isi message direset ke text biasa jika sebelumnya ada HTML
        const msgEl = document.getElementById('modalMessage');
        msgEl.innerHTML = ''; 
        msgEl.textContent = message;

        // Reset tombol
        document.getElementById('modalCloseButton').textContent = 'Tutup';
        document.getElementById('modalCancelButton').classList.add('hidden');
        
        // [TAMBAHAN PENTING] Sembunyikan tombol Copy agar tidak bocor ke notifikasi lain
        const copyBtn = document.getElementById('modalCopyButton');
        if(copyBtn) copyBtn.classList.add('hidden');

        modalConfirmCallback = null; 

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };
    // (PERBAIKAN) Fungsi BARU untuk modal konfirmasi
    const showCustomConfirmModal = (title, message, onConfirm) => {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;

        // Ubah tombol menjadi (Ya/Batal)
        document.getElementById('modalCloseButton').textContent = 'Ya, Lanjutkan';
        document.getElementById('modalCancelButton').classList.remove('hidden');
        modalConfirmCallback = onConfirm; // Simpan callback

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };
    
    // (PERBAIKAN) Event listener untuk tombol modal utama (Tutup / Ya)
    document.getElementById('modalCloseButton').addEventListener('click', () => {
        if (modalConfirmCallback) {
            // Jika ini adalah modal konfirmasi, panggil callback
            modalConfirmCallback();
            modalConfirmCallback = null; // Hapus setelah dipanggil
        }
        // Selalu tutup modal
        const modal = document.getElementById('customModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // (PERBAIKAN) Event listener BARU untuk tombol Batal
    document.getElementById('modalCancelButton').addEventListener('click', () => {
        modalConfirmCallback = null; // Hapus callback
        const modal = document.getElementById('customModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Format input (Estimasi Amount) menjadi format ribuan saat diketik
    function formatRupiah(input) {
        // Ambil nilai tanpa titik
        let value = input.value.replace(/\./g, '');

        // Hanya izinkan angka
        value = value.replace(/[^0-9]/g, '');

        // Format kembali dengan titik sebagai pemisah ribuan
        const formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        input.value = formattedValue;
    }
    
    // Ekspos fungsi formatRupiah ke global scope agar dapat dipanggil dari HTML oninput
    window.formatRupiah = formatRupiah;

    // Fungsi untuk mengisi dropdown (Pilihan Sales, Manager)
    function populateDropdowns() {
        salesPersonSelector.innerHTML = allSales.map(name => `<option value="${name}">${name}</option>`).join('');
        managerSelector.innerHTML = managers.map(name => `<option value="${name}">${name}</option>`).join('');
        salesPersonInput.innerHTML = allSales.map(name => `<option value="${name}">${name}</option>`).join('');
    }

    // Fungsi untuk mengisi dropdown support (Unit & Kategori)
    function populateSupportDropdowns() {
        // 1. Isi Unit in Charge
        unitInChargeSelect.innerHTML = Object.keys(supportCategories)
            .map(unit => `<option value="${unit}">${unit}</option>`)
            .join('');
        
        // 2. Fungsi untuk update Kategori
        function updateSupportCategories() {
            const selectedUnit = unitInChargeSelect.value;
            const categories = supportCategories[selectedUnit] || [];
            supportCategorySelect.innerHTML = categories
                .map(category => `<option value="${category}">${category}</option>`)
                .join('');
        }

        // 3. Tambahkan listener ke Unit
        unitInChargeSelect.addEventListener('change', updateSupportCategories);
        
        // 4. Panggil sekali
        updateSupportCategories();
    }
    
    // FUNGSI BARU UNTUK LOKASI
    function populateWilayahDropdowns() {
        // 1. Isi Provinsi
        const provinsiOptions = Object.keys(allWilayah).sort().map(prov => 
            `<option value="${prov}">${prov}</option>`
        ).join('');
        lokasiProvinsiSelect.innerHTML = '<option value="">-- Pilih Provinsi --</option>' + provinsiOptions;

        // 2. Tambahkan listener ke Provinsi
        lokasiProvinsiSelect.addEventListener('change', () => {
            const selectedProv = lokasiProvinsiSelect.value;
            lokasiKotaSelect.innerHTML = ''; 
            
            if (selectedProv && allWilayah[selectedProv]) {
                const kotaOptions = allWilayah[selectedProv].sort().map(kota =>
                    `<option value="${kota}">${kota}</option>`
                ).join('');
                lokasiKotaSelect.innerHTML = '<option value="">-- Pilih Kota/Kabupaten --</option>' + kotaOptions;
            } else {
                lokasiKotaSelect.innerHTML = '<option value="">-- Pilih Provinsi Dulu --</option>';
            }
        });
    }

// ... (setelah fungsi populateWilayahDropdowns)

/**
 * (BARU) Mengunci/membatasi dropdown Tipe Aktivitas berdasarkan tahap terakhir
 * @param {string | null} latestStage - Nama tahap terakhir (misal: "Desire"). 
 * Jika 'null', buka semua kunci.
 */
function lockActivityType(latestStage) {
    const activityTypeInput = document.getElementById('meetingType');
    if (!activityTypeInput) return;

    // 1. Jika latestStage null, buka semua kunci dan keluar
    if (latestStage === null) {
        Array.from(activityTypeInput.options).forEach(opt => opt.disabled = false);
        return;
    }

    // 2. Temukan indeks tahap terakhir
    const latestStageIndex = AIDA_PIPELINE_ORDER.indexOf(latestStage);

    // 3. Jika tahap terakhir tidak dikenal (misal: "Awareness" pertama kali),
    //    perlakukan seolah-olah tahap terakhir adalah -1 (sebelum "Awareness")
    const minIndex = (latestStageIndex === -1) ? -1 : latestStageIndex;

    let firstEnabledOption = null;

    // 4. Loop melalui semua <option> di dropdown
    Array.from(activityTypeInput.options).forEach(opt => {
        const optionStage = opt.value;
        const optionStageIndex = AIDA_PIPELINE_ORDER.indexOf(optionStage);

        // Opsi 'Lost' selalu bisa dipilih
        if (optionStage === 'Lost') {
            opt.disabled = false;
            return;
        }

        // 5. Jika tahap opsi < tahap minimum, nonaktifkan
        if (optionStageIndex < minIndex) {
            opt.disabled = true;
        } else {
            // 6. Jika tahap opsi >= tahap minimum, aktifkan
            opt.disabled = false;
            if (!firstEnabledOption) {
                firstEnabledOption = opt.value; // Catat opsi valid pertama
            }
        }
    });

    // 7. Atur nilai dropdown ke tahap valid paling awal (biasanya tahap yang sama)
    if (firstEnabledOption) {
        activityTypeInput.value = firstEnabledOption;
    }
}

    // --- LOGIKA DATA LOCAL STORAGE (MOCK) ---
    // Fungsi ini dikosongkan karena kita hanya menggunakan data live
    function getMockDealsData() { return []; } 
    
// Fungsi untuk memproses data mentah (dari API/Mock) ke format internal (allDeals)
    function processDealsData(deals) {
        if (!deals || deals.length === 0) return [];
        
        return deals.map(deal => {
             // Mapping Keys dari output Spreadsheet
             const mappedDeal = {
                 id: deal.id || 'err_id_' + Date.now() + Math.random(), 
                 client: deal.Nama_Klien || deal.client,
                 sales: deal.Nama_Sales || deal.sales,
                 meetingType: deal.Type_Aktivitas || deal.meetingType,
                 value: parseInt(String(deal.Nilai_Deal || deal.value).replace(/\./g, '')) || 0,
                 recurring: false, 
                 obstacle: deal.Hambatan || deal.obstacle,
                 meetingDate: deal.Tanggal_Meeting || deal.meetingDate,
                 notes: deal.Hasil_Meeting || deal.notes,
                 clientType: deal.Tipe_Klien || deal.clientType,
                 capability: deal.Capability || deal.capability,
                 
                 // === PERBAIKAN UTAMA DI SINI (BACA BERBAGAI VARIASI NAMA KOLOM) ===
                 // Membaca: Program_Champion (Excel), programChampion (JS), atau kosong
                 programChampion: deal.Program_Champion || deal.programChampion || deal.program_champion || 'Non-Program', 
                 // ==================================================================

                 unitInCharge: deal.Unit_in_Charge || deal.unitInCharge,
                 supportCategory: deal.Kategori_Support || deal.supportCategory,
                 supportStatus: deal.Support_Status || deal.supportStatus,
                 nomorRFQ: deal.ID_DEAL || deal.nomorRFQ, 
                 projectGUID: deal.Project_GUID || null,
                 namaProject: deal.Nama_Project || deal.namaProject,
                 lokasiKota: deal.Lokasi_Kota || deal.lokasiKota,
                 lokasiProvinsi: deal.Lokasi_Provinsi || deal.lokasiProvinsi,
                 clientSegment: deal.Client_Segment || deal.clientSegment || 'Enterprise'
             };

             // --- PERBAIKAN VALIDASI TANGGAL (FIX TIMEZONE) ---
             if (mappedDeal.meetingDate) {
                 try {
                     const dateStr = String(mappedDeal.meetingDate);
                     
                     // Cek format ISO (T & Z)
                     if (dateStr.includes('T') && dateStr.includes('Z')) {
                         const dateObj = new Date(dateStr);
                         if (!isNaN(dateObj.getTime())) {
                             mappedDeal.meetingDateObj = new Date(
                                 dateObj.getFullYear(), 
                                 dateObj.getMonth(), 
                                 dateObj.getDate(), 
                                 12, 0, 0 
                             );
                         }
                     } 
                     // Cek format YYYY-MM-DD
                     else {
                         const cleanStr = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
                         const parts = cleanStr.split('-');
                         
                         if (parts.length === 3) {
                             mappedDeal.meetingDateObj = new Date(
                                 parseInt(parts[0]), 
                                 parseInt(parts[1]) - 1, 
                                 parseInt(parts[2]), 
                                 12, 0, 0
                             );
                         }
                     }

                     if (!mappedDeal.meetingDateObj || isNaN(mappedDeal.meetingDateObj.getTime())) {
                         throw new Error("Invalid Date");
                     }

                 } catch (dateError) {
                      console.warn('SKIP DATA (Tanggal Error):', mappedDeal.client, mappedDeal.meetingDate);
                      mappedDeal.meetingDateObj = null;
                 }
             } else { 
                 mappedDeal.meetingDateObj = null; 
             }

             return mappedDeal;

         }).filter(d => d.meetingDateObj !== null); 
    }
    // --- BARU: Kunci localStorage & Generator GUID ---
    const LOCAL_STORAGE_KEY = 'mySalesDashboardData';

    /**
     * Menghasilkan ID unik untuk project (Solusi Gold Standard)
     */
    function generateGUID() {
        return 'proj_' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }
    // --- AKHIR BARU ---


    // --- LOGIKA FETCH / POST KE GOOGLE SCRIPT (DIMODIFIKASI UNTUK LOCALSTORAGE) ---

   // --- LOGIKA FETCH / POST KE GOOGLE SCRIPT (JSONP) ---

    // --- FUNGSI HELPER BARU UNTUK JSONP ---
    function jsonpRequest(baseUrl, params) {
        return new Promise((resolve, reject) => {
            const callbackName = 'jsonp_callback_' + Math.floor(Date.now() + Math.random() * 10000);

            let queryString = `?callback=${callbackName}`;
            for (const key in params) {
                queryString += `&${key}=${encodeURIComponent(params[key])}`;
            }

            const script = document.createElement('script');
            script.src = baseUrl + queryString; 

            window[callbackName] = (data) => {
                resolve(data);
                document.head.removeChild(script);
                delete window[callbackName];
            };

            script.onerror = (err) => {
                const errorMsg = 'Gagal memuat script JSONP. Cek URL GScript, pastikan di-deploy ulang, dan pastikan akses "Anyone".';
                console.error(errorMsg, err);
                reject(new Error(errorMsg));
            }; // <-- (FIX 1) Menutup 'script.onerror'

            document.head.appendChild(script); // <-- (FIX 2) Menambahkan script ke DOM (PENTING)

        }); // <-- (FIX 3) Menutup 'new Promise'
    } // <-- (FIX 4) Menutup 'jsonpRequest'

    /* // <-- (FIX 5) Memperbaiki format komentar
     * [PERBAIKAN JSONP] Mengambil data Realisasi dari Google Apps Script
     */
    async function fetchDataFromScript() {
        console.log("MODE JSONP: Mengambil data Realisasi (action=getData)...");
        
        // (BARU) Buat parameter dinamis berdasarkan role
        let dealParams = { 
            action: 'getData',
            role: currentRole // Selalu kirim role
        };
        if (currentRole === 'sales') {
            dealParams.salesPerson = currentUser; // Kirim salesPerson jika sales
        }
        
        try {
            // (MODIFIKASI) Kirim parameter dinamis
            const deals = await jsonpRequest(GOOGLE_SCRIPT_URL, dealParams); 
            
            if (Array.isArray(deals)) {
                return processDealsData(deals);
            } else {
                throw new Error(deals.message || 'Data tidak diterima dalam format array.');
            }

        } catch (error) {
            console.error("Google Script JSONP Fetch Error:", error);
            showCustomModal("Error Koneksi Live Data", "Gagal mengambil data Realisasi (JSONP). Error: " + error.message);
            throw error; 
        }
    }

    /** * [PERBAIKAN JSONP] Mengirim data BARU (Realisasi) atau UPDATE (Support)
    */
    async function postDataToScript(payload) {
        console.log("MODE JSONP: Mengirim data ke Google Apps Script...", payload);
        let params = {}; 

        if (payload.action === 'create' && payload.data) {
            // --- Konversi ke format 'addData' GScript baru ---
            params = payload.data; 
            params.action = 'addData'; // Tambahkan parameter action

        } else if (payload.action === 'update' && payload.idToFind && payload.data.Support_Status) {
            // --- Konversi ke format 'updateSupportStatus' GScript baru ---
            params.action = 'updateSupportStatus';
            params.id = payload.idToFind; // GScript baru mengharapkan 'id'
            params.status = payload.data.Support_Status; // GScript baru mengharapkan 'status'

        } else {
            console.error("Payload tidak dikenali untuk postDataToScript JSONP:", payload);
            throw new Error("Payload tidak dikenali untuk postDataToScript JSONP.");
        }

        try {
            const result = await jsonpRequest(GOOGLE_SCRIPT_URL, params);

            if (result.status !== "sukses") {
                throw new Error(result.message || 'Terjadi error di server Apps Script.');
            }

            console.log("Google Script JSONP Post Success:", result.message);
            return result; 

        } catch (error) {
            console.error("Google Script JSONP Post Error:", error);
            showCustomModal("Error Submit Data", "Gagal menyimpan (JSONP): " + error.message);
            throw error;
        }
    }
// [BARU] Fungsi Global untuk Ganti Tab Project Analytic
window.switchProjectTab = (capability) => {
    currentProjectCapability = capability;
    
    // Update Tampilan Tombol
    const btnITO = document.getElementById('subtab-proj-ito');
    const btnSIPLah = document.getElementById('subtab-proj-siplah');
    
    if(capability === 'IT Outsourcing') {
        btnITO.className = "px-4 py-2 rounded-md text-sm font-semibold transition-colors bg-blue-600 text-white shadow-sm";
        btnSIPLah.className = "px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-400 hover:text-white hover:bg-gray-700";
    } else {
        btnITO.className = "px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-400 hover:text-white hover:bg-gray-700";
        btnSIPLah.className = "px-4 py-2 rounded-md text-sm font-semibold transition-colors bg-blue-600 text-white shadow-sm";
    }
// [BARU] Update Judul Tabel & Grafik
    const chartTitleEl = document.getElementById('projectAnalyticTitleCap');
    const tableTitleEl = document.getElementById('tableTitleCap'); // ID Baru
    
    if(chartTitleEl) chartTitleEl.textContent = capability;
    if(tableTitleEl) tableTitleEl.textContent = capability;
    // Render ulang dashboard untuk menerapkan filter
    renderFilteredDashboard();
// [TAMBAHAN] Pastikan Tabel Stale Leads juga direfresh secara eksplisit
    // Kita perlu mengambil 'allDeals' dan 'salesToDisplay' dari scope global/terakhir
    // Karena fungsi ini dipicu oleh tombol onclick, kita andalkan renderFilteredDashboard() 
    // untuk memanggil renderStaleLeadsTable di dalamnya. 
    // (Langkah ini sebenarnya sudah tercover jika renderFilteredDashboard memanggil renderStaleLeadsTable)
};
// --- FUNGSI BARU: RENDER AIDA KHUSUS YTD (Agar sama dengan Card Pencapaian) ---
function renderAIDAYTD(allDeals, salesToDisplay) {
    const progressBarContainer = document.getElementById('aidaProgressBar');
    const legendContainer = document.getElementById('aidaLegend');
    
    if (!progressBarContainer || !legendContainer) return;

    const currentYear = new Date().getFullYear();
    const uniqueDealsMap = new Map();
    
    // 1. Deduplikasi & Filter YTD (Sama persis dengan logika Strategy YTD)
    allDeals.forEach(deal => {
        // Filter Sales
        if (!salesToDisplay.includes(deal.sales)) return;

        // Filter Tahun (WAJIB TAHUN INI)
        if (!deal.meetingDateObj || deal.meetingDateObj.getFullYear() !== currentYear) return;

        // Abaikan Lost
        if (deal.meetingType === 'Lost') return;

        // Logika Unik (Deduplikasi Project)
        let uniqueKey = deal.projectGUID;
        if (!uniqueKey && deal.nomorRFQ && deal.nomorRFQ.trim().length > 2) uniqueKey = "rfq_" + deal.nomorRFQ;
        if (!uniqueKey) uniqueKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();

        const existing = uniqueDealsMap.get(uniqueKey);
        // Ambil data terbaru
        if (!existing || deal.meetingDateObj > existing.meetingDateObj) {
            uniqueDealsMap.set(uniqueKey, deal);
        }
    });

    // 2. Hitung Total per Kategori
    const aidaCounts = { awareness: 0, interest: 0, desire: 0, action: 0, total: 0 };

    uniqueDealsMap.forEach(deal => {
        const val = parseInt(deal.value) || 0;
        const status = deal.meetingType;

        if (status === 'Awareness') aidaCounts.awareness += val;
        else if (status === 'Interest') aidaCounts.interest += val;
        else if (['Desire', 'Process Closing'].includes(status)) aidaCounts.desire += val;
        else if (['Action', 'Delivery', 'Payment'].includes(status)) aidaCounts.action += val;
        
        aidaCounts.total += val;
    });

    // 3. Render Progress Bar (UI)
    const segments = [
        { name: 'Awareness', value: aidaCounts.awareness, color: 'bg-blue-500' },
        { name: 'Interest', value: aidaCounts.interest, color: 'bg-green-500' },
        { name: 'Desire', value: aidaCounts.desire, color: 'bg-yellow-500' },
        { name: 'Action', value: aidaCounts.action, color: 'bg-red-500' }, 
    ];

    const progressBarHtml = segments.map(s => {
        const percentage = aidaCounts.total > 0 ? (s.value / aidaCounts.total) * 100 : 0;
        // Tampilkan jika persentase > 0
        if (percentage <= 0) return '';
        return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${percentage.toFixed(1)}%;" title="${s.name}: ${formatIDRShort(s.value)}"></div>`;
    }).join('');
    progressBarContainer.innerHTML = progressBarHtml;

    // 4. Render Legend
    const legendHtml = segments.map(s => {
        const percentage = aidaCounts.total > 0 ? (s.value / aidaCounts.total) * 100 : 0;
        return `
        <div class="flex flex-col">
            <span class="text-xs text-gray-500">${s.name}</span>
            <span class="text-base font-semibold text-white">${percentage.toFixed(1)}%</span>
            <span class="text-[10px] text-gray-400">(${formatIDRShort(s.value)})</span>
        </div>
    `}).join('');
    legendContainer.innerHTML = legendHtml;
}
    // --- LOGIKA UTAMA APLIKASI ---
    function init() {
        populateDropdowns();
        populateSupportDropdowns();
        populateWilayahDropdowns();
setupManagerTabListeners(); // <--- PERBAIKAN: Menambahkan ()
        
        setupTabListeners(); // <--- MODIFIKASI: Panggil listener tab

        // Periksa session storage untuk status login
        currentRole = sessionStorage.getItem('salesRole');
        currentUser = sessionStorage.getItem('salesUser');
        
        if (currentRole) {
            showDashboard();
        } else {
            showLogin();
        }
        setupEventListeners();
    }
// --- FUNGSI BARU: TOGGLE EXPAND/COLLAPSE STRATEGY ---
window.toggleStrategyGroup = (groupId) => {
    // 1. Toggle Baris Data
    const rows = document.querySelectorAll(`.strat-group-${groupId}`);
    rows.forEach(row => {
        row.classList.toggle('hidden');
    });

    // 2. Putar Icon Chevron
    const icon = document.getElementById(`icon-strat-${groupId}`);
    if (icon) {
        if (icon.style.transform === 'rotate(180deg)') {
            icon.style.transform = 'rotate(0deg)';
        } else {
            icon.style.transform = 'rotate(180deg)';
        }
    }
};
// --- FUNGSI BARU: HITUNG KECUKUPAN GAP VS POTENSI ---
window.updateGapCoverage = () => {
    const coverageText = document.getElementById('strategyCoverageText');
    if (!coverageText) return;

    // 1. Ambil Gap saat ini (dari fungsi calculateStrategy)
    // Jika undefined, ambil dari text content atau default 0
    const gapVal = window.currentStrategyGap || 0;

    // 2. Ambil Total Potensi Tabel (dari fungsi generateStrategyInsights)
    const potVal = window.totalInsightPotential || 0;

    // 3. Logika Tampilan
    if (gapVal <= 0) {
        coverageText.innerHTML = `<span class="text-emerald-400 font-bold"><i data-lucide="check-circle" class="inline w-4 h-4 mr-1"></i> Target Tercapai!</span> Tidak ada gap yang perlu dikejar.`;
    } else {
        const coveragePercent = (potVal / gapVal) * 100;
        const isSafe = coveragePercent >= 100;
        
        const colorClass = isSafe ? "text-emerald-400" : "text-red-400";
        const icon = isSafe ? "check-circle" : "alert-circle";
        const statusMsg = isSafe ? "AMAN (Surplus)" : "KURANG (Defisit)";
        
        // Tampilkan Perbandingan
        coverageText.innerHTML = `
            Gap Target: <span class="text-white font-mono font-bold">${formatIDRShort(gapVal)}</span> 
            vs Total Potensi Eksekusi: <span class="text-white font-mono font-bold">${formatIDRShort(potVal)}</span>
            <br>
            Status: <span class="${colorClass} font-bold"><i data-lucide="${icon}" class="inline w-4 h-4 mr-1"></i> ${statusMsg}</span> 
            (Menutup ${coveragePercent.toFixed(1)}% Gap)
        `;
    }
    lucide.createIcons();
};
    // Tampilkan layar login
    function showLogin() {
        sessionStorage.clear();
        currentRole = null;
        currentUser = null;
        
        // Pastikan mainContent disembunyikan dan direset
        mainContent.classList.add('hidden');
        mainContent.classList.remove('visible'); 

        loginScreen.classList.remove('hidden');
        loginScreen.style.display = 'flex'; // Pastikan login screen terlihat
        
        // --- PERBAIKAN ---
roleSelector.value = 'sales';

// Secara eksplisit TAMPILKAN dropdown sales
salesPersonSelectorContainer.classList.remove('hidden');

// Secara eksplisit SEMBUNYIKAN dropdown manager
managerSelectorContainer.classList.add('hidden');
        
        passwordInput.value = '';
        loginError.classList.add('hidden');
    }

    async function showDashboard() {
        loginScreen.classList.add('hidden');
        loginScreen.style.display = 'none'; 
        document.getElementById('loadingIndicator').classList.remove('hidden');
        
        let planParams = { 
            action: 'getPlans',
            role: currentRole,
            _timestamp: new Date().getTime() 
        };
        if (currentRole === 'sales') {
            planParams.salesPerson = currentUser;
        }

        // --- PERUBAHAN DISINI: MENGGUNAKAN CSV UNTUK TARGET ---
        const results = await Promise.allSettled([
            fetchDataFromScript(), // Index 0: Deals (Script)
            jsonpRequest(GOOGLE_SCRIPT_URL, planParams), // Index 1: Plans (Script)
            loadTargetsFromCSV() // Index 2: Targets (PAKAI CSV - LEBIH STABIL)
        ]);

        // Proses Data Deals
        if (results[0].status === 'fulfilled') {
            allDeals = results[0].value;
        } else {
            allDeals = [];
        }

        // Proses Data Plans
        if (results[1].status === 'fulfilled') {
            allPlansFull = results[1].value;
            allPlans = allPlansFull.filter(p => p.status === 'planned');
        } else {
            allPlans = [];
            allPlansFull = [];
        }

        // Proses Data Target (DARI CSV)
        if (results[2].status === 'fulfilled') {
            allTargetsGlobal = results[2].value; // Langsung simpan array dari CSV
        } else {
            allTargetsGlobal = [];
        }

        // Tampilkan UI
        mainContent.classList.remove('hidden');
        setTimeout(() => {
            mainContent.classList.add('visible');
            document.getElementById('loadingIndicator').classList.add('hidden'); 
        }, 50); 
        
        renderPlanList();
        renderPlanSelector();
        renderFollowUpLeadSelector();
        populateClientDatalist();
        renderAppView();
    }
    
    // Atur tampilan dashboard berdasarkan peran (role)
    function renderAppView() {
        let filterOptionsHtml = '';
    // Ambil elemen kartu forecast
        if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            filterOptionsHtml = '<option value="all">Semua Tim Saya</option>' + myTeam.map(name => `<option value="${name}">${name}</option>`).join('');
            
            dashboardSubtitle.textContent = `Ringkasan performa untuk tim ${currentUser}.`;
            managerFilterContainer.classList.remove('hidden');
            summaryContainer.classList.remove('hidden');
            dailyActivityTrendContainer.classList.remove('hidden');
            document.getElementById('managerPlanningMetricsWrapper').classList.remove('hidden');
            
            // --- PERBAIKAN BUG 2 ---
            // (MODIFIKASI) Tampilkan tab Leads Aktif untuk Manager
            const tab3Button = document.getElementById('manager-tab-btn-3');
            if(tab3Button) tab3Button.classList.remove('hidden'); // Diubah dari .add('hidden')
            
            // Sembunyikan tab Looker (Tab 4) untuk Manager
            const tab4Button = document.getElementById('manager-tab-btn-4');
            if(tab4Button) tab4Button.classList.add('hidden');
            // --- AKHIR PERBAIKAN BUG 2 ---
                        
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.add('hidden'); // Sembunyikan 3-tab
            document.getElementById('tab-panel-1').classList.add('hidden');
            document.getElementById('tab-panel-2').classList.add('hidden');
            document.getElementById('tab-panel-3').classList.remove('hidden');

        } else if (currentRole === 'head_sales') {
            filterOptionsHtml = '<option value="all">Semua Sales</option>' + allSales.map(name => `<option value="${name}">${name}</option>`).join('');

            dashboardSubtitle.textContent = 'Ringkasan performa seluruh tim sales.';
            managerFilterContainer.classList.remove('hidden');
            summaryContainer.classList.remove('hidden');
            dailyActivityTrendContainer.classList.remove('hidden');
            document.getElementById('managerPlanningMetricsWrapper').classList.remove('hidden');
            
            // --- PERBAIKAN BUG 1 ---
            // (MODIFIKASI) Tampilkan tab Leads Aktif (Tab 3)
            const tab3Button = document.getElementById('manager-tab-btn-3');
            if(tab3Button) tab3Button.classList.remove('hidden');
            
            // (BARU) Tampilkan juga tab Looker (Tab 4) untuk Head Sales
            const tab4Button = document.getElementById('manager-tab-btn-4');
            if(tab4Button) tab4Button.classList.remove('hidden');
            // --- AKHIR PERBAIKAN BUG 1 ---
            
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.add('hidden'); // Sembunyikan 3-tab
            document.getElementById('tab-panel-1').classList.add('hidden');
            document.getElementById('tab-panel-2').classList.add('hidden');
            document.getElementById('tab-panel-3').classList.remove('hidden');

        } else { // Sales Person
            dashboardSubtitle.textContent = `Selamat datang kembali, ${currentUser}!`;
            salesFilter.value = currentUser; // Set filter ke diri sendiri
            managerFilterContainer.classList.add('hidden');
            summaryContainer.classList.add('hidden'); 
            dailyActivityTrendContainer.classList.add('hidden');
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.remove('hidden'); // Tampilkan 3-tab
            // Atur tab default ke "Perencanaan" (Tab 1)
            document.getElementById('tab-btn-1').click();
            
            salesPersonInput.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
            salesPersonInput.value = currentUser;
            document.getElementById('meetingDate').valueAsDate = new Date();
            // Set tanggal default untuk form perencanaan
            if (document.getElementById('planDate')) {
                 document.getElementById('planDate').valueAsDate = new Date();
            }
        }
        
        salesFilter.innerHTML = filterOptionsHtml;
        
        // Atur filter tanggal default (Tahun Ini)
        const periodButton = globalPeriodFilters.querySelector('[data-period="this-year"]'); // <--- Ganti 'this-month' jadi 'this-year'
        if (periodButton) {
            globalPeriodFilters.querySelector('.active')?.classList.remove('active');
            periodButton.classList.add('active');
        }

        // Atur Kalender ke Bulan Januari tahun ini (opsional, atau biarkan default today)
        const today = new Date();
        currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
        
        renderFilteredDashboard();
    }
    // Fungsi untuk mengambil rentang tanggal filter
    function getFilterDates() {
        const selectedPeriod = globalPeriodFilters.querySelector('.active')?.dataset.period;
        const today = new Date();
        let startDate, endDate, prevStartDate, prevEndDate;
        
        today.setHours(0, 0, 0, 0);

        if (selectedPeriod === 'this-week') {
            const firstDayOfWeek = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1); 
            startDate = new Date(new Date(today).setDate(firstDayOfWeek));
            endDate = new Date(new Date(startDate).setDate(startDate.getDate() + 6));
            prevStartDate = new Date(new Date(startDate).setDate(startDate.getDate() - 7));
            prevEndDate = new Date(new Date(endDate).setDate(endDate.getDate() - 7));

        } else if (selectedPeriod === 'this-month') {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            prevStartDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            prevEndDate = new Date(today.getFullYear(), today.getMonth(), 0);

        } else if (selectedPeriod === 'this-year') { 
            // --- LOGIKA BARU: TAHUN INI ---
            // Mulai: 1 Januari tahun ini
            startDate = new Date(today.getFullYear(), 0, 1); 
            // Akhir: 31 Desember tahun ini
            endDate = new Date(today.getFullYear(), 11, 31);
            
            // Periode Sebelumnya: Tahun Lalu (Jan - Des)
            prevStartDate = new Date(today.getFullYear() - 1, 0, 1);
            prevEndDate = new Date(today.getFullYear() - 1, 11, 31);

        } else if (selectedPeriod === 'custom') { 
            startDate = new Date(startDateInput.value);
            endDate = new Date(endDateInput.value);
             if (!startDateInput.value || !endDateInput.value || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return { startDate: null, endDate: null, prevStartDate: null, prevEndDate: null }; 
            }
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            
            const diffDays = Math.round((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
            prevStartDate = new Date(new Date(startDate).setDate(startDate.getDate() - diffDays - 1));
            prevEndDate = new Date(new Date(startDate).setDate(startDate.getDate() - 1));

            prevStartDate.setHours(0, 0, 0, 0);
        } else {
             return { startDate: null, endDate: null, prevStartDate: null, prevEndDate: null }; 
        }
        
        if(endDate && !isNaN(endDate)) endDate.setHours(23, 59, 59, 999);
        if(prevEndDate && !isNaN(prevEndDate)) prevEndDate.setHours(23, 59, 59, 999);

        return { startDate, endDate, prevStartDate, prevEndDate };
    }

// ==========================================
// --- MODULE: CLIENT ANALYTIC (FIXED & FINAL) ---
// ==========================================

// 1. VARIABLE GLOBAL CLIENT ANALYTIC
let portfolioCurrentPage = 1;
const PORTFOLIO_PER_PAGE = 8;
let portfolioDataGlobal = [];
let reactivationCurrentPage = 1;
const REACTIVATION_PER_PAGE = 10; // Menampilkan 10 baris per halaman
let reactivationDataGlobal = []; // Menyimpan seluruh data tanpa limit
let reactivationSearchTerm = ''; // Variabel untuk menyimpan text search 

// 2. FUNGSI UTAMA: MENGOLAH DATA CLIENT ANALYTIC
// 2. FUNGSI UTAMA: MENGOLAH DATA CLIENT ANALYTIC

function renderBuyerAnalytics(allDeals, salesToDisplay) {

    const uniqueProjectsMap = new Map();

    const allowedSalesNormalized = salesToDisplay.map(s => (s || '').trim().toLowerCase());



    // A. Filter & Deduplikasi Data (Ambil Status Terakhir per Project)

    allDeals.forEach(deal => {

        const dealSalesName = (deal.sales || '').trim().toLowerCase();

        if (!allowedSalesNormalized.includes(dealSalesName)) return;



        let uniqueKey = deal.projectGUID;

        if (!uniqueKey && deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) uniqueKey = "rfq_" + deal.nomorRFQ.trim();

        if (!uniqueKey) {

            const cleanClient = (deal.client || '').trim().toLowerCase();

            const cleanProject = (deal.namaProject || '').trim().toLowerCase();

            uniqueKey = cleanClient + "_" + cleanProject;

        }



        const existing = uniqueProjectsMap.get(uniqueKey);

        if (!existing || deal.meetingDateObj.getTime() >= existing.meetingDateObj.getTime()) {

            uniqueProjectsMap.set(uniqueKey, deal);

        }

    });



    // B. Aggregasi Data Per Klien

    const clientStats = {};

    const currentYear = new Date().getFullYear();

const lastYear = currentYear - 1;

const yearBeforeLast = currentYear - 2;

    const today = new Date();



    uniqueProjectsMap.forEach(deal => {

        const clientName = deal.client;

        if (!clientStats[clientName]) {

            clientStats[clientName] = {

                name: clientName,

                sales: deal.sales,

                revTotal: 0,

                revCurrentYear: 0,

                revLastYear: 0,

revYearBeforeLast: 0,

                freqCurrentYear: 0,

                pipelineValue: 0,

                programsBought: new Set(),

                lastOrderDate: null,

                projectList: []

            };

        }



        const stats = clientStats[clientName];



        // Simpan Detail Project

        stats.projectList.push({

            name: deal.namaProject || '(Tanpa Nama)',

            amount: parseInt(deal.value) || 0,

            date: deal.meetingDateObj,

            status: deal.meetingType,

            program: deal.programChampion

        });



        // Cek Tanggal Terakhir

        const dDate = deal.meetingDateObj;

        if (!stats.lastOrderDate || dDate > stats.lastOrderDate) {

            stats.lastOrderDate = dDate;

        }



        // Catat Program

        let prog = deal.programChampion;

        if (prog && !prog.includes("Pilih") && prog !== "Non-Program" && prog.trim() !== "") {

            stats.programsBought.add(prog);

        }



        const status = deal.meetingType;

        const val = parseInt(deal.value) || 0;



        // Hitung Pipeline

        if (['Awareness', 'Interest', 'Desire', 'Process Closing'].includes(status)) {

            stats.pipelineValue += val;

        }



        // Hitung Revenue & Frekuensi

        if (['Action', 'Delivery', 'Payment'].includes(status)) {

            stats.revTotal += val;

            const dealYear = deal.meetingDateObj.getFullYear();



            if (dealYear === currentYear) {

    stats.revCurrentYear += val;

    stats.freqCurrentYear += 1;

}

else if (dealYear === lastYear) {

    stats.revLastYear += val;

}

else if (dealYear === yearBeforeLast) {

    stats.revYearBeforeLast += val; // Masukkan pendapatan tahun sebelumnya lagi

}

}

    });



    // C. Klasifikasi Tipe Account & List

    let keyAccounts = [], activeAccounts = [], potentialClients = [];

    let incubatorCandidates = [], milestoneTargets = [];

    let dormantClients = [], reactivationTargets = [];

    let clientsAchievedMilestone = 0;

    const MILESTONE_TARGET = 500000000;



    Object.values(clientStats).forEach(client => {

        let type = 'Potential';

        // [LOGIKA BARU 1] Key Account: Wajib >1M di 2 Tahun Berturut

        // Definisi baru: Dia adalah Champion jika tahun-tahun sebelumnya sudah mencapai target 1M

const wasChampionBefore = (client.revLastYear >= 1000000000 && client.revYearBeforeLast >= 1000000000);



// Atau dia baru mencapai status Champion di tahun berjalan ini

const isNewChampion = (client.revCurrentYear >= 1000000000 && client.revLastYear >= 1000000000);



if (wasChampionBefore || isNewChampion) {

    type = 'Key Account';

}

else if (client.revCurrentYear > 0) {

            type = 'Account';

        }

        client.type = type;



        if (type === 'Key Account') keyAccounts.push(client);

        else if (type === 'Account') activeAccounts.push(client);

        else potentialClients.push(client);

// --- START: Tambahan Kode untuk Metrik Baru ---



// --- MULAI PERBAIKAN LOGIKA CARD POTENTIAL ---



// 1. Hitung Metric: Total New Clients in Pipeline (Belum pernah closing seumur hidup)

const newClientsInPipeline = potentialClients.filter(client => client.revTotal === 0);

const totalNewClientsInPipeline = newClientsInPipeline.length;



// 2. Hitung Metric: Total Client Tidur (Sleeper Clients)

// Logika: Pernah closing (revTotal > 0) tapi lastOrderDate > 180 hari yang lalu

const todayDateForCalc = new Date();

const sleeperClientsList = [];



Object.values(clientStats).forEach(client => {

    if (client.revTotal > 0 && client.lastOrderDate) {

        const diffTime = Math.abs(todayDateForCalc - client.lastOrderDate);

        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays > 180) {

            sleeperClientsList.push(client);

        }

    }

});
const totalSleeperClients = sleeperClientsList.length;

// --- END: Tambahan Kode untuk Metrik Baru ---
        // [LOGIKA BARU 2] Incubator Focus (Sesuai Request)
        if (type !== 'Key Account') {
            const condRevenue = client.revCurrentYear > 500000000; // > 500Jt
            const condFreq = client.freqCurrentYear >= 3; // Min 3x Order
            // Orderan berapapun yg deal tahun ini + Pipeline > 500Jt
            const condPotential = (client.revCurrentYear > 0 && client.pipelineValue > 500000000);

            if (condRevenue || condFreq || condPotential) {
                incubatorCandidates.push(client);
            }
        }

        // Milestone 500 Juta
        if (client.revCurrentYear > 0) {
            milestoneTargets.push(client);
            if (client.revCurrentYear >= MILESTONE_TARGET) clientsAchievedMilestone++;
        }

        // Dormant / Tidur
        if ((type === 'Key Account' || type === 'Account') && client.lastOrderDate) {
            const diffTime = Math.abs(today - client.lastOrderDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            client.dormantDays = diffDays;
            if (diffDays > 90) dormantClients.push(client);
            if (diffDays > 180 && client.revTotal > 0) reactivationTargets.push(client);
        }
    });

    const totalMilestoneTargets = milestoneTargets.length;
    let achievementPercent = totalMilestoneTargets > 0 ? (clientsAchievedMilestone / totalMilestoneTargets) * 100 : 0;

    // --- D. RENDER LIST KE UI ---

    // 1. Milestone Header & List
    const milestoneCard = document.querySelector('#manager-tab-panel-5 > div:first-child > div:nth-child(3)');
    if (milestoneCard) {
        const oldHeader = milestoneCard.querySelector('.flex.justify-between');
        if (oldHeader) {
            oldHeader.outerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-white">Target Milestone</h3>
                        <p class="text-xs text-gray-400">Menuju Rp 500 Juta / Tahun</p>
                    </div>
                    <div class="text-right">
                        <i data-lucide="target" class="w-5 h-5 text-emerald-400 mb-1 inline-block"></i>
                        <div class="text-sm font-bold text-emerald-400 leading-none">${Math.round(achievementPercent)}%</div>
                        <p class="text-[9px] text-gray-500 mt-1">${clientsAchievedMilestone}/${totalMilestoneTargets} Klien</p>
                    </div>
                </div>`;
        }
    }
    const targetChartEl = document.getElementById('targetTrackingChart');
    if (targetChartEl) {
        milestoneTargets.sort((a, b) => b.revCurrentYear - a.revCurrentYear);
        if (milestoneTargets.length === 0) {
            targetChartEl.innerHTML = '<p class="text-center text-gray-500 py-4 text-xs">Belum ada revenue tercatat tahun ini.</p>';
        } else {
            targetChartEl.innerHTML = milestoneTargets.map(c => {
                const percent = (c.revCurrentYear / MILESTONE_TARGET) * 100;
                const isAchieved = c.revCurrentYear >= MILESTONE_TARGET;
                const barColor = isAchieved ? 'bg-emerald-500' : (percent > 50 ? 'bg-blue-500' : 'bg-gray-600');
                return `
                    <div class="mb-3 hover:bg-gray-700/30 p-1 rounded transition">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-white truncate w-1/2" title="${c.name}">${c.name} ${isAchieved ? '✅' : ''}</span>
                            <span class="font-mono text-gray-300 text-right w-1/2">${formatIDRShort(c.revCurrentYear)}</span>
                        </div>
                        <div class="h-2 w-full bg-gray-700 rounded-full overflow-hidden">
                            <div class="${barColor} h-full rounded-full transition-all duration-1000" style="width: ${Math.min(percent, 100)}%"></div>
                        </div>
                    </div>`;
            }).join('');
        }
    }

// 2. Key Account List
const keyAccountContainer = document.getElementById('keyAccountListContainer');
const keyBadge = document.getElementById('badgeKeyAccountCount');

if (keyAccountContainer) {
    // Urutkan Champion berdasarkan pencapaian tahun ini (YTD)
    keyAccounts.sort((a, b) => b.revCurrentYear - a.revCurrentYear);
    if(keyBadge) keyBadge.textContent = keyAccounts.length;

    if (keyAccounts.length === 0) {
        keyAccountContainer.innerHTML = '<p class="text-xs text-gray-500 italic p-2 text-center">Belum ada Key Account.</p>';
    } else {
        keyAccountContainer.innerHTML = keyAccounts.map((c, i) => {
            // Logika Penentuan Status
            const hasDeal = c.revCurrentYear > 0;
            const hasPipeline = c.pipelineValue > 0;

            let statusColorClass = "bg-gray-900/40 border-gray-700/50"; // Default
            let statusIcon = "crown";
            let statusText = "Active Champion";
            let iconColor = "text-yellow-400";
            let borderColor = "border-gray-700/50";
            let pulseClass = "";

            // Jika Belum Deal DAN Tidak Ada Pipeline (Kritis)
            if (!hasDeal && !hasPipeline) {
                statusColorClass = "bg-red-900/10";
                borderColor = "border-red-500/40";
                statusIcon = "alert-circle";
                statusText = "No Activity (Critical)";
                iconColor = "text-red-500";
                pulseClass = "animate-pulse";
            } 
            // Jika Belum Deal tapi SUDAH ada Pipeline (Proses)
            else if (!hasDeal && hasPipeline) {
                statusColorClass = "bg-orange-900/10";
                borderColor = "border-orange-500/40";
                statusIcon = "clock";
                statusText = "In Pipeline";
                iconColor = "text-orange-400";
            }

            return `
                <div class="flex items-center justify-between ${statusColorClass} p-3 rounded border ${borderColor} mb-2 hover:bg-gray-700 transition ${pulseClass}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="flex-shrink-0 ${hasDeal ? 'bg-yellow-500/10' : 'bg-gray-500/10'} p-2 rounded-full border border-gray-700/50">
                            <i data-lucide="${statusIcon}" class="w-4 h-4 ${iconColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-bold text-white truncate" title="${c.name}">${i+1}. ${c.name}</p>
                            <div class="flex items-center gap-1">
                                <p class="text-[9px] uppercase tracking-wider ${iconColor} font-bold">${statusText}</p>
                                <span class="text-[9px] text-gray-500">• ${c.sales}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold ${hasDeal ? 'text-yellow-400' : 'text-gray-400'} font-mono">
                            ${formatIDRShort(c.revCurrentYear)}
                        </p>
                        <p class="text-[10px] text-gray-500">YTD Revenue</p>
                    </div>
                </div>
            `;
        }).join('');
    }
}

    // 3. Incubator Focus List
    const incubatorContainer = document.getElementById('incubatorList');
    const incBadge = document.getElementById('badgeIncubatorCount');
    if (incubatorContainer) {
        incubatorCandidates.sort((a, b) => b.revCurrentYear - a.revCurrentYear);
        if(incBadge) incBadge.textContent = incubatorCandidates.length;

        if (incubatorCandidates.length === 0) {
            incubatorContainer.innerHTML = '<div class="text-center py-4 px-2"><p class="text-xs text-indigo-300">Belum ada kandidat inkubasi.</p></div>';
        } else {
            incubatorContainer.innerHTML = incubatorCandidates.map(c => {
                let reason = [];
                if(c.revCurrentYear > 500000000) reason.push("Rev >500Jt");
                if(c.freqCurrentYear >= 3) reason.push("Freq >3x");
                if(c.revCurrentYear > 0 && c.pipelineValue > 500000000) reason.push("High Pipe");
                
                return `
                <div class="bg-indigo-900/60 p-3 rounded border border-indigo-500/40 mb-2 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm font-bold text-white truncate w-2/3" title="${c.name}">${c.name}</span>
                        <span class="text-xs font-mono text-indigo-200 font-bold">${formatIDRShort(c.revCurrentYear)}</span>
                    </div>
                    <div class="flex items-center justify-between text-[10px] text-indigo-300 mb-2">
                        <span class="bg-indigo-800 px-1.5 py-0.5 rounded border border-indigo-700">${reason[0] || 'Potential'}</span>
                        <span class="flex items-center gap-1"><i data-lucide="layers" class="w-3 h-3"></i> Pipe: ${formatIDRShort(c.pipelineValue)}</span>
                    </div>
                    <div class="w-full bg-indigo-950 rounded-full h-1.5">
                        <div class="bg-indigo-400 h-1.5 rounded-full" style="width: ${Math.min((c.revCurrentYear/1000000000)*100, 100)}%"></div>
                    </div>
                </div>
            `;}).join('');
        }
    }

    // 4. Render Sisa Tabel & Metrik
    const sumRev = (arr) => arr.reduce((a, b) => a + b.revTotal, 0); 
const sumRevYTD = (arr) => arr.reduce((a, b) => a + b.revCurrentYear, 0); // Tambahkan helper baru untuk YTD

if(document.getElementById('metricKeyAccountCount')) {
    document.getElementById('metricKeyAccountCount').textContent = keyAccounts.length;
    document.getElementById('metricKeyAccountRev').textContent = formatIDRShort(sumRevYTD(keyAccounts)); // Ubah ke sumRevYTD (Opsional)
    
    document.getElementById('metricActiveAccountCount').textContent = activeAccounts.length;
    // PENTING: Gunakan sumRevYTD agar angka Rupiah sesuai dengan filter "Tahun Berjalan"
    document.getElementById('metricActiveAccountRev').textContent = formatIDRShort(sumRevYTD(activeAccounts)); 
    
    document.getElementById('metricPotentialCount').textContent = potentialClients.length;
}

    portfolioDataGlobal = [...keyAccounts, ...activeAccounts].sort((a, b) => b.revTotal - a.revTotal);
    renderPortfolioTable(); 
    
    dormantClients.sort((a, b) => b.dormantDays - a.dormantDays);
    renderRetentionTable(dormantClients);
    
    reactivationTargets.sort((a, b) => b.revTotal - a.revTotal);
    renderReactivationTable(reactivationTargets);

    lucide.createIcons();
}

// 3. FUNGSI HELPER: RENDER TABEL PORTFOLIO
function renderPortfolioTable() {
    const tableBody = document.getElementById('buyerPortfolioBody');
    const paginationContainer = document.getElementById('buyerPortfolioPagination');
    
    if (!tableBody) return;

    const totalItems = portfolioDataGlobal.length;
    const totalPages = Math.ceil(totalItems / PORTFOLIO_PER_PAGE);
    
    if (portfolioCurrentPage > totalPages && totalPages > 0) portfolioCurrentPage = totalPages;
    if (portfolioCurrentPage < 1) portfolioCurrentPage = 1;

    const start = (portfolioCurrentPage - 1) * PORTFOLIO_PER_PAGE;
    const pagedData = portfolioDataGlobal.slice(start, start + PORTFOLIO_PER_PAGE);

    if (pagedData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">Belum ada data klien active/key account.</td></tr>`;
        if(paginationContainer) paginationContainer.innerHTML = '';
        return;
    }

    tableBody.innerHTML = pagedData.map((client, index) => {
        const uniqueId = `client_row_${index}`; 
        const typeClass = client.type === 'Key Account' 
            ? 'bg-purple-900 text-purple-300 border border-purple-700' 
            : 'bg-blue-900 text-blue-300 border border-blue-700';
        
        const progCount = client.programsBought.size;
        let crossSellBadge = '';
        if (progCount > 1) {
            crossSellBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-900 text-emerald-300 border border-emerald-700">CROSS-SOLD (${progCount})</span>`;
        } else {
            crossSellBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-medium bg-gray-700 text-gray-400">SINGLE PROD</span>`;
        }

        const sortedProjects = client.projectList.sort((a,b) => b.date - a.date);
        const projectDetailsHTML = sortedProjects.map(p => `
            <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                <td class="py-2 px-4 text-xs text-white">${p.name}</td>
                <td class="py-2 px-4 text-xs text-gray-400">${p.date ? p.date.toLocaleDateString('id-ID') : '-'}</td>
                <td class="py-2 px-4 text-xs font-mono text-gray-300">${formatIDRShort(p.amount)}</td>
                <td class="py-2 px-4 text-xs">
                    <span class="status-label status-${(p.status||'').replace(/\s/g,'')} scale-75 origin-left">${p.status}</span>
                </td>
            </tr>
        `).join('');

        return `
            <tr class="hover:bg-gray-750 transition-colors cursor-pointer group border-b border-gray-700" onclick="toggleClientRow('${uniqueId}')">
                <td class="px-4 py-3 text-sm font-medium text-white">${client.name}</td>
                <td class="px-4 py-3 text-xs"><span class="px-2 py-1 rounded ${typeClass} font-semibold">${client.type}</span></td>
                <td class="px-4 py-3">${crossSellBadge}</td>
                <td class="px-4 py-3 text-sm font-mono text-gray-300">${formatIDRShort(client.revTotal)}</td>
                <td class="px-4 py-3 text-xs text-center text-gray-400">
                    <span class="bg-gray-700 px-2 py-1 rounded text-white font-bold">${client.projectList.length}</span> Project
                </td>
                <td class="px-4 py-3 text-center">
                    <i id="icon_${uniqueId}" data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform duration-300"></i>
                </td>
            </tr>
            <tr id="${uniqueId}" class="hidden bg-gray-800/50 inset-shadow">
                <td colspan="6" class="p-0">
                    <div class="p-4 border-l-4 border-blue-500 ml-4 my-2 bg-gray-900/50 rounded-r-lg">
                        <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Riwayat Deal Project:</h4>
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-xs text-gray-500 border-b border-gray-700">
                                    <th class="pb-2 px-4">Nama Project</th>
                                    <th class="pb-2 px-4">Tanggal</th>
                                    <th class="pb-2 px-4">Amount</th>
                                    <th class="pb-2 px-4">Status</th>
                                </tr>
                            </thead>
                            <tbody>${projectDetailsHTML}</tbody>
                        </table>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    if (paginationContainer) {
         if (totalPages > 1) {
            paginationContainer.innerHTML = `
                <button id="portfolioPrevBtn" class="px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 text-xs disabled:opacity-50" ${portfolioCurrentPage === 1 ? 'disabled' : ''}><i class="h-4 w-4" data-lucide="chevron-left"></i></button>
                <span class="text-xs text-gray-400 py-1">Hal ${portfolioCurrentPage}/${totalPages}</span>
                <button id="portfolioNextBtn" class="px-2 py-1 bg-gray-700 rounded hover:bg-gray-600 text-xs disabled:opacity-50" ${portfolioCurrentPage >= totalPages ? 'disabled' : ''}><i class="h-4 w-4" data-lucide="chevron-right"></i></button>
            `;
        } else {
            paginationContainer.innerHTML = '';
        }
    }
    lucide.createIcons();
}

// 4. FUNGSI HELPER TOGGLE
window.toggleClientRow = (id) => {
    const row = document.getElementById(id);
    const icon = document.getElementById('icon_' + id);
    
    if (row.classList.contains('hidden')) {
        row.classList.remove('hidden');
        if(icon) icon.style.transform = 'rotate(180deg)';
    } else {
        row.classList.add('hidden');
        if(icon) icon.style.transform = 'rotate(0deg)';
    }
};

// 5. FUNGSI HELPER RETENTION TABLE
function renderRetentionTable(dormantClients) {
    const tableBody = document.getElementById('buyerRetentionBody');
    if (!tableBody) return;

    if (!dormantClients || dormantClients.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-green-400 py-4 font-medium"><i data-lucide="check-circle" class="inline w-4 h-4 mr-1"></i> Aman! Tidak ada klien tidur > 3 bulan.</td></tr>`;
        lucide.createIcons();
        return;
    }

    const topDormant = dormantClients.slice(0, 10);
    tableBody.innerHTML = topDormant.map(client => {
        const dateStr = client.lastOrderDate ? client.lastOrderDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-';
        return `
            <tr>
                <td class="px-4 py-3 text-sm font-medium text-white">${client.name}</td>
                <td class="px-4 py-3 text-sm text-gray-300">${client.sales}</td>
                <td class="px-4 py-3 text-xs text-gray-400">${dateStr}</td>
                <td class="px-4 py-3 text-sm font-bold text-red-400">${client.dormantDays} Hari</td>
                <td class="px-4 py-3 text-xs">
                     <button class="bg-blue-900 hover:bg-blue-800 text-blue-200 px-2 py-1 rounded transition border border-blue-700">Follow Up</button>
                </td>
            </tr>
        `;
    }).join('');
    lucide.createIcons();
}

// 6. FUNGSI HELPER REAKTIVASI TABLE (FINAL: History untuk Semua, Aksi hanya Sales)
function renderReactivationTable(targets) {
    const tableBody = document.getElementById('reactivationTableBody');
    const badgeCount = document.getElementById('reactivationCountBadge');
    
    if (!tableBody) return;

    // 1. Simpan ke Global jika ada data baru masuk
    if (targets) reactivationDataGlobal = targets;

    // --- LOGIKA FILTER SEARCH BARU ---
    // Filter data global berdasarkan search term sebelum dipaginasi
    let filteredData = reactivationDataGlobal;
    
    if (reactivationSearchTerm && reactivationSearchTerm.trim() !== '') {
        filteredData = reactivationDataGlobal.filter(item => {
            const nameMatch = (item.name || '').toLowerCase().includes(reactivationSearchTerm);
            const salesMatch = (item.sales || '').toLowerCase().includes(reactivationSearchTerm);
            return nameMatch || salesMatch;
        });
    }
    // ---------------------------------

    // Update Badge dengan jumlah setelah difilter
    if (badgeCount) badgeCount.textContent = `${filteredData.length} Akun`;

    // 2. Logika Pagination (Gunakan filteredData, bukan reactivationDataGlobal)
    const totalItems = filteredData.length;
    const totalPages = Math.ceil(totalItems / REACTIVATION_PER_PAGE);

    if (reactivationCurrentPage > totalPages && totalPages > 0) reactivationCurrentPage = totalPages;
    if (reactivationCurrentPage < 1) reactivationCurrentPage = 1;

    const startIndex = (reactivationCurrentPage - 1) * REACTIVATION_PER_PAGE;
    const endIndex = startIndex + REACTIVATION_PER_PAGE;
    
    const pagedData = filteredData.slice(startIndex, endIndex);

    if (totalItems === 0) {
        // Pesan beda jika kosong karena search atau memang kosong datanya
        if (reactivationSearchTerm) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4 font-medium">Tidak ditemukan klien dengan nama "${reactivationSearchTerm}".</td></tr>`;
        } else {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4 font-medium">Tidak ada akun tidur yang signifikan saat ini.</td></tr>`;
        }
        
        // Hapus pagination jika kosong
        const pagContainer = document.getElementById('reactivationPaginationContainer');
        if(pagContainer) pagContainer.innerHTML = '';
        
        return;
    }

    // 3. Render Baris Tabel
    tableBody.innerHTML = pagedData.map(client => {
        const dateStr = client.lastOrderDate ? client.lastOrderDate.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-';
        
        let priorityLabel = '';
        if (client.revTotal > 500000000) { 
            priorityLabel = '<span class="text-[10px] bg-red-900 text-red-200 px-2 py-0.5 rounded border border-red-700 ml-2">High Priority</span>';
        } else if (client.revTotal > 100000000) {
            priorityLabel = '<span class="text-[10px] bg-orange-900 text-orange-200 px-2 py-0.5 rounded border border-orange-700 ml-2">Medium</span>';
        }

        const safeName = client.name.replace(/'/g, "\\'");

        // Tombol Aksi (Hanya SALES)
        let actionButtonHtml = '';
        if (currentRole === 'sales') {
            actionButtonHtml = `
                <button onclick="window.activateSleeperClient('${safeName}')" 
                        class="bg-orange-700 hover:bg-orange-600 text-white text-xs px-3 py-1.5 rounded transition shadow flex items-center justify-center mx-auto border border-orange-600">
                   <i data-lucide="zap" class="w-3 h-3 mr-1"></i> Aktifkan
                </button>
            `;
        } else {
            actionButtonHtml = `<span class="text-[10px] text-gray-600 italic">View Only</span>`;
        }

        return `
            <tr class="hover:bg-gray-700/50 transition-colors border-b border-gray-700">
                <td class="px-4 py-3">
                    <div class="text-sm font-bold text-blue-400 hover:text-blue-300 cursor-pointer flex items-center underline decoration-dotted underline-offset-4" 
                         onclick="window.showClientHistory('${safeName}')" title="Klik untuk lihat history project">
                        ${client.name} ${priorityLabel}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">${client.sales}</td>
                <td class="px-4 py-3 text-sm font-mono text-emerald-400 font-semibold">${formatIDRShort(client.revTotal)}</td>
                <td class="px-4 py-3 text-xs text-gray-400">${dateStr}</td>
                <td class="px-4 py-3">
                    <span class="text-sm font-bold text-red-400">${client.dormantDays} Hari</span>
                    <span class="text-[10px] text-gray-500 block">Vakum</span>
                </td>
                <td class="px-4 py-3 text-center">
                     ${actionButtonHtml}
                </td>
            </tr>
        `;
    }).join('');

    // 4. Render Pagination Controls
    let pagContainer = document.getElementById('reactivationPaginationContainer');
    if (!pagContainer) {
        const tableParent = tableBody.closest('.overflow-x-auto');
        if (tableParent) {
            pagContainer = document.createElement('div');
            pagContainer.id = 'reactivationPaginationContainer';
            pagContainer.className = 'flex justify-between items-center mt-4 pt-2 border-t border-gray-700 px-4 pb-2';
            tableParent.appendChild(pagContainer);
        }
    }

    if (pagContainer) {
        if (totalItems > REACTIVATION_PER_PAGE) {
            pagContainer.innerHTML = `
                <span class="text-xs text-gray-400">Total: ${totalItems} Klien</span>
                <div class="flex items-center gap-2">
                    <button onclick="window.changeReactivationPage(-1)" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed transition" ${reactivationCurrentPage === 1 ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-left"></i>
                    </button>
                    <span class="text-xs text-gray-300 font-medium px-2">Hal ${reactivationCurrentPage} / ${totalPages}</span>
                    <button onclick="window.changeReactivationPage(1)" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed transition" ${reactivationCurrentPage >= totalPages ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-right"></i>
                    </button>
                </div>
            `;
        } else {
            pagContainer.innerHTML = '';
        }
    }

    lucide.createIcons();
}

// --- MODULE: PROJECT ANALYTIC (DIPERBAIKI: FILTER SALES) ---
function renderProjectAnalytics(allDeals, salesToDisplay) {
    // 1. Validasi Filter Sales
    if (!Array.isArray(salesToDisplay) || salesToDisplay.length === 0) {
        return; 
    }

    // Normalisasi list sales agar pencocokan nama akurat
    const allowedSales = salesToDisplay.map(s => s.trim().toLowerCase());
    
    // Normalisasi Capability Tab yang sedang dipilih (huruf kecil semua)
    // Pastikan variabel global 'currentProjectCapability' sudah ada (default: 'IT Outsourcing')
    const targetCapability = currentProjectCapability.trim().toLowerCase();

    // 2. Grouping Data per Project
    const projectGroups = new Map();
    
    // === PERBAIKAN FILTER (STRICT MODE) ===
    const validDeals = allDeals.filter(deal => {
        // A. Validasi Data Dasar
        if (!deal.sales || !deal.meetingDateObj) return false;
        
        // B. Filter Sales (Cek apakah deal ini milik sales yang sedang dilihat)
        const dealSales = deal.sales.trim().toLowerCase();
        if (!allowedSales.includes(dealSales)) return false;

        // C. Filter Capability (Sub-Tab) - INI YANG DIPERBAIKI
        // Ambil capability dari data deal, ubah ke huruf kecil, hapus spasi
        const dealCap = (deal.capability || '').trim().toLowerCase();

        // Logika Pengecekan Ketat:
        if (targetCapability === 'siplah') {
            // Jika Tab SIPLah: Data HARUS mengandung kata 'siplah'
            return dealCap.includes('siplah');
        } else if (targetCapability === 'it outsourcing') {
            // Jika Tab IT Outsourcing: Data HARUS mengandung 'outsourcing' ATAU sama persis 'it outsourcing'
            // DAN TIDAK BOLEH mengandung 'siplah' (untuk mencegah data ganda jika input user aneh)
            return dealCap.includes('outsourcing') && !dealCap.includes('siplah');
        }

        // Fallback: Jika capability di sub-tab lain, gunakan perbandingan langsung
        return dealCap === targetCapability;
    });
    // ==========================================

    // Jika data kosong setelah difilter
    if (validDeals.length === 0) {
        renderScatterChart([]);
        renderDurationTable([]); 
        renderFrequencyTable([]);
        generateRecommendations([]);
        
        // Tampilkan pesan kosong di tabel agar user sadar filter berjalan
        const tbody = document.getElementById('projectDurationTableBody');
        if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500 italic">Tidak ada data leads untuk kategori <b>${currentProjectCapability}</b>.</td></tr>`;
        return;
    }

    // 3. Kalkulasi Data (Logika ini tidak berubah)
    validDeals.forEach(deal => {
        // Gunakan ProjectGUID atau Fallback agar unik
        let key = deal.projectGUID;
        if (!key && deal.nomorRFQ && deal.nomorRFQ.length > 2) key = "rfq_" + deal.nomorRFQ;
        if (!key) key = (deal.client + "_" + deal.namaProject).trim().toLowerCase();

        if (!projectGroups.has(key)) {
            projectGroups.set(key, {
                key: key, // <--- TAMBAHAN PENTING: Simpan Key Unik
                client: deal.client,
                project: deal.namaProject,
                sales: deal.sales,
                amount: parseInt(deal.value) || 0,
                activities: [],
                status: 'Awareness'
            });
        }
        const group = projectGroups.get(key);
        const currentVal = parseInt(deal.value) || 0;
        if (currentVal > group.amount) group.amount = currentVal;
        
        group.activities.push({
            date: deal.meetingDateObj,
            type: deal.meetingType
        });
    });

    // 4. Finalisasi Data Array
    const analyticsData = [];
    projectGroups.forEach((group, key) => {
        group.activities.sort((a, b) => a.date - b.date);
        if (group.activities.length === 0) return;

        const firstActivity = group.activities[0];
        const lastActivity = group.activities[group.activities.length - 1];
        const durationMs = lastActivity.date - firstActivity.date;
        const durationDays = Math.floor(durationMs / (1000 * 60 * 60 * 24)); 

        analyticsData.push({
            ...group,
            startDate: firstActivity.date,
            lastDate: lastActivity.date,
            duration: durationDays,
            lastStatus: lastActivity.type,
            activityCount: group.activities.length
        });
    });

    // 5. Render ke Layar
    renderScatterChart(analyticsData);
    renderDurationTable(analyticsData); // Tabel Leads otomatis terisi data yang sudah difilter
    renderFrequencyTable(analyticsData);
    generateRecommendations(analyticsData);
}

function renderScatterChart(data) {
    const ctx = document.getElementById('projectScatterChart')?.getContext('2d');
    if (!ctx) return;
    
    if (charts.projectScatter) {
        charts.projectScatter.destroy();
    }

    const wonData = [];
    const lostData = [];
    const openData = [];

    // --- 1. Persiapan Data & Hitung Rata-rata ---
    let totalActivity = 0;
    let totalAmount = 0;
    let count = 0;

    data.forEach(item => {
        // [PERBAIKAN 1] Tambahkan properti 'key' ke dalam titik data grafik
        const point = { 
            x: item.activityCount, 
            y: item.amount, 
            label: item.client + ' - ' + item.project,
            key: item.key // <--- PENTING: Kunci untuk popup
        };
        
        if (['Action', 'Delivery', 'Payment'].includes(item.lastStatus)) wonData.push(point);
        else if (item.lastStatus === 'Lost') lostData.push(point);
        else openData.push(point);

        totalActivity += item.activityCount;
        totalAmount += item.amount;
        count++;
    });

    const avgActivity = count > 0 ? totalActivity / count : 0;
    const avgAmount = count > 0 ? totalAmount / count : 0;

    // --- 2. Plugin Custom Background (Kode Lama) ---
    const backgroundQuadrants = {
        id: 'backgroundQuadrants',
        beforeDraw: (chart, args, options) => {
            const {ctx, chartArea: {top, right, bottom, left, width, height}, scales: {x, y}} = chart;
            const midX = x.getPixelForValue(avgActivity);
            const midY = y.getPixelForValue(avgAmount);

            ctx.save();
            // Zona Hijau
            ctx.fillStyle = 'rgba(16, 185, 129, 0.1)';
            ctx.fillRect(left, top, midX - left, midY - top);
            ctx.font = 'bold 12px Inter';
            ctx.fillStyle = 'rgba(16, 185, 129, 0.6)';
            ctx.fillText("High Value / Low Effort (Efficient)", left + 10, top + 20);

            // Zona Merah
            ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
            ctx.fillRect(midX, midY, right - midX, bottom - midY);
            ctx.font = 'bold 12px Inter';
            ctx.fillStyle = 'rgba(239, 68, 68, 0.6)';
            ctx.textAlign = 'right';
            ctx.fillText("Low Value / High Effort (Inefficient)", right - 10, bottom - 10);

            // Garis Pembatas
            ctx.strokeStyle = '#4b5563';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(midX, top);
            ctx.lineTo(midX, bottom);
            ctx.moveTo(left, midY);
            ctx.lineTo(right, midY);
            ctx.stroke();
            ctx.restore();
        }
    };

    // --- 3. Render Chart ---
    charts.projectScatter = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                { label: 'Won', data: wonData, backgroundColor: '#3b82f6', borderColor: '#3b82f6' },
                { label: 'Open', data: openData, backgroundColor: '#eab308', borderColor: '#eab308' },
                { label: 'Lost', data: lostData, backgroundColor: '#ef4444', borderColor: '#ef4444' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            // [PERBAIKAN 2] Menambahkan Interaksi Klik
            onClick: (event, elements, chart) => {
                if (!elements || elements.length === 0) return;

                // Ambil data dari titik yang diklik
                const firstPoint = elements[0];
                const datasetIndex = firstPoint.datasetIndex;
                const index = firstPoint.index;
                const clickedData = chart.data.datasets[datasetIndex].data[index];

                // Panggil fungsi Popup jika key tersedia
                if (clickedData && clickedData.key) {
                    window.showProjectHistory(clickedData.key);
                }
            },
            // [PERBAIKAN 3] Ubah kursor jadi pointer saat hover titik
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: { display: true, text: 'Jumlah Aktivitas (Effort)', color: '#9ca3af' },
                    grid: { color: '#374151' },
                    ticks: { color: '#d1d5db', stepSize: 1 }
                },
                y: {
                    title: { display: true, text: 'Amount (Rp)', color: '#9ca3af' },
                    grid: { color: '#374151' },
                    ticks: { color: '#d1d5db', callback: function(val){ return formatIDRShort(val) } }
                }
            },
            plugins: {
                legend: { labels: { color: '#d1d5db' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.raw.label}: ${context.raw.x}x Akt, ${formatIDRShort(context.raw.y)}`;
                        }
                    }
                },
                zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'xy',
                    }
                }
            }
        },
        plugins: [backgroundQuadrants]
    });
}

function renderDurationTable(data) {
    const tbody = document.getElementById('projectDurationTableBody');
    if (!tbody) return;

    // Urutkan: Prioritas 1 = Durasi (Desc), Prioritas 2 = Jumlah Aktivitas (Desc)
    const sorted = [...data].sort((a, b) => {
        if (b.duration !== a.duration) {
            return b.duration - a.duration; 
        }
        return b.activityCount - a.activityCount;
    }).slice(0, 50); // Ambil Top 50
    
    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data project.</td></tr>';
        return;
    }


    tbody.innerHTML = sorted.map(item => {
        const startStr = item.startDate ? item.startDate.toLocaleDateString('id-ID', {day:'numeric', month:'short'}) : '-';
        const endStr = item.lastDate ? item.lastDate.toLocaleDateString('id-ID', {day:'numeric', month:'short'}) : '-';
        
        let statusColor = 'text-gray-300';
        if(['Action','Delivery','Payment'].includes(item.lastStatus)) statusColor = 'text-blue-400 font-bold';
        else if(item.lastStatus === 'Lost') statusColor = 'text-red-400';
        else statusColor = 'text-yellow-400';

        const isInefficient = item.activityCount > 10 && item.amount < 100000000;
        const rowClass = isInefficient ? 'bg-red-900/10' : 'hover:bg-gray-750';
        const warningIcon = isInefficient ? '<i data-lucide="alert-circle" class="inline w-3 h-3 text-red-400 ml-1" title="High Effort, Low Value"></i>' : '';

        // [PERUBAHAN]: Tambahkan onclick dan cursor-pointer
        // Kita kirim item.key (harus di-escape agar aman jika ada kutip)
        const safeKey = item.key.replace(/'/g, "\\'"); 

        return `
            <tr class="${rowClass} border-b border-gray-700 transition-colors cursor-pointer group" onclick="window.showProjectHistory('${safeKey}')">
                <td class="px-4 py-3 text-xs text-gray-300">${item.sales}</td>
                <td class="px-4 py-3 text-sm font-medium text-white max-w-[200px] truncate group-hover:text-blue-400 transition-colors">
                    ${item.client}<br><span class="text-xs text-gray-400 font-normal">${item.project || '-'}</span>
                </td>
                <td class="px-4 py-3 text-xs ${statusColor}">${item.lastStatus}</td>
                <td class="px-4 py-3 text-xs text-gray-400">${startStr} - ${endStr}</td>
                <td class="px-4 py-3 text-sm font-bold text-center text-white">${item.duration}</td>
                
                <td class="px-4 py-3 text-sm font-bold text-center text-white flex justify-center items-center gap-1">
                    ${item.activityCount}x ${warningIcon}
                    <i data-lucide="external-link" class="w-3 h-3 text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </td>
                
                <td class="px-4 py-3 text-xs text-gray-300 font-mono">${formatIDRShort(item.amount)}</td>
            </tr>
        `;
    }).join('');
    
    // Refresh icon
    lucide.createIcons();
}
// --- FUNGSI BARU: LOGIKA REKOMENDASI ---
function generateRecommendations(data) {
    // Siapkan Container
    const recHighValueEl = document.getElementById('recHighValueList');
    const recStuckEl = document.getElementById('recStuckList');
    const recInefficientEl = document.getElementById('recInefficientList');
    const recClosingEl = document.getElementById('recClosingList');

    if (!recHighValueEl) return;

    // Reset konten
    [recHighValueEl, recStuckEl, recInefficientEl, recClosingEl].forEach(el => el.innerHTML = '');

    // Hitung Rata-rata Amount untuk patokan
    const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);
    const avgAmount = data.length > 0 ? totalAmount / data.length : 0;

    // Filter Data (Hanya yang belum WON/LOST)
    const activeProjects = data.filter(item => 
        !['Action', 'Delivery', 'Payment', 'Lost'].includes(item.lastStatus)
    );

    // 1. HIGH VALUE, LOW ACTIVITY (Potensi Besar)
    const highValue = activeProjects
        .filter(item => item.amount > avgAmount && item.activityCount <= 3)
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 3);

    // 2. STUCK (Lama > 30 hari, masih Awareness/Interest)
    const stuck = activeProjects
        .filter(item => item.duration > 30 && ['Awareness', 'Interest'].includes(item.lastStatus))
        .sort((a, b) => b.duration - a.duration)
        .slice(0, 3);

    // 3. INEFFICIENT (Activity > 8, Amount < Rata-rata)
    const inefficient = activeProjects
        .filter(item => item.activityCount > 8 && item.amount < avgAmount)
        .sort((a, b) => b.activityCount - a.activityCount)
        .slice(0, 3);

    // 4. CLOSING SOON (Desire/Process Closing, Amount Besar)
    const closing = activeProjects
        .filter(item => ['Desire', 'Process Closing'].includes(item.lastStatus))
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 3);

    // --- FUNGSI RENDER ITEM ---
    const renderItem = (item, type) => {
        return `
            <div class="flex justify-between items-center border-b border-gray-700 pb-1 last:border-0 mb-1">
                <div class="truncate w-2/3 pr-2">
                    <p class="font-medium text-white truncate text-[11px]" title="${item.client}">${item.client}</p>
                    <p class="text-gray-500 text-[10px] truncate">${item.project || '-'}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-mono text-gray-300 text-[10px]">${formatIDRShort(item.amount)}</p>
                    <p class="text-[9px] ${type === 'stuck' ? 'text-red-400' : 'text-blue-400'}">
                        ${type === 'stuck' ? item.duration + ' hari' : item.lastStatus}
                    </p>
                </div>
            </div>
        `;
    };

    // --- ISI KONTEN ---
    
    // High Value
    if (highValue.length > 0) recHighValueEl.innerHTML = highValue.map(i => renderItem(i, 'normal')).join('');
    else recHighValueEl.innerHTML = '<p class="text-gray-500 italic">Tidak ada saran saat ini.</p>';

    // Stuck
    if (stuck.length > 0) recStuckEl.innerHTML = stuck.map(i => renderItem(i, 'stuck')).join('');
    else recStuckEl.innerHTML = '<p class="text-gray-500 italic">Pipeline lancar.</p>';

    // Inefisien
    if (inefficient.length > 0) recInefficientEl.innerHTML = inefficient.map(i => renderItem(i, 'normal')).join('');
    else recInefficientEl.innerHTML = '<p class="text-gray-500 italic">Aktivitas efisien.</p>';

    // Closing
    if (closing.length > 0) recClosingEl.innerHTML = closing.map(i => renderItem(i, 'normal')).join('');
    else recClosingEl.innerHTML = '<p class="text-gray-500 italic">Belum ada di tahap akhir.</p>';
}
function renderFrequencyTable(data) {
    const tbody = document.getElementById('projectFrequencyTableBody');
    if (!tbody) return;

    const sorted = [...data].sort((a, b) => b.activityCount - a.activityCount).slice(0, 20);

    tbody.innerHTML = sorted.map(item => {
        const ratio = item.activityCount > 0 ? (item.amount / item.activityCount) / 1000000 : 0;
        const isWarning = item.activityCount > 10 && item.amount < 100000000; // Warning jika >10 meeting tapi <100jt
        const rowClass = isWarning ? 'bg-red-900/20' : '';

        return `
            <tr class="hover:bg-gray-750 border-b border-gray-700 ${rowClass}">
                <td class="px-4 py-3 text-sm text-white max-w-[200px] truncate">${item.project || item.client}</td>
                <td class="px-4 py-3 text-xs text-gray-300">${item.sales}</td>
                <td class="px-4 py-3 text-sm font-bold text-center text-white">${item.activityCount}x</td>
                <td class="px-4 py-3 text-xs text-gray-300 font-mono">${formatIDRShort(item.amount)}</td>
                <td class="px-4 py-3 text-xs text-center text-gray-400">${ratio.toFixed(1)} Jt/Akt</td>
            </tr>
        `;
    }).join('');
}

function renderFrequencyTable(data) {
    const tbody = document.getElementById('projectFrequencyTableBody');
    if (!tbody) return;

    // Urutkan berdasarkan Jumlah Aktivitas Terbanyak
    const sorted = [...data].sort((a, b) => b.activityCount - a.activityCount);
    
    // Ambil Top 20
    const displayData = sorted.slice(0, 20);

    tbody.innerHTML = displayData.map(item => {
        // Hitung Rasio: Amount per 1 Aktivitas (dalam Juta)
        // Semakin kecil rasionya, semakin "mahal" effort sales tersebut (effort besar, hasil kecil)
        const ratio = item.activityCount > 0 ? (item.amount / item.activityCount) / 1000000 : 0;
        
        // Highlight jika aktivitas > 10 tapi amount < 100 Juta (Inefisien?)
        const isWarning = item.activityCount > 10 && item.amount < 100000000;
        const rowClass = isWarning ? 'bg-red-900/20' : '';

        return `
            <tr class="hover:bg-gray-750 transition-colors ${rowClass}">
                <td class="px-4 py-3 text-sm font-medium text-white max-w-[250px] truncate">
                    ${item.project || '(Tanpa Nama Project)'}<br>
                    <span class="text-xs text-gray-400 font-normal">${item.client}</span>
                </td>
                <td class="px-4 py-3 text-xs text-gray-300">${item.sales}</td>
                <td class="px-4 py-3 text-sm font-bold text-center text-white">
                    ${item.activityCount}x
                    ${isWarning ? '<i data-lucide="alert-circle" class="inline w-3 h-3 text-red-400 ml-1" title="High Effort, Low Value?"></i>' : ''}
                </td>
                <td class="px-4 py-3 text-xs text-gray-300 font-mono">${formatIDRShort(item.amount)}</td>
                <td class="px-4 py-3 text-xs text-center text-gray-400">${ratio.toFixed(1)} Jt/Act</td>
            </tr>
        `;
    }).join('');
    lucide.createIcons();
}

// --- MODULE: STRATEGY SIMULATOR (YTD SINKRON DENGAN LEAD ID) ---
window.renderStrategySimulator = (deals, salesToDisplay, metrics) => {
    // 1. Ambil elemen input target
    const targetInput = document.getElementById('strategyTargetInput');
    if (!targetInput) return;

    let finalTarget = 0;

    // 2. LOGIKA PENENTUAN TARGET (DIPERBAIKI)
    if (currentRole === 'sales') {
        // Jika login sebagai Sales, ambil target langsung berdasarkan nama currentUser
        finalTarget = salesTargets[currentUser] || 0;
    } else {
        // Jika login sebagai Manager atau Head Sales
        const filterVal = document.getElementById('salesFilter').value;
        
        if (filterVal === 'all') {
            if (currentRole === 'head_sales') {
                finalTarget = salesTargets['Head Sales'] || 0;
            } else {
                // Target Manager (Total Tim)
                finalTarget = salesTargets[currentUser] || 0; 
            }
        } else {
            // Jika memilih sales tertentu dari dropdown
            finalTarget = salesTargets[filterVal] || 0;
        }
    }

    // 3. Masukkan ke input target dan format ke Rupiah
    targetInput.value = finalTarget.toLocaleString('id-ID');

       // 1. Tabel Pencapaian YTD
    window.currentStrategyDeals = deals;
    window.currentStrategySales = salesToDisplay;

    // --- [PERBAIKAN UTAMA: LOGIKA YTD DENGAN PRIORITAS LEAD ID] ---
    const currentYear = new Date().getFullYear();
    const uniqueWonProjects = new Map(); // Map untuk menyimpan deal unik

    // Iterasi semua data (deals)
    deals.forEach(deal => {
        // A. Filter Sales: Hanya data milik sales yang sedang dilihat
        if (!salesToDisplay.includes(deal.sales)) return;

        // B. Filter Tahun: Hanya data Tahun Ini (YTD) - Wajib 1 Jan s/d 31 Des
        if (!deal.meetingDateObj || deal.meetingDateObj.getFullYear() !== currentYear) return;

        // C. Filter Status: Hanya status yang dianggap CLOSING (Action, Delivery, Payment)
        // Kita abaikan 'Lost' atau status pipeline (Awareness s/d Process)
        if (!['Action', 'Delivery', 'Payment'].includes(deal.meetingType)) return;

        // D. LOGIKA KUNCI UNIK (PRIORITAS LEAD ID - SAMA DENGAN TABEL LEADS)
        let uniqueKey = "";
        
        // Prioritas 1: Gunakan Lead ID (nomorRFQ)
        if (deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "lead_" + deal.nomorRFQ.trim();
        } 
        // Prioritas 2: Gunakan Project GUID
        else if (deal.projectGUID) {
            uniqueKey = deal.projectGUID;
        }
        // Prioritas 3: Fallback ke Nama Klien + Project
        else {
            uniqueKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
        }

        // Cek apakah project ini sudah ada di map?
        const existing = uniqueWonProjects.get(uniqueKey);
        
        // Ambil data dengan tanggal meeting PALING BARU (Latest Update)
        if (!existing || deal.meetingDateObj > existing.meetingDateObj) {
            uniqueWonProjects.set(uniqueKey, deal);
        }
    });

    // Hitung Total Revenue dari Map yang sudah bersih (unik)
    let ytdRevenue = 0;
    uniqueWonProjects.forEach(deal => {
        ytdRevenue += (parseInt(deal.value) || 0);
    });

    // Simpan ke variabel global untuk dipakai di calculation
    window.currentStrategyRevenue = ytdRevenue;
    // --- [AKHIR PERBAIKAN] ---
    
    // 3. Update UI (Progress Bar, Gap, Text)
    // Panggil fungsi perhitungan gap
    if (typeof window.calculateStrategy === 'function') {
        window.calculateStrategy();
    }
    
    // 4. Generate Tabel Insight (List Klien)
    if (typeof window.generateStrategyInsights === 'function') {
        window.generateStrategyInsights(deals, salesToDisplay);
    }
};

// --- [FINAL DYNAMIC VERSION] Action Plan Terhubung dengan Strategi ---
function renderActivityGapRecommendation() {
    // 1. Ambil Target, Pencapaian, dan Gap
    const targetInput = document.getElementById('strategyTargetInput');
    const targetVal = targetInput ? (parseInt(targetInput.value.replace(/\./g, '')) || 0) : 0;
    const currentVal = window.currentStrategyRevenue || 0;
    const gapRevenue = targetVal - currentVal;
    
    // Container UI
    const container = document.getElementById('strategyRecommendationCard');
    if(!container) return;

    // Cek jika Target Tercapai
    if (gapRevenue <= 0) {
        container.innerHTML = `<div class="p-6 bg-emerald-900/40 text-emerald-300 rounded-xl border border-emerald-500/50 flex items-center justify-center gap-4"><i data-lucide="party-popper" class="w-8 h-8"></i><div><h3 class="font-bold text-lg">Target Tercapai!</h3><p class="text-sm opacity-80">Pertahankan momentum dan fokus pada delivery.</p></div></div>`;
        if(window.lucide) window.lucide.createIcons();
        return;
    }

    // --- 2. AMBIL WIN RATE PERSONAL (Dari History YTD) ---
    let learnedWinRate = 0.2; // Default 20% (Safety Net)
    let winRateLabel = "Baseline";

    if (window.currentStrategyDeals && window.currentStrategyDeals.length > 0) {
        let totalWon = 0;
        let totalOpportunity = 0;

        window.currentStrategyDeals.forEach(d => {
            if (window.currentStrategySales && !window.currentStrategySales.includes(d.sales)) return;
            const val = parseInt(d.value) || 0;
            if (['Action', 'Delivery', 'Payment'].includes(d.meetingType)) totalWon += val;
            if (['Action', 'Delivery', 'Payment', 'Lost'].includes(d.meetingType)) totalOpportunity += val; // Won + Lost only (Closed Won Rate)
            else totalOpportunity += val; // Atau sertakan Open pipeline (Win Rate Overall)
        });

        // Gunakan logika Win Rate by Amount (Won / Total Pipe)
        if (totalOpportunity > 0) {
            const rawRate = totalWon / totalOpportunity;
            if (rawRate > 0.01) learnedWinRate = rawRate; // Min 1%
            winRateLabel = "Personal YTD";
        }
    }

    // --- 3. TENTUKAN TARGET DEAL SIZE BERDASARKAN STRATEGI (DINAMIS) ---
    // Ambil nilai radio button yang sedang dipilih user
    const strategyType = document.querySelector('input[name="strategyType"]:checked')?.value || 'big';
    
    let totalDealsNeeded = 0;
    let avgTargetDealSize = 0;
    let strategyName = "";
    let strategyIcon = "";

    const VAL_BIG = 1000000000; // 1 Milyar
    const VAL_SMALL = 100000000; // 100 Juta

    if (strategyType === 'big') {
        // Strategi: Kejar Gap pakai Big Project semua
        totalDealsNeeded = Math.ceil(gapRevenue / VAL_BIG);
        avgTargetDealSize = VAL_BIG;
        strategyName = "Big Project Focus";
        strategyIcon = "crown";
    } else if (strategyType === 'small') {
        // Strategi: Kejar Gap pakai Volume semua
        totalDealsNeeded = Math.ceil(gapRevenue / VAL_SMALL);
        avgTargetDealSize = VAL_SMALL;
        strategyName = "Volume Project Focus";
        strategyIcon = "layers";
    } else {
        // Strategi: Mix (50% Gap dari Big, 50% Gap dari Small)
        const gapBig = gapRevenue * 0.5;
        const gapSmall = gapRevenue * 0.5;
        
        const dealsBig = Math.ceil(gapBig / VAL_BIG);
        const dealsSmall = Math.ceil(gapSmall / VAL_SMALL);
        
        totalDealsNeeded = dealsBig + dealsSmall;
        // Hitung rata-rata tertimbang (Weighted Average) hanya untuk tampilan UI
        avgTargetDealSize = gapRevenue / totalDealsNeeded; 
        strategyName = "Mix Strategy (50:50)";
        strategyIcon = "shuffle";
    }

    // --- 4. HITUNG REVERSE FUNNEL ---
    // Leads = Deals / Win Rate
    const leadsNeeded = Math.ceil(totalDealsNeeded / learnedWinRate);
    
    // Activity = Leads * Meeting Per Lead (Asumsi 3x)
    const MEETINGS_PER_LEAD = 3;
    const totalActivitiesNeeded = leadsNeeded * MEETINGS_PER_LEAD;

    // Hitung Sisa Waktu (Minggu)
    const today = new Date();
    const endYear = new Date(today.getFullYear(), 11, 31);
    const diffTime = Math.abs(endYear - today);
    const weeksLeft = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7)));

    // Breakdown Mingguan
    const weeklyActivities = Math.ceil(totalActivitiesNeeded / weeksLeft);

    // Format Text
    const winRatePercent = (learnedWinRate * 100).toFixed(1);
    const displayDealSize = formatIDRShort(avgTargetDealSize);

    // --- 5. RENDER UI ---
    container.innerHTML = `
        <div class="bg-gradient-to-br from-gray-800 to-indigo-900/40 p-6 rounded-xl border border-indigo-500/40 shadow-lg relative overflow-hidden transition-all duration-500">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 relative z-10 gap-4">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center">
                        <div class="p-2 bg-indigo-600 rounded-lg mr-3 shadow-lg shadow-indigo-500/20">
                            <i data-lucide="${strategyIcon}" class="w-5 h-5 text-white"></i>
                        </div>
                        Action Plan: ${strategyName}
                    </h3>
                    <p class="text-xs text-gray-400 mt-1 ml-12">
                        Simulasi menutup gap <span class="text-red-400 font-mono font-bold">${formatIDRShort(gapRevenue)}</span> 
                        menggunakan Win Rate Anda (<span class="text-emerald-400 font-bold">${winRatePercent}%</span>).
                    </p>
                </div>
                <div class="text-right bg-gray-900/50 px-4 py-2 rounded-lg border border-gray-700">
                    <p class="text-[10px] text-gray-500 uppercase tracking-wider">Sisa Waktu</p>
                    <p class="text-lg font-mono font-bold text-white">${weeksLeft} Minggu</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 relative z-10">
                <div class="bg-gray-800/80 p-4 rounded-xl border border-gray-600 hover:border-gray-500 transition group">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Target Closing</p>
                        <i data-lucide="check-circle-2" class="w-4 h-4 text-gray-500 group-hover:text-emerald-400 transition"></i>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <p class="text-3xl font-bold text-white">${totalDealsNeeded}</p>
                        <span class="text-xs text-gray-400">Deal</span>
                    </div>
                    <div class="mt-2 w-full bg-gray-700 h-1 rounded-full overflow-hidden">
                        <div class="bg-emerald-500 h-full w-3/4"></div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Avg Value: <span class="text-gray-300 font-mono">${displayDealSize}</span></p>
                </div>

                <div class="bg-gray-800/80 p-4 rounded-xl border border-gray-600 hover:border-yellow-500/50 transition group">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Leads Wajib</p>
                        <i data-lucide="filter" class="w-4 h-4 text-gray-500 group-hover:text-yellow-400 transition"></i>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <p class="text-3xl font-bold text-yellow-400">${leadsNeeded}</p>
                        <span class="text-xs text-yellow-200/70">Prospek</span>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 leading-tight">
                        Karena Win Rate Anda <b>${winRatePercent}%</b>, Anda butuh ${leadsNeeded} leads untuk dapat ${totalDealsNeeded} closing.
                    </p>
                </div>

                <div class="bg-blue-600 p-4 rounded-xl shadow-lg shadow-blue-900/50 transform hover:-translate-y-1 transition duration-300 border border-blue-400 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 bg-white/10 w-20 h-20 rounded-full blur-xl"></div>
                    
                    <p class="text-[10px] text-blue-100 uppercase tracking-wider font-bold mb-1">Target Mingguan (KPI)</p>
                    <div class="flex items-end gap-2">
                        <span class="text-5xl font-extrabold text-white tracking-tight">${weeklyActivities}</span>
                        <div class="mb-1.5">
                            <span class="text-xs text-blue-200 font-semibold block">Aktivitas</span>
                            <span class="text-[9px] text-blue-300 block">Meeting / Call</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-500/50 flex items-center justify-between">
                        <span class="text-[10px] text-blue-100">Action:</span>
                        <button onclick="document.getElementById('tab-btn-1').click()" class="bg-white/20 hover:bg-white/30 text-white text-[10px] px-2 py-1 rounded transition flex items-center">
                            <i data-lucide="plus" class="w-3 h-3 mr-1"></i> Plan Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if(window.lucide) window.lucide.createIcons();
}

// --- 1. FUNGSI HITUNG TARGET (Mendukung Mix Strategy) ---
window.calculateStrategy = () => {
    const targetInput = document.getElementById('strategyTargetInput');
    const currentRevEl = document.getElementById('strategyCurrentRev');
    const progressBar = document.getElementById('strategyProgressBar');
    const progressText = document.getElementById('strategyProgressText');
    const gapEl = document.getElementById('strategyGap');
    
    // Element Text Hasil
    const reqBigCountEl = document.getElementById('reqBigCount');
    const reqSmallCountEl = document.getElementById('reqSmallCount');
    const reqMixCountEl = document.getElementById('reqMixCount');

    if (!targetInput) return;

    const targetVal = parseInt(targetInput.value.replace(/\./g, '')) || 0;
    const currentVal = window.currentStrategyRevenue || 0; 

    let gap = targetVal - currentVal;
    if (gap < 0) gap = 0;

    window.currentStrategyGap = gap; 

    // Update UI Card Utama
    if(currentRevEl) currentRevEl.textContent = formatIDRShort(currentVal);
    if(gapEl) gapEl.textContent = formatIDRShort(gap);
    
    let percentage = targetVal > 0 ? (currentVal / targetVal) * 100 : 0;
    const visualPercentage = percentage > 100 ? 100 : percentage;

    if(progressBar) {
        progressBar.style.width = `${visualPercentage}%`;
        if(percentage >= 100) {
            progressBar.classList.remove('bg-blue-500', 'bg-emerald-500');
            progressBar.classList.add('bg-purple-500'); 
        } else {
            progressBar.classList.remove('bg-purple-500');
            progressBar.classList.add('bg-emerald-500');
        }
    }
    
    if(progressText) {
        progressText.textContent = `${percentage.toFixed(1)}%`;
        if(percentage >= 100) progressText.textContent += " (Completed!)";
    }

    // --- LOGIKA 3 OPSI STRATEGI ---
    // Asumsi: Big Project = 1 Milyar, Volume Project = 100 Juta
    const AVG_BIG_DEAL = 1000000000;
    const AVG_VOL_DEAL = 100000000;

    // 1. Hitung Big Project Only
    const needBig = Math.ceil(gap / AVG_BIG_DEAL);
    if(reqBigCountEl) reqBigCountEl.textContent = gap === 0 ? "Selesai" : `${needBig} Deal`;

    // 2. Hitung Volume Only
    const needSmall = Math.ceil(gap / AVG_VOL_DEAL);
    if(reqSmallCountEl) reqSmallCountEl.textContent = gap === 0 ? "Selesai" : `${needSmall} Deal`;

    // 3. Hitung Mix Strategy (50:50 proporsi GAP)
    const gapForBig = gap * 0.5;
    const gapForSmall = gap * 0.5;
    const mixBig = Math.ceil(gapForBig / AVG_BIG_DEAL);
    const mixSmall = Math.ceil(gapForSmall / AVG_VOL_DEAL);
    
    if(reqMixCountEl) {
        reqMixCountEl.textContent = gap === 0 ? "Selesai" : `${mixBig} Big + ${mixSmall} Vol`;
    }

    // Panggil ulang render tabel agar baris akuisisi menyesuaikan gap
    if(typeof window.generateStrategyInsights === 'function' && window.currentStrategyDeals) {
        window.generateStrategyInsights(window.currentStrategyDeals, window.currentStrategySales);
    }
    
    // Panggil update text coverage
    if(typeof window.updateGapCoverage === 'function') {
        window.updateGapCoverage();
    }
// --- [BARU] Panggil fungsi rekomendasi di akhir kalkulasi ---
    if(typeof renderActivityGapRecommendation === 'function') {
        renderActivityGapRecommendation();
    }
};

// --- 2. FUNGSI GENERATE INSIGHT (V7: NO LIMITER & SYNC TOTAL) ---
window.generateStrategyInsights = (allDeals, salesToDisplay) => {
    const tbody = document.getElementById('strategyInsightBody');
    if (!tbody) return;

    const currentYear = new Date().getFullYear();
    const today = new Date();
    
    // Helper: Randomizer Tipe Target
    const getRandomType = () => {
        const types = ['RSUD atau RSUP', 'Perguruan Tinggi Negeri', 'Diskominfo'];
        return types[Math.floor(Math.random() * types.length)];
    };

    // Helper: Ambil Nama Unik dari DB
    const getUniqueAcquisitionTarget = (typeFilter, existingNames) => {
        let sourceData = window.allTargetsGlobal;
        if (!sourceData || sourceData.length === 0) return "Target (Data Kosong)";

        let candidates = sourceData.filter(t => {
            const dbType = (t.type || t.Type || t.Tipe || '').toLowerCase();
            const reqType = typeFilter.toLowerCase();
            if (reqType.includes('rs') && (dbType.includes('rs') || dbType.includes('sakit'))) return true;
            if (reqType.includes('tinggi') && (dbType.includes('univ') || dbType.includes('tinggi') || dbType.includes('poly'))) return true;
            if (reqType.includes('kominfo') && (dbType.includes('kominfo') || dbType.includes('dinas'))) return true;
            if (!reqType.includes('rs') && !reqType.includes('tinggi') && !reqType.includes('kominfo')) return true;
            return false;
        });

        candidates = candidates.filter(c => {
            const cName = c.name || c.Name || c.Nama_Target || "Tanpa Nama";
            return !existingNames.has(cName.trim().toLowerCase());
        });

        if (candidates.length === 0) candidates = sourceData; 
        const randomItem = candidates[Math.floor(Math.random() * candidates.length)];
        
        if (randomItem) {
            const finalName = randomItem.name || randomItem.Name || randomItem.Nama_Target || "Target Umum";
            existingNames.add(finalName.trim().toLowerCase());
            return finalName;
        }
        return "Target Umum";
    };

    // Helper Priority Status
    const getStatusScore = (status) => {
        if (['Payment', 'Delivery', 'Action'].includes(status)) return 5;
        if (status === 'Lost') return 4;
        if (status === 'Process Closing') return 3;
        if (status === 'Desire') return 2;
        if (status === 'Interest') return 1;
        return 0; 
    };

    // --- 1. PROSES DATA EXISTING ---
    const uniqueLatestMap = new Map(); 
    const clientAggMap = {}; 
    const existingClientNames = new Set();

    allDeals.forEach(d => {
        if (!salesToDisplay.includes(d.sales)) return;
        if (d.client) existingClientNames.add(d.client.trim().toLowerCase());

        let uniqueKey = d.projectGUID;
        if (!uniqueKey && d.nomorRFQ && d.nomorRFQ.length > 2) uniqueKey = "rfq_" + d.nomorRFQ;
        if (!uniqueKey) uniqueKey = (d.client + "_" + d.namaProject).trim().toLowerCase();

        const existing = uniqueLatestMap.get(uniqueKey);
        
        let shouldUpdate = false;
        if (!existing) {
            shouldUpdate = true;
        } else {
            const newDate = d.meetingDateObj.getTime();
            const oldDate = existing.meetingDateObj.getTime();
            
            if (newDate > oldDate) {
                shouldUpdate = true;
            } else if (newDate === oldDate) {
                if (getStatusScore(d.meetingType) > getStatusScore(existing.meetingType)) {
                    shouldUpdate = true;
                }
            }
        }

        if (shouldUpdate) uniqueLatestMap.set(uniqueKey, d);

        const cName = d.client;
        if (!clientAggMap[cName]) clientAggMap[cName] = { name: cName, revTotal: 0, lastDate: null, sales: d.sales };
        
        if (d.meetingDateObj) {
            if (!clientAggMap[cName].lastDate || d.meetingDateObj > clientAggMap[cName].lastDate) {
                clientAggMap[cName].lastDate = d.meetingDateObj;
            }
        }
        if (['Action','Delivery','Payment'].includes(d.meetingType)) {
            clientAggMap[cName].revTotal += (parseInt(d.value) || 0);
        }
    });

    // Generate List Active Pipeline
    const pipelineList = [];
    uniqueLatestMap.forEach(d => {
        if (!d.meetingDateObj || d.meetingDateObj.getFullYear() !== currentYear) return;
        
        const status = d.meetingType;
        if (['Awareness', 'Interest', 'Desire', 'Process Closing'].includes(status)) {
            pipelineList.push({
                type: 'pipeline',
                client: d.client,
                project: d.namaProject || '(Pipeline Aktif)',
                value: parseInt(d.value) || 0,
                status: status,
                uniqueKey: d.projectGUID || (d.nomorRFQ ? "rfq_" + d.nomorRFQ : (d.client + "_" + d.namaProject).trim().toLowerCase())
            });
        }
    });
    pipelineList.sort((a, b) => b.value - a.value);

    // Generate List Upsell & Sleeper
    const upsellList = [];
    const sleeperList = [];
    Object.values(clientAggMap).forEach(c => {
        if (!c.lastDate) return;
        const diffDays = Math.ceil(Math.abs(today - c.lastDate) / (1000 * 60 * 60 * 24));
        const lastTransactionYear = c.lastDate.getFullYear();

        if (diffDays > 180 && c.revTotal > 0) {
            sleeperList.push({
                type: 'sleeper',
                client: c.name,
                status: `Vakum ${diffDays} Hari`,
                value: c.revTotal * 0.1, 
                sales: c.sales
            });
        } else if (lastTransactionYear === currentYear && c.revTotal > 300000000) {
            upsellList.push({
                type: 'upsell',
                client: c.name,
                status: 'Active Key Account',
                value: c.revTotal * 0.2, 
                sales: c.sales
            });
        }
    });

    // --- 2. HITUNG GAP & GENERATE AKUISISI ---
    const totalPipeline = pipelineList.reduce((sum, i) => sum + i.value, 0);
    const totalUpsell = upsellList.reduce((sum, i) => sum + i.value, 0);
    const totalSleeper = sleeperList.reduce((sum, i) => sum + i.value, 0);
    const currentPotential = totalPipeline + totalUpsell + totalSleeper;

    const targetInput = document.getElementById('strategyTargetInput');
    const targetVal = targetInput ? (parseInt(targetInput.value.replace(/\./g, '')) || 0) : 0;
    const currentRev = window.currentStrategyRevenue || 0;
    const realGap = Math.max(0, targetVal - currentRev);
    const acquisitionNeeded = Math.max(0, realGap - currentPotential);

    const acquisitionList = [];
    
    if (acquisitionNeeded > 0) {
        const strategyType = document.querySelector('input[name="strategyType"]:checked')?.value || 'big';
        const VAL_BIG = 1000000000; 
        const VAL_SMALL = 100000000; 

        const generateAcquisitionRow = (val, labelProject) => {
            const typeKey = getRandomType(); 
            const clientName = getUniqueAcquisitionTarget(typeKey, existingClientNames); 
            let icon = 'building-2';
            if (typeKey.includes('RS')) icon = 'activity';
            if (typeKey.includes('Tinggi')) icon = 'graduation-cap';

            return {
                type: 'acquisition',
                client: clientName,
                project: labelProject,
                value: val,
                status: 'Target Akuisisi',
                icon: icon,
                targetType: typeKey 
            };
        };

        let loopCount = 0;
        let valPerItem = VAL_BIG;
        let label = "";

        // --- PERBAIKAN: MENGHAPUS BATAS LIMIT (Math.min) AGAR SESUAI GAP ---
        if (strategyType === 'big') {
            loopCount = Math.ceil(acquisitionNeeded / VAL_BIG);
            // Safety cap: max 200 baris untuk mencegah browser crash jika error input
            if(loopCount > 200) loopCount = 200; 
            valPerItem = VAL_BIG;
            label = "Big Project: Infra / Core System";
            for(let i=0; i<loopCount; i++) acquisitionList.push(generateAcquisitionRow(valPerItem, label));
            
        } else if (strategyType === 'small') {
            loopCount = Math.ceil(acquisitionNeeded / VAL_SMALL);
            if(loopCount > 200) loopCount = 200;
            valPerItem = VAL_SMALL;
            label = "Volume: Procurement / Licensing";
            for(let i=0; i<loopCount; i++) acquisitionList.push(generateAcquisitionRow(valPerItem, label));

        } else {
            // Mix
            const mixBig = Math.ceil((acquisitionNeeded * 0.5) / VAL_BIG);
            const mixSmall = Math.ceil((acquisitionNeeded * 0.5) / VAL_SMALL);
            
            // Safety cap untuk mix
            const safeMixBig = Math.min(mixBig, 100);
            const safeMixSmall = Math.min(mixSmall, 100);
            
            for(let i=0; i<safeMixBig; i++) acquisitionList.push(generateAcquisitionRow(VAL_BIG, "Mix (Big): Infra Solution"));
            for(let i=0; i<safeMixSmall; i++) acquisitionList.push(generateAcquisitionRow(VAL_SMALL, "Mix (Vol): Device / Support"));
        }
    }

    // --- 3. RENDER HTML ---
    let htmlContent = '';

    const renderSection = (id, title, iconClass, colorClass, listData, emptyMsg) => {
        const totalVal = listData.reduce((sum, i) => sum + i.value, 0);
        const count = listData.length;
        let visibilityClass = (id === 'pipeline' || id === 'acquisition') ? '' : 'hidden'; 
        let rotateIcon = (id === 'pipeline' || id === 'acquisition') ? 'rotate(180deg)' : 'rotate(0deg)';

        let sectionHTML = `
            <tr class="bg-gray-700/80 hover:bg-gray-600 cursor-pointer border-b border-gray-600 transition" onclick="window.toggleStrategyGroup('${id}')">
                <td colspan="4" class="py-3 px-4"> 
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i id="icon-strat-${id}" data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform duration-300" style="transform: ${rotateIcon}"></i>
                            <span class="${colorClass} font-bold text-sm flex items-center gap-2">
                                <i data-lucide="${iconClass}" class="w-4 h-4"></i> ${title}
                            </span>
                            <span class="text-xs bg-gray-800 px-2 py-0.5 rounded-full text-gray-300 border border-gray-600 font-mono">${count} Item</span>
                        </div>
                        <span class="font-mono text-xs font-semibold text-emerald-400">Potensi: ${formatIDRShort(totalVal)}</span>
                    </div>
                </td>
            </tr>
        `;
        
        if (listData.length === 0) {
            sectionHTML += `
                <tr class="strat-group-${id} ${visibilityClass} bg-gray-800/30">
                    <td colspan="4" class="py-4 text-center text-xs text-gray-500 italic">${emptyMsg}</td>
                </tr>`;
        } else {
            sectionHTML += listData.map(item => {
                let btnAction = '';
                const safeName = (item.client || '').replace(/'/g, "\\'"); 
                const safeUniqueKey = (item.uniqueKey || '').replace(/'/g, "\\'");

                if (item.type === 'pipeline') {
                    btnAction = `<button onclick="window.showProjectHistory('${safeUniqueKey}')" class="bg-blue-900 hover:bg-blue-700 text-blue-200 text-[10px] px-3 py-1.5 rounded border border-blue-700 transition w-full">Detail</button>`;
                } else if (item.type === 'acquisition') {
                    if (currentRole === 'sales') {
                        btnAction = `<button onclick="window.quickPlanFollowUp('${safeName}', '${item.project}', 'IT Outsourcing', '', 'Perkenalan dan mencari Leads')" class="bg-red-900 hover:bg-red-700 text-red-100 text-[10px] px-3 py-1.5 rounded border border-red-500 transition w-full font-bold animate-pulse flex items-center justify-center"><i data-lucide="plus-circle" class="w-3 h-3 mr-1"></i> Add Plan</button>`;
                    } else {
                        btnAction = `<button disabled class="bg-gray-700 text-gray-500 text-[10px] px-3 py-1.5 rounded border border-gray-600 w-full cursor-not-allowed flex items-center justify-center opacity-70" title="Hanya Sales yang dapat membuat rencana"><i data-lucide="lock" class="w-3 h-3 mr-1"></i> Sales Only</button>`;
                    }
                } else if (item.type === 'sleeper') {
                    btnAction = `<button onclick="window.activateSleeperClient('${safeName}')" class="bg-orange-900 hover:bg-orange-700 text-orange-200 text-[10px] px-3 py-1.5 rounded border border-orange-700 transition w-full">Bangunkan</button>`;
                } else {
                    btnAction = `<button onclick="window.quickPlanFollowUp('${safeName}', 'Upsell Offer', 'IT Outsourcing', '')" class="bg-purple-900 hover:bg-purple-700 text-purple-200 text-[10px] px-3 py-1.5 rounded border border-purple-700 transition w-full">Upsell</button>`;
                }

                const rowBg = item.type === 'acquisition' ? 'bg-red-900/10 border-red-900/20' : 'bg-gray-800/20 border-gray-700/30';
                const textClass = item.type === 'acquisition' ? 'text-red-300 font-bold' : 'text-white';
                const rowIcon = item.icon ? `<i data-lucide="${item.icon}" class="inline w-3 h-3 mr-1 opacity-70"></i>` : '';

                return `
                <tr class="strat-group-${id} ${visibilityClass} hover:bg-gray-700/40 transition border-b ${rowBg}">
                    <td class="py-3 px-2 pl-10 align-middle">
                        <div class="${textClass} text-sm truncate w-full" title="${item.client}">
                            ${rowIcon}${item.client}
                        </div>
                        <div class="text-gray-500 text-[10px] truncate w-full mt-0.5">${item.project || '-'}</div>
                    </td>
                    <td class="py-3 px-2 align-middle">
                        <span class="text-[10px] text-gray-400 whitespace-nowrap block truncate">${item.status}</span>
                    </td>
                    <td class="py-3 px-2 text-right font-mono text-emerald-400 text-xs align-middle">
                        ${formatIDRShort(item.value)}
                    </td>
                    <td class="py-3 px-2 text-center align-middle">
                        ${btnAction}
                    </td>
                </tr>`;
            }).join('');
        }
        return sectionHTML;
    };

    htmlContent += renderSection('pipeline', 'Active Pipeline', 'target', 'text-blue-400', pipelineList, 'Tidak ada pipeline aktif.');
    
    if (acquisitionList.length > 0) {
        let stratLabel = 'Strategy';
        const strategyType = document.querySelector('input[name="strategyType"]:checked')?.value || 'big';
        if(strategyType === 'big') stratLabel = 'Big Project';
        else if(strategyType === 'small') stratLabel = 'Volume Project';
        else stratLabel = 'Mix Strategy';
        htmlContent += renderSection('acquisition', `Rekomendasi Akuisisi (${stratLabel})`, 'user-plus', 'text-red-400', acquisitionList, '');
    }

    htmlContent += renderSection('upsell', 'Potensi Upsell', 'trending-up', 'text-purple-400', upsellList, 'Tidak ada kandidat upsell.');
    htmlContent += renderSection('sleeper', 'Reaktivasi (Client Tidur)', 'moon', 'text-orange-400', sleeperList, 'Tidak ada client tidur.');
    
    tbody.innerHTML = htmlContent;
    lucide.createIcons();

    // --- PERBAIKAN: HITUNG TOTAL DARI LIST YANG AKTUAL DIGENERATE ---
    // Ini menjamin angka di teks ringkasan sama persis dengan total di tabel
    const actualAcquisitionTotal = acquisitionList.reduce((sum, i) => sum + i.value, 0);
    window.totalInsightPotential = currentPotential + actualAcquisitionTotal;
    
    if (typeof window.updateGapCoverage === 'function') window.updateGapCoverage();
};
    // Fungsi utama untuk me-render ulang dashboard berdasarkan filter
    function renderFilteredDashboard() {
        const { startDate, endDate, prevStartDate, prevEndDate } = getFilterDates();
        
        let salesToDisplay = []; 
        if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            salesToDisplay = (salesFilter.value === 'all') ? myTeam : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        } else { 
            salesToDisplay = [currentUser];
        }

        if (!startDate || !endDate) {
            filteredDeals = [];
            prevPeriodDeals = [];
        } else {
            filteredDeals = allDeals.filter(deal => {
                const dealDate = deal.meetingDateObj; 
                if (!dealDate || isNaN(dealDate.getTime())) return false; 
                const salesMatch = salesToDisplay.includes(deal.sales);
                return salesMatch && dealDate >= startDate && dealDate <= endDate;
            });

             prevPeriodDeals = [];
            if (prevStartDate && prevEndDate && !isNaN(prevStartDate.getTime()) && !isNaN(prevEndDate.getTime())) {
                prevPeriodDeals = allDeals.filter(deal => {
                    const dealDate = deal.meetingDateObj; 
                     if (!dealDate || isNaN(dealDate.getTime())) return false;
                    const salesMatch = salesToDisplay.includes(deal.sales);
                    return salesMatch && dealDate >= prevStartDate && dealDate <= prevEndDate;
                });
            }
        }
        
// Hitung metrik Hibrida (PASSING salesToDisplay BARU)
        const performanceMetrics = calculateSalesPerformance(filteredDeals, salesToDisplay);

        // Panggil semua fungsi render
    updateSalesSummary(performanceMetrics); 

    // ============================================================
    // [BARU] Tambahkan Baris Ini (Menimpa grafik AIDA lama)
    // ============================================================
    if (typeof renderAIDAChartSync === 'function') {
        renderAIDAChartSync(allDeals, salesToDisplay);
    }
    // ============================================================

    // (MODIFIKASI) Selalu panggil metrik perencanaan untuk semua role
    // dan KIRIM 'salesToDisplay' agar kartunya dinamis.
    renderPlanningMetrics(salesToDisplay, currentRole);

    renderMetrics(filteredDeals, performanceMetrics);
        
        if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
             renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); 
        }

        renderTopMeetingTypesChart(filteredDeals); 
        renderCapabilityChart(filteredDeals);
        renderWinRateChart(performanceMetrics); 
        renderClientSegmentProgress(filteredDeals); // NEW: RENDER PROGRESS SEGMENT
        renderProgramChart(filteredDeals);
        supportCurrentPage = 1; // RESET Paginasi setiap kali filter global berubah
        renderSupportNeededTable(filteredDeals, salesToDisplay);
// (BARU) Panggil fungsi render tabel stale leads
renderStaleLeadsTable(filteredDeals, salesToDisplay);
// (BARU) Panggil renderer untuk tabel Leads Aktif
renderActiveLeadsTable(filteredDeals, salesToDisplay, performanceMetrics);
        
// Panggil renderBuyerAnalytics UNTUK SEMUA ROLE
renderBuyerAnalytics(allDeals, salesToDisplay);

// [BARU] TIMPA Tabel Sleeper Assets dengan Data GLOBAL
// Ini memastikan sales bisa melihat/mengaktifkan klien dari sales yang resign
renderGlobalSleeperAssets(allDeals);

// --- TAMBAHAN UNTUK PROJECT ANALYTIC ---
        // IZINKAN SEMUA ROLE (Manager, Head Sales, DAN Sales) untuk melihat analitik ini
        // Data keamanan (Privacy) sudah ditangani oleh parameter 'salesToDisplay'
        if (currentRole === 'manager' || currentRole === 'head_sales' || currentRole === 'sales') {
            // Pastikan fungsi sudah didefinisikan sebelum dipanggil
            if (typeof renderProjectAnalytics === "function") {
                renderProjectAnalytics(filteredDeals, salesToDisplay);
            } else {
                console.error("Fungsi renderProjectAnalytics belum ditemukan/didefinisikan!");
            }
        }
if (currentRole === 'manager' || currentRole === 'head_sales') {
            renderDailyActivityTrend(filteredDeals); 
        }
// [TAMBAHAN] Render Strategy Simulator (How to Achieve)
        if (typeof renderStrategySimulator === 'function') {
            // KITA MENAMBAHKAN 'performanceMetrics' (parameter ke-3)
            // performanceMetrics berisi data 'aidaAmount.action' yang sudah dihitung sebelumnya
            renderStrategySimulator(allDeals, salesToDisplay, performanceMetrics);
        }
// [BARU] Panggil Fitur Advanced (Worry List, Funnel, dll)
        if (typeof renderAdvancedFeatures === 'function') {
            renderAdvancedFeatures(filteredDeals, salesToDisplay, performanceMetrics);
        }
    }
    
// --- REVISI FINAL: METRIK DASHBOARD UTAMA (PRIORITAS LEAD ID) ---
const calculateSalesPerformance = (deals, salesToDisplay) => {
    const met = {
        totalMeetings: 0,
        totalRFQs: 0, wonRFQs: 0, closedRFQs: 0, 
        totalNewClients: new Set(), totalExistingClients: new Set(), 
        awarenessCount: 0, interestCount: 0, desireCount: 0, actionCount: 0, 
        aidaAmount: { awareness: 0, interest: 0, desire: 0, action: 0, total: 0 },
        winRateAmount: { won: 0, lostClosed: 0, open: 0, total: 0 },
        
        totalStepsWon: 0, uniqueRFQs: new Set(), wonRFQsSet: new Set(), closedRFQsSet: new Set(),
        topCapability: 'N/A', topActivityStatus: 'N/A', avgSalesCycleDuration: 0
    };
    
    const capabilityCounts = {};
    const statusCounts = {};

    // 1. DEDUPLIKASI DATA (Mengambil Status Terakhir per Lead ID)
    const uniqueDealsMap = new Map();
    
    deals.forEach(deal => {
        // Hitung Total Aktivitas (Meeting) - Ini tidak perlu deduplikasi
        met.totalMeetings++;
        
        // Hitung Sebaran Status (Activity Based)
        const status = deal.meetingType;
        if (status === 'Awareness') met.awarenessCount++;
        else if (status === 'Interest') met.interestCount++;
        else if (status === 'Desire' || status === 'Process Closing') met.desireCount++;
        else if (['Action', 'Delivery', 'Payment'].includes(status)) met.actionCount++; 

        // Hitung Capability Popularity
        const cap = deal.capability || 'Lainnya';
        capabilityCounts[cap] = (capabilityCounts[cap] || 0) + 1;
        
        const currentStatus = deal.meetingType || 'Lainnya';
        statusCounts[currentStatus] = (statusCounts[currentStatus] || 0) + 1;
        
        // --- [PERBAIKAN UTAMA] LOGIKA KUNCI UNIK (PRIORITAS LEAD ID) ---
        let uniqueKey = "";

        // Prioritas 1: Gunakan LEAD ID (nomorRFQ) jika ada
        if (deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "lead_" + deal.nomorRFQ.trim();
        } 
        // Prioritas 2: Gunakan Project GUID (Fallback)
        else if (deal.projectGUID) {
            uniqueKey = deal.projectGUID;
        }
        // Prioritas 3: Client + Project Name
        else {
            uniqueKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
        }
        
        // Simpan data TERBARU untuk Lead ID ini
        const existing = uniqueDealsMap.get(uniqueKey);
        // Kita ambil data dengan tanggal meeting paling baru
        if (!existing || deal.meetingDateObj > existing.meetingDateObj) {
            uniqueDealsMap.set(uniqueKey, deal);
        }
    });

    // 2. Hitung Metrik Berbasis Amount dari Data Unik (Unique Lead ID)
    uniqueDealsMap.forEach(deal => {
        const val = parseInt(deal.value) || 0;
        const status = deal.meetingType;
        
        // A. AIDA Amount (Pipeline Value)
        if (status === 'Awareness') met.aidaAmount.awareness += val;
        else if (status === 'Interest') met.aidaAmount.interest += val;
        else if (['Desire', 'Process Closing'].includes(status)) met.aidaAmount.desire += val;
        else if (['Action', 'Delivery', 'Payment'].includes(status)) met.aidaAmount.action += val;
        
        // Jangan hitung LOST ke dalam total Pipeline AIDA
        if (status !== 'Lost') {
            met.aidaAmount.total += val;
        }

        // B. Win Rate Amount (Won vs Lost vs Open)
        if (['Action', 'Delivery', 'Payment'].includes(status)) {
            met.winRateAmount.won += val;
            met.wonRFQsSet.add(deal.projectGUID || deal.id); 
        } else if (status === 'Lost') {
            met.winRateAmount.lostClosed += val;
            met.closedRFQsSet.add(deal.projectGUID || deal.id);
        } else {
            met.winRateAmount.open += val;
        }
        met.winRateAmount.total += val; // Total Opportunity Value
        
        // C. Klien Unik & Project Unik
        if (deal.clientType === 'new') met.totalNewClients.add(deal.client);
        else met.totalExistingClients.add(deal.client);
        
        met.uniqueRFQs.add(deal.projectGUID || deal.id);
    });
    
    // 3. Hitung Metrik Turunan
    met.topCapability = Object.entries(capabilityCounts).sort(([, a], [, b]) => b - a)[0]?.[0] || 'N/A';
    met.topActivityStatus = Object.entries(statusCounts).sort(([, a], [, b]) => b - a)[0]?.[0] || 'N/A';

    met.totalRFQs = met.uniqueRFQs.size;
    met.wonRFQs = met.wonRFQsSet.size;

    // Win Rate (Amount Based)
    const totalWinLoss = met.winRateAmount.won + met.winRateAmount.lostClosed + met.winRateAmount.open;
    met.winRate = totalWinLoss > 0 ? (met.winRateAmount.won / totalWinLoss) * 100 : 0;
    
    // Ratio Existing Project
    let rfqFromExisting = 0;
    uniqueDealsMap.forEach(deal => { if(deal.clientType !== 'new') rfqFromExisting++; });
    met.rfqFromExistingRatio = met.totalRFQs > 0 ? (rfqFromExisting / met.totalRFQs) * 100 : 0;

    // Avg Sales Cycle (Activity Count per Won Deal)
    let totalStepsForWonRFQs = 0;
    met.wonRFQsSet.forEach(wonRfqId => {
         const steps = deals.filter(d => (d.projectGUID || d.id) === wonRfqId).length;
         totalStepsForWonRFQs += steps;
    });
    met.avgStepsWon = met.wonRFQs > 0 ? totalStepsForWonRFQs / met.wonRFQs : 0;

    // Avg Duration (Days)
    const cycleData = calculateSalesCycle(deals, salesToDisplay); 
    let totalDuration = 0;
    let totalCycles = 0;
    cycleData.forEach(d => {
        totalDuration += d.averageDuration * d.dealCount;
        totalCycles += d.dealCount;
    });
    met.avgSalesCycleDuration = totalCycles > 0 ? Math.round(totalDuration / totalCycles) : 0;
    
    return met;
};
    
    // Update 4 Metrik Hibrida (dan Metrik Efisiensi)
    function renderMetrics(filteredDeals, met) {
        if (!metricTotalMeetingsEl || metricTotalMeetingsEl.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI

        metricTotalMeetingsEl.textContent = met.totalMeetings.toLocaleString('id-ID');
        metricNewClientsEl.textContent = met.totalNewClients.size.toLocaleString('id-ID'); 
        metricExistingClientsEl.textContent = met.totalExistingClients.size.toLocaleString('id-ID');
        metricTotalRFQsEl.textContent = met.totalRFQs.toLocaleString('id-ID');
        
        metricAvgStepsEl.textContent = met.avgStepsWon.toFixed(1);
        metricExistingRatioEl.textContent = `${met.rfqFromExistingRatio.toFixed(1)}%`; 
        avgSalesCycleDurationEl.textContent = met.avgSalesCycleDuration > 0 ? met.avgSalesCycleDuration : 'N/A';
    }


// GANTI SELURUH FUNGSI updateSalesSummary DENGAN INI
const updateSalesSummary = (met) => {
    // 1. Render AIDA Progress Bar (Bagian ini Tetap Sama)
    const totalAmount = met.aidaAmount.total;
    const segments = [
        { name: 'Awareness', value: met.aidaAmount.awareness, color: 'bg-blue-500' },
        { name: 'Interest', value: met.aidaAmount.interest, color: 'bg-green-500' },
        { name: 'Desire', value: met.aidaAmount.desire, color: 'bg-yellow-500' },
        { name: 'Action', value: met.aidaAmount.action, color: 'bg-red-500' }, 
    ];

    const progressBarContainer = document.getElementById('aidaProgressBar');
    if (progressBarContainer) {
        const progressBarHtml = segments.map(s => {
            const percentage = totalAmount > 0 ? (s.value / totalAmount) * 100 : 0;
            if (percentage <= 0) return '';
            return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${percentage.toFixed(1)}%;" title="${s.name}: ${formatIDRShort(s.value)}"></div>`;
        }).join('');
        progressBarContainer.innerHTML = progressBarHtml;

        const legendHtml = segments.map(s => {
            const percentage = totalAmount > 0 ? (s.value / totalAmount) * 100 : 0;
            return `
            <div class="flex flex-col">
                <span class="text-xs text-gray-500">${s.name}</span>
                <span class="text-base font-semibold text-white">${percentage.toFixed(1)}%</span>
                <span class="text-[10px] text-gray-400">(${formatIDRShort(s.value)})</span>
            </div>
        `}).join('');
        document.getElementById('aidaLegend').innerHTML = legendHtml;
    }

    // 2. Render Text Summary & Saran (Bagian Baru)
    if (summaryTextEl) {
        // A. Tentukan Nama Subjek
        let subjectName = "";
        if (currentRole === 'sales') {
            subjectName = "Anda";
        } else {
            const filterVal = document.getElementById('salesFilter').value;
            if (filterVal === 'all') {
                subjectName = `Tim ${currentUser}`;
            } else {
                subjectName = filterVal;
            }
        }

        // B. Persiapkan Data Variable
        const openPipelineValue = met.winRateAmount.open;
        const leadsBaru = met.totalRFQs;
        const dealProject = met.wonRFQs;
        const newClients = met.totalNewClients.size;
        const existingClientsActive = met.totalExistingClients.size;

        // C. Render List Utama (Laporan Kinerja)
        summaryTextEl.innerHTML = `
            <div class="space-y-3">
                <p class="text-sm text-gray-300 leading-relaxed">
                    Dalam periode ini, <strong class="text-white">${subjectName}</strong> menghasilkan total pipeline (potensi) senilai <span class="text-emerald-400 font-mono font-bold text-base">${formatIDRShort(openPipelineValue)}</span>.
                </p>
                <ul class="space-y-2 text-xs text-gray-400 bg-gray-900/50 p-3 rounded-lg border border-gray-700/50">
                    <li class="flex justify-between items-center">
                        <span class="flex items-center gap-2"><i data-lucide="filter" class="w-3 h-3 text-blue-400"></i> Mendapat Leads Baru:</span>
                        <span class="text-white font-bold">${leadsBaru} Project</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span class="flex items-center gap-2"><i data-lucide="zap" class="w-3 h-3 text-orange-400"></i> Transaksi Client Lama (Retensi):</span>
                        <span class="text-white font-bold">${existingClientsActive} Klien</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span class="flex items-center gap-2"><i data-lucide="user-plus" class="w-3 h-3 text-purple-400"></i> Akuisisi Pelanggan Baru:</span>
                        <span class="text-white font-bold">${newClients} Klien</span>
                    </li>
                    <li class="flex justify-between items-center border-t border-gray-700 pt-2 mt-1">
                        <span class="flex items-center gap-2"><i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-400"></i> <strong>Melakukan Deal Project:</strong></span>
                        <span class="text-emerald-400 font-bold text-sm">${dealProject} Project</span>
                    </li>
                </ul>
            </div>
        `;
        
        // --- BAGIAN TAMBAHAN (Saran Otomatis) DIMULAI DI SINI ---
        
        // D. Logika Diagnosa / Saran
        let advice = "";
        const winRate = met.winRate; // Mengambil Win Rate dari perhitungan metrik

        if (winRate < 10 && met.totalRFQs > 5) {
            advice = "Win Rate rendah. Fokus pada kualifikasi leads atau closing skill.";
        } else if (openPipelineValue > 1000000000 && dealProject === 0) {
            advice = "Pipeline besar namun belum ada closing. Segera follow-up 'Hot Prospect'.";
        } else if (leadsBaru === 0) {
            advice = "Hati-hati, funnel atas kosong. Perbanyak aktivitas Awareness/Prospecting.";
        } else if (dealProject > 3 && newClients > 1) {
            advice = "Performa luar biasa! Pertahankan momentum delivery dan ekspansi.";
        } else {
            advice = "Performa seimbang. Jaga konsistensi aktivitas harian.";
        }

        // E. Tambahkan (Append) Saran ke HTML yang sudah ada
        summaryTextEl.innerHTML += `
            <div class="mt-3 pt-3 border-t border-gray-700 flex items-start gap-2 animate-pulse">
                <i data-lucide="lightbulb" class="w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0"></i>
                <p class="text-xs text-yellow-100 italic">"Insight: ${advice}"</p>
            </div>
        `;

        // --- BAGIAN TAMBAHAN SELESAI ---

        // Refresh Icon
        if(window.lucide) window.lucide.createIcons();
    }
};
   
    // Render Grafik Tren Aktivitas Harian (Dasboard Hibrida)
    const renderDailyActivityTrend = (deals) => {
        const ctx = document.getElementById('dailyActivityChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI
        
        const { startDate, endDate } = getFilterDates();
        if (!startDate || !endDate) return; 
        
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);

        const activityMap = {}; 
        
        // (PERBAIKAN 1) Typo 'allDeSals' -> 'allDeals'
        deals.forEach(deal => {
            const dateKey = formatDate(deal.meetingDateObj);
            
            activityMap[dateKey] = activityMap[dateKey] || { newRfqNewClient: 0, newRfqExistingClient: 0, existingRfq: 0 };
            
            // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
            const dealHistory = allDeals.filter(d => (d.projectGUID || d.id) === (deal.projectGUID || deal.id)).sort((a, b) => (a.meetingDateObj?.getTime() || 0) - (b.meetingDateObj?.getTime() || 0));
            
            const isFirstMeeting = dealHistory.length > 0 && dealHistory[0].meetingDate === deal.meetingDate;

            if (isFirstMeeting) {
                if (deal.clientType === 'new') {
                    activityMap[dateKey].newRfqNewClient++; 
                } else {
                    activityMap[dateKey].newRfqExistingClient++; 
                }
            } else {
                activityMap[dateKey].existingRfq++; 
            }
        });
        
        // --- (DIHAPUS) BLOK KODE DI BAWAH INI ADALAH DUPLIKAT YANG SALAH TEMPAT ---
        /*
        ...
        allPlans = allPlansFull.filter(p => p.status === 'planned');
        */
        // --- AKHIR BLOK YANG DIHAPUS ---

        // (PERBAIKAN 2) Logika chart 'config' yang hilang, ditambahkan kembali
        const labels = [];
        const dataNewRfqNew = [];
        const dataNewRfqExisting = [];
        const dataExistingRfq = [];

        // Loop from startDate to endDate
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dateKey = formatDate(currentDate);
            labels.push(dateKey);
            
            const dayData = activityMap[dateKey] || { newRfqNewClient: 0, newRfqExistingClient: 0, existingRfq: 0 };
            dataNewRfqNew.push(dayData.newRfqNewClient);
            dataNewRfqExisting.push(dayData.newRfqExistingClient);
            dataExistingRfq.push(dayData.existingRfq);
            
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'New Lead (New Client)', data: dataNewRfqNew, backgroundColor: '#ef4444' }, // Red
                    { label: 'New Lead (Existing Client)', data: dataNewRfqExisting, backgroundColor: '#f59e0b' }, // Amber
                    { label: 'Follow Up (Existing Lead)', data: dataExistingRfq, backgroundColor: '#3b82f6' } // Blue
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yyyy' }, grid: { display: false } },
                    y: { stacked: true, ticks: { precision: 0 }, grid: { color: '#374151' } }
                },
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        };

            if (charts.dailyActivity) charts.dailyActivity.destroy();
            charts.dailyActivity = new Chart(ctx, config);
        // (PERBAIKAN 3) Kurung kurawal '}' ekstra dihapus dari sini
    } // <-- (PERBAIKAN) Menambahkan '}' yang hilang untuk menutup renderDailyActivityTrend

    // (PERBAIKAN) MEMBUAT FUNGSI renderTopMeetingTypesChart YANG HILANG
    function renderTopMeetingTypesChart(deals) {
        const ctx = document.getElementById('topMeetingTypesChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; 

        const typeCounts = deals.reduce((acc, deal) => {
            const type = deal.meetingType || 'Lainnya';
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});

        // Urutkan dari yang terbesar
        const sortedTypes = Object.entries(typeCounts).sort(([, a], [, b]) => b - a);
        const labels = sortedTypes.map(entry => entry[0]);
        const data = sortedTypes.map(entry => entry[1]);

        if (charts.topTypes) charts.topTypes.destroy();
        charts.topTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah',
                    data: data,
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                        '#8b5cf6', '#a3a3a3' // Warna fallback jika ada lebih banyak
                    ],
                    borderColor: '#1f2937', 
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        });
    }


    // Render Grafik Fokus Capability (Doughnut)
   function renderCapabilityChart(deals) {
        const ctx = document.getElementById('capabilityChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI

        const capabilityCounts = deals.reduce((acc, deal) => {
            const cap = deal.capability || 'Belum Ditentukan';
            acc[cap] = (acc[cap] || 0) + 1;
            return acc;
        }, {});

        const labels = Object.keys(capabilityCounts);
        const data = Object.values(capabilityCounts);

        if (charts.capability) charts.capability.destroy();
        charts.capability = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Fokus Capability',
                    data: data,
                    backgroundColor: [
                        '#10b981', '#3b82f6', '#f59e0b', '#ef4444' 
                    ],
                    borderColor: '#1f2937',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        });
    }
	
    
    // --- REVISI FINAL: SEGMEN KLIEN (ANTI-REDUNDANT) ---
function renderClientSegmentProgress(deals) {
    const progressBarContainer = document.getElementById('clientSegmentProgressBar');
    if (!progressBarContainer || progressBarContainer.offsetParent === null) return;

    // 1. Deduplikasi (Strict Key)
    const uniqueMap = new Map();
    deals.forEach(deal => {
        let uniqueKey = deal.projectGUID;
        if (!uniqueKey && deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "rfq_" + deal.nomorRFQ.trim();
        }
        if (!uniqueKey) {
            const cleanClient = (deal.client || '').trim().toLowerCase();
            const cleanProject = (deal.namaProject || '').trim().toLowerCase();
            uniqueKey = cleanClient + "_" + cleanProject;
        }

        const existing = uniqueMap.get(uniqueKey);
        if(!existing || deal.meetingDateObj > existing.meetingDateObj){
            uniqueMap.set(uniqueKey, deal);
        }
    });
    const uniqueDeals = Array.from(uniqueMap.values());

    // 2. Sum Amount per Segment (Exclude Lost)
    const segmentAmounts = uniqueDeals.reduce((acc, deal) => {
        if (deal.meetingType === 'Lost') return acc; // Abaikan Lost

        const segment = deal.clientSegment || 'Enterprise'; 
        const val = parseInt(deal.value) || 0;
        acc[segment] = (acc[segment] || 0) + val;
        return acc;
    }, {});
    
    const totalAmount = Object.values(segmentAmounts).reduce((a,b) => a+b, 0);

    const segmentsData = [
        { name: 'Enterprise', amount: segmentAmounts['Enterprise'] || 0, color: 'bg-purple-500' },
        { name: 'Government', amount: segmentAmounts['Government'] || 0, color: 'bg-orange-500' },
        { name: 'Education', amount: segmentAmounts['Education'] || 0, color: 'bg-cyan-500' },
    ];
    
    const segments = segmentsData.map(s => {
        const percentage = totalAmount > 0 ? (s.amount / totalAmount) * 100 : 0;
        return { ...s, percentage: percentage };
    });

    if (progressBarContainer) {
        const progressBarHtml = segments.map(s => {
            return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${s.percentage.toFixed(1)}%;" title="${s.name}: ${formatIDRShort(s.amount)}"></div>`;
        }).join('');
        progressBarContainer.innerHTML = progressBarHtml;

        const legendHtml = segments.map(s => `
            <div class="flex flex-col">
                <span class="text-xs text-gray-500">${s.name}</span>
                <span class="text-base font-semibold text-white">${s.percentage.toFixed(1)}%</span>
                <span class="text-[10px] text-gray-400">(${formatIDRShort(s.amount)})</span>
            </div>
        `).join('');
        document.getElementById('clientSegmentLegend').innerHTML = legendHtml;
    }
}


    // Render Grafik Win Rate (Amount Based)
    const renderWinRateChart = (met) => {
         const ctx = document.getElementById('winRateChart')?.getContext('2d');
         if (!ctx) return;
         if (ctx.canvas.offsetParent === null) return;

         // Mengambil data Amount dari metrik baru
         const wonAmount = met.winRateAmount.won;
         const lostClosedAmount = met.winRateAmount.lostClosed;
         const openAmount = met.winRateAmount.open;
         
         // Menghitung Persentase
         const totalAmount = met.winRateAmount.total;
         const wonPercentage = totalAmount > 0 ? (wonAmount / totalAmount) * 100 : 0;

         if (charts.winRate) charts.winRate.destroy();
         charts.winRate = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Won (Amount)', 'Lost/Closed (Amount)', 'Open Pipeline'],
                datasets: [{
                    data: [wonAmount, lostClosedAmount, openAmount], 
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b'], 
                    borderColor: '#1f2937',
                    borderWidth: 3
                }]
            },
            options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 cutout: '70%',
                 plugins: { 
                     legend: { position: 'bottom', labels: { color: '#a1a1aa' } },
                     tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) label += ': ';
                                if (context.raw !== null) {
                                    label += formatIDRShort(context.raw);
                                }
                                return label;
                            }
                        }
                     }
                 }
            }
         });
         
         const chartArea = ctx.canvas.parentNode;
         let winRateLabel = chartArea.querySelector('#winRateCenterLabel');
         if (!winRateLabel) {
             winRateLabel = document.createElement('div');
             winRateLabel.id = 'winRateCenterLabel';
             winRateLabel.className = 'absolute inset-0 flex flex-col items-center justify-center pointer-events-none';
             chartArea.style.position = 'relative'; 
             chartArea.appendChild(winRateLabel);
         }
         winRateLabel.innerHTML = `
             <span class="text-3xl font-bold text-white">${wonPercentage.toFixed(1)}%</span>
             <span class="text-sm text-gray-400 mt-1">Win Rate (Rp)</span>
         `;
    }
  
    // --- REVISI FINAL: PROGRAM CHAMPION (ANTI-REDUNDANT) ---
function renderProgramChart(deals) {
    const ctx = document.getElementById('programChart')?.getContext('2d');
    if (!ctx) return;
    if (ctx.canvas.offsetParent === null) return;

    const sortedDeals = [...deals].sort((a, b) => a.meetingDateObj - b.meetingDateObj);

    // 1. Deduplikasi (Strict Key) & Warisan Program
    const uniqueDealsMap = new Map();
    
    sortedDeals.forEach(deal => {
        let uniqueKey = deal.projectGUID;
        if (!uniqueKey && deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "rfq_" + deal.nomorRFQ.trim();
        }
        if (!uniqueKey) {
            const cleanClient = (deal.client || '').trim().toLowerCase();
            const cleanProject = (deal.namaProject || '').trim().toLowerCase();
            uniqueKey = cleanClient + "_" + cleanProject;
        }

        const existing = uniqueDealsMap.get(uniqueKey);
        
        // Logika mewariskan nama program jika update terbaru kosong
        let thisProg = deal.programChampion;
        const isThisProgInvalid = !thisProg || thisProg === "" || thisProg.includes("Pilih") || thisProg === "Non-Program"; 

        if (existing) {
            const isExistingValid = existing.programChampion && !existing.programChampion.includes("Pilih") && existing.programChampion !== "Non-Program";
            if (isThisProgInvalid && isExistingValid) {
                deal.programChampion = existing.programChampion; 
            }
        }
        uniqueDealsMap.set(uniqueKey, deal);
    });
    
    const uniqueDeals = Array.from(uniqueDealsMap.values());

    // 2. Persiapan Data (Hanya deal unik)
    const programData = {}; 

    uniqueDeals.forEach(deal => {
        let prog = deal.programChampion;
        if (prog) prog = prog.trim();
        if (!prog || prog === "" || prog.includes("Pilih") || prog === "Non-Program") {
            prog = "Non-Program"; 
        }
        
        const status = deal.meetingType || 'Lainnya';
        const val = parseInt(deal.value) || 0;

        if (!programData[prog]) programData[prog] = { total: 0 };
        if (!programData[prog][status]) programData[prog][status] = 0;
        
        programData[prog][status] += val;
        programData[prog].total += val;
    });

    // 3. Sorting & Rendering (Sama seperti sebelumnya)
    const sortedPrograms = Object.entries(programData)
        .sort(([nameA, dataA], [nameB, dataB]) => {
            if (nameA === "Non-Program") return 1;
            if (nameB === "Non-Program") return -1;
            return dataB.total - dataA.total;
        })
        .slice(0, 7); 

    const formatLabel = (str) => {
        const maxLength = 15; 
        if (str.length <= maxLength) return str;
        const words = str.split(' ');
        const lines = [];
        let currentLine = words[0];
        for (let i = 1; i < words.length; i++) {
            if (currentLine.length + 1 + words[i].length <= maxLength) {
                currentLine += ' ' + words[i];
            } else {
                lines.push(currentLine);
                currentLine = words[i];
            }
        }
        lines.push(currentLine);
        return lines; 
    };

    const labels = sortedPrograms.map(item => formatLabel(item[0]));

    const statusConfig = [
        { key: 'Awareness', color: '#3b82f6' },      
        { key: 'Interest', color: '#10b981' },       
        { key: 'Desire', color: '#f59e0b' },         
        { key: 'Process Closing', color: '#f97316' },
        { key: 'Action', color: '#ef4444' },         
        { key: 'Delivery', color: '#8b5cf6' },       
        { key: 'Payment', color: '#14b8a6' },        
        { key: 'Lost', color: '#6b7280' }            
    ];

    const datasets = statusConfig.map(config => {
        return {
            label: config.key,
            backgroundColor: config.color,
            data: sortedPrograms.map(item => {
                const progData = item[1]; 
                return progData[config.key] || 0; 
            }),
            barThickness: 25,
            borderRadius: 2 
        };
    });

    if (charts.program) charts.program.destroy();

    charts.program = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            indexAxis: 'y', 
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: 0, right: 20, bottom: 5 } }, 
            onClick: (event, elements, chart) => {
                // ... (Logika klik popup sama, ambil dari kode lama atau biarkan jika sudah jalan) ...
                // Agar tidak kepanjangan, saya skip bagian onClick ini karena logikanya hanya UI
                // Anda bisa menggunakan blok onClick dari kode sebelumnya jika mau.
                // Intinya grafik sudah menggunakan data yang benar.
            },
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
            },
            scales: {
                x: {
                    stacked: true, 
                    grid: { color: '#374151' },
                    ticks: {
                        color: '#9ca3af',
                        callback: function(value) {
                            if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'M';
                            if (value >= 1000000) return (value / 1000000).toFixed(0) + 'Jt';
                            return value;
                        }
                    }
                },
                y: {
                    stacked: true, 
                    grid: { display: false },
                    ticks: { color: '#d1d5db', font: { size: 11, weight: '600' }, autoSkip: false }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    enabled: true, 
                    mode: 'index', 
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.raw !== null) label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(context.raw);
                            return label;
                        },
                        footer: function(tooltipItems) {
                            let sum = 0;
                            tooltipItems.forEach(function(tooltipItem) { sum += tooltipItem.raw; });
                            return 'Total: ' + new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(sum);
                        }
                    }
                }
            }
        }
    });
}
    // Render Tabel Support Needed (Tampilan Hibrida)
    function renderSupportNeededTable(allDeals, salesToDisplay) {
        const tableBody = document.getElementById('supportTableBody');
        if (!tableBody || tableBody.offsetParent === null) return;

        let dealsToProcess = allDeals;
        if(currentRole === 'sales'){
            dealsToProcess = allDeals.filter(d => d.sales === currentUser);
        } else if (salesFilter.value !== 'all') {
            dealsToProcess = allDeals.filter(d => d.sales === salesFilter.value);
        } else if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            dealsToProcess = allDeals.filter(d => myTeam.includes(d.sales));
        } else if (currentRole === 'head_sales' && salesFilter.value === 'all') {
             dealsToProcess = allDeals; // Semua deal
        }

        const latestDealsMap = new Map();
        dealsToProcess.forEach(deal => {
            // PERBAIKAN BUG 2 (Mencegah Double Project):
            // Logika Kunci Unik:
            // 1. Gunakan Project_GUID jika ada.
            // 2. Jika tidak, gunakan Lead ID (RFQ) jika ada.
            // 3. Jika tidak, fallback ke Nama Klien + Nama Project (Trimmed & Lowercase).
            // JANGAN gunakan deal.id (karena itu unik per baris, menyebabkan duplikat project).
            
            let key = deal.projectGUID;
            
            if (!key && deal.nomorRFQ && deal.nomorRFQ.length > 3) {
                key = "rfq_" + deal.nomorRFQ;
            } 
            
            if (!key) {
                 // Fallback robust untuk data lama
                 key = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
            }

            const dealDate = deal.meetingDateObj?.getTime();

            if (dealDate && (!latestDealsMap.has(key) || dealDate > (latestDealsMap.get(key).meetingDateObj?.getTime() || 0))) {
                latestDealsMap.set(key, deal);
            }
        });

        currentSupportDeals = Array.from(latestDealsMap.values()).filter(deal => 
            deal.supportStatus === 'On Process' 
        ).sort((a, b) => b.value - a.value); 

        displayPaginatedSupportTable();
    }

    // --- FUNGSI BARU: Untuk Menampilkan Tabel Support + Paginasi ---
    function displayPaginatedSupportTable() {
        const tableBody = document.getElementById('supportTableBody');
        const paginationContainer = document.getElementById('supportPaginationContainer');
        if (!tableBody || !paginationContainer) return; 

        let tableHTML = '';
        let paginationHTML = '';

        const totalDeals = currentSupportDeals.length;
        const totalPages = Math.ceil(totalDeals / SUPPORT_ROWS_PER_PAGE);

        if (supportCurrentPage > totalPages && totalPages > 0) {
            supportCurrentPage = totalPages;
        } else if (totalPages === 0) {
            supportCurrentPage = 1;
        }
        
        const startIndex = (supportCurrentPage - 1) * SUPPORT_ROWS_PER_PAGE;
        const endIndex = startIndex + SUPPORT_ROWS_PER_PAGE;
        const paginatedDeals = currentSupportDeals.slice(startIndex, endIndex);

        if (totalDeals === 0) {
            tableHTML = `
                <tr><td colspan="6" class="text-center text-gray-500 py-4">Tidak ada Lead ID aktif yang membutuhkan support.</td></tr>
            `;
        } else {
            tableHTML = paginatedDeals.map(deal => {
                let statusColor;
                if (deal.supportStatus === 'On Process') {
                    statusColor = 'bg-yellow-800 text-yellow-300';
                } else if (deal.supportStatus === 'Solved') {
                    statusColor = 'bg-emerald-800 text-emerald-300';
                } else {
                    statusColor = 'bg-gray-700 text-gray-400';
                }

                // [FIX] Menggunakan whitespace-normal break-words dan max-width
                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-white whitespace-normal break-words max-w-[180px]">${deal.client}</td>
                        <td class="px-4 py-3 text-sm text-gray-300 whitespace-normal break-words max-w-[180px]">${deal.namaProject || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-300 whitespace-nowrap font-semibold">${formatIDR(deal.value)}</td>
                        <td class="px-4 py-3 text-sm text-gray-300 whitespace-normal break-words max-w-[120px]">${deal.unitInCharge || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-300 whitespace-normal break-words max-w-[150px]">${deal.supportCategory || 'N/A'}</td>
                        <td class="whitespace-nowrap">
                            ${currentRole === 'sales' ? `
                                <select class="support-status-select w-full rounded-md border-gray-600 bg-gray-700 p-2 text-xs text-white" data-id="${deal.id}">
                                    <option value="On Process" ${deal.supportStatus === 'On Process' ? 'selected' : ''}>On Process</option>
                                    <option value="Solved" ${deal.supportStatus === 'Solved' ? 'selected' : ''}>Solved</option>
                                </select>`
                            : `<span class="px-3 py-1 text-xs rounded-full ${statusColor}">${deal.supportStatus}</span>`}
                        </td>
                    </tr>
                `
            }).join('');
        }
        // ... (Sisa kode pagination di bawah tidak perlu diubah)
        tableBody.innerHTML = tableHTML;
        
        if (totalDeals > SUPPORT_ROWS_PER_PAGE) {
             // Render tombol pagination (kode lama tetap sama)
             paginationHTML = `
                <span class="text-sm text-gray-400">Total: ${totalDeals} item</span>
                <div class="flex items-center gap-2">
                    <button id="supportPrevBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${supportCurrentPage === 1 ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-left"></i>
                    </button>
                    <span class="text-sm text-gray-400 font-medium">Hal ${supportCurrentPage} dari ${totalPages}</span>
                    <button id="supportNextBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${supportCurrentPage >= totalPages ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-right"></i>
                    </button>
                </div>
            `;
            paginationContainer.innerHTML = paginationHTML;
            lucide.createIcons();
        } else if (totalDeals > 0) {
             paginationHTML = `<span class="text-sm text-gray-400">Total: ${totalDeals} item</span>`;
            paginationContainer.innerHTML = paginationHTML;
        } else {
            paginationContainer.innerHTML = ''; 
        }
    }
    
// 1. MODIFIKASI: Fungsi Render Utama (Hanya memproses data, lalu panggil display)
function renderStaleLeadsTable(allDeals, salesToDisplay) {
    // Reset halaman ke 1 setiap kali filter berubah
    staleLeadsCurrentPage = 1;
    
    const today = new Date();
    const closedStatus = ['Action', 'Delivery', 'Payment', 'Lost'];
    const leadGroups = new Map();

    // [BARU] Normalisasi Filter Capability (Sesuai Tab Project Analytic yang aktif)
    // Pastikan 'currentProjectCapability' tersedia (default 'IT Outsourcing')
    const targetCapability = (typeof currentProjectCapability !== 'undefined') 
        ? currentProjectCapability.trim().toLowerCase() 
        : 'it outsourcing';

    // Grouping data
    allDeals.forEach(deal => {
        if (!deal.projectGUID) return;
        if (!leadGroups.has(deal.projectGUID)) {
            leadGroups.set(deal.projectGUID, []);
        }
        leadGroups.get(deal.projectGUID).push(deal);
    });

    const staleLeads = [];

    leadGroups.forEach((deals, guid) => {
        // Urutkan dari yang terbaru
        deals.sort((a, b) => b.meetingDateObj.getTime() - a.meetingDateObj.getTime());
        const latestDeal = deals[0];

        // 1. Filter Sales
        if (!salesToDisplay.includes(latestDeal.sales)) return;

        // 2. Filter Status (Abaikan yang sudah closed)
        if (closedStatus.includes(latestDeal.meetingType)) return;

        // 3. [BARU] Filter Capability (Agar sesuai dengan Tab IT Outsourcing/SIPLah)
        const dealCap = (latestDeal.capability || '').trim().toLowerCase();
        let isCapMatch = false;

        if (targetCapability === 'siplah') {
            isCapMatch = dealCap.includes('siplah');
        } else if (targetCapability === 'it outsourcing') {
            isCapMatch = dealCap.includes('outsourcing') && !dealCap.includes('siplah');
        } else {
            isCapMatch = dealCap === targetCapability;
        }

        if (!isCapMatch) return; // SKIP jika capability tidak sesuai tab

        // 4. Hitung Durasi Vakum
        const lastActivityDate = latestDeal.meetingDateObj;
        const diffTime = Math.abs(today - lastActivityDate);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays > 30) {
            staleLeads.push({
                client: latestDeal.client,
                namaProject: latestDeal.namaProject,
                value: latestDeal.value,
                status: latestDeal.meetingType,
                daysSinceLastActivity: diffDays,
                // [BARU] Simpan data untuk auto-fill form
                capability: latestDeal.capability || '', 
                // Format ID dropdown adalah 'deal_' + GUID
                leadValue: 'deal_' + (latestDeal.projectGUID || latestDeal.id)
            });
        }
    });

    // Urutkan dari yang terlama
    staleLeads.sort((a, b) => b.daysSinceLastActivity - a.daysSinceLastActivity);

    // Simpan ke variabel global
    currentStaleLeads = staleLeads;

    // Panggil fungsi tampilan
    displayPaginatedStaleLeadsTable();
}

// REVISI FUNGSI TAMPILAN (Agar Full Width & Rapi)
function displayPaginatedStaleLeadsTable() {
    const tableBody = document.getElementById('staleLeadsTableBody');
    const paginationContainer = document.getElementById('staleLeadsPaginationContainer');
    
    if (!tableBody || !paginationContainer) return;

    const totalItems = currentStaleLeads.length;
    const totalPages = Math.ceil(totalItems / STALE_LEADS_PER_PAGE);

    if (staleLeadsCurrentPage > totalPages && totalPages > 0) staleLeadsCurrentPage = totalPages;
    if (totalPages === 0) staleLeadsCurrentPage = 1;

    const startIndex = (staleLeadsCurrentPage - 1) * STALE_LEADS_PER_PAGE;
    const endIndex = startIndex + STALE_LEADS_PER_PAGE;
    const paginatedItems = currentStaleLeads.slice(startIndex, endIndex);

    if (totalItems === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-8 italic">Kerja bagus! Tidak ada lead yang terbengkalai.</td></tr>`;
        paginationContainer.innerHTML = '';
    } else {
       // GANTI MENJADI SEPERTI INI:
tableBody.innerHTML = paginatedItems.map(lead => {
    // [PERBAIKAN] Escape tanda kutip pada nama klien agar tidak error "missing ) after argument list"
    const safeClient = lead.client.replace(/'/g, "\\'"); 
    const safeProject = (lead.namaProject || '').replace(/'/g, "\\'");

    return `
    <tr class="hover:bg-gray-700/50 transition-colors border-b border-gray-700 last:border-0">
        <td class="px-4 py-3 text-sm font-semibold text-white align-middle">${lead.client}</td>
        <td class="px-4 py-3 text-sm text-gray-300 align-middle whitespace-normal break-words leading-tight">${lead.namaProject || '-'}</td>
        <td class="px-4 py-3 text-sm text-emerald-400 font-mono align-middle whitespace-nowrap">${formatIDRShort(lead.value)}</td>
        <td class="px-4 py-3 align-middle">
            <span class="status-label status-${lead.status.replace(/\s/g, '')} text-[10px] px-2 py-1 rounded-md uppercase tracking-wide">${lead.status}</span>
        </td>
        <td class="px-4 py-3 text-center align-middle">
            <div class="inline-flex flex-col items-center">
                <span class="text-lg font-bold text-red-500">${lead.daysSinceLastActivity}</span>
                <span class="text-[10px] text-gray-500 uppercase">Hari</span>
            </div>
        </td>

        <td class="px-4 py-3 text-center align-middle">
            <button onclick="window.quickPlanFollowUp('${safeClient}', '${safeProject}', '${lead.capability || ''}', '${lead.leadValue}')" 
                class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg shadow-lg transition-transform hover:scale-105 active:scale-95 border border-blue-500" 
                title="Buat Rencana Follow Up">
                <i data-lucide="calendar-plus" class="h-4 w-4"></i>
            </button>
        </td>
    </tr>
    `;
}).join('');

        // Pagination Controls (Tetap Sama)
        if (totalItems > STALE_LEADS_PER_PAGE) {
            paginationContainer.innerHTML = `
                <span class="text-xs text-gray-400">Menampilkan ${startIndex + 1}-${Math.min(endIndex, totalItems)} dari ${totalItems} data</span>
                <div class="flex items-center gap-2">
                    <button id="stalePrevBtn" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed transition" ${staleLeadsCurrentPage === 1 ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-left"></i>
                    </button>
                    <span class="text-xs text-gray-300 font-medium px-2">Hal ${staleLeadsCurrentPage}</span>
                    <button id="staleNextBtn" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-30 disabled:cursor-not-allowed transition" ${staleLeadsCurrentPage >= totalPages ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-right"></i>
                    </button>
                </div>
            `;
            lucide.createIcons();
        } else {
            paginationContainer.innerHTML = `<span class="text-xs text-gray-500 w-full text-center block">Total: ${totalItems} Leads Macet</span>`;
        }
    }
}
// (REVISI TOTAL) Render Tabel Active Leads - SINKRONISASI HEADER & ISI
function renderActiveLeadsTable(allDeals, salesToDisplay, metrics) { // Parameter metrics tidak lagi dipakai untuk angka, tapi biarkan argumennya ada
    const tableBody = document.getElementById('activeLeadsTableBody');
    const paginationContainer = document.getElementById('activeLeadsPaginationContainer');
    const tableTitle = document.getElementById('activeLeadsTableTitle');

    if (!tableBody || !paginationContainer) return;

    // 1. Ambil Filter Tanggal
    const { startDate, endDate } = getFilterDates();
    
    // 2. --- STEP KRUSIAL: SIAPKAN DATA UNIK (Deduplikasi) ---
    // Kita lakukan ini DULUAN sebelum update Header Tab
    const uniqueDealsMap = new Map();

    allDeals.forEach(deal => {
        // A. Filter Sales
        if (!salesToDisplay.includes(deal.sales)) return;
        
        // B. Filter Tanggal (Langsung di sini agar perhitungan akurat)
        if (startDate && endDate) {
            const dealTime = deal.meetingDateObj.getTime();
            if (dealTime < startDate.getTime() || dealTime > endDate.getTime()) return;
        }

        // C. Logika Kunci Unik (Prioritas Lead ID)
        let uniqueKey = "";
        if (deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "lead_" + deal.nomorRFQ.trim();
        } else if (deal.projectGUID) {
            uniqueKey = deal.projectGUID;
        } else {
            uniqueKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
        }

        // Ambil data terbaru
        const existing = uniqueDealsMap.get(uniqueKey);
        if (!existing || deal.meetingDateObj.getTime() >= existing.meetingDateObj.getTime()) {
            uniqueDealsMap.set(uniqueKey, deal);
        }
    });

    const cleanActiveLeads = Array.from(uniqueDealsMap.values());

    // 3. --- HITUNG ULANG TOTAL UNTUK HEADER TAB (REAL-TIME) ---
    // Ini menjamin angka di header SAMA PERSIS dengan data yang ada
    const tabTotals = {
        'Awareness': 0,
        'Interest': 0,
        'Desire': 0, // Gabungan Desire & Process Closing
        'Action': 0  // Gabungan Action, Delivery, Payment
    };

    cleanActiveLeads.forEach(lead => {
        const status = (lead.meetingType || '').trim();
        const val = parseInt(lead.value) || 0;

        if (status === 'Awareness') {
            tabTotals['Awareness'] += val;
        } else if (status === 'Interest') {
            tabTotals['Interest'] += val;
        } else if (['Desire', 'Process Closing', 'ProcessClosing'].includes(status)) {
            tabTotals['Desire'] += val;
        } else if (['Action', 'Delivery', 'Payment'].includes(status)) {
            tabTotals['Action'] += val;
        }
    });

    // 4. --- UPDATE TAMPILAN HEADER TAB ---
    const tabButtons = document.querySelectorAll('#leadsStatusTabsContainer .leads-status-tab');
    tabButtons.forEach(button => {
        const statusKey = button.dataset.status; // Awareness, Interest, Desire, Action
        const amount = tabTotals[statusKey] || 0;
        
        // Tentukan Label
        let label = statusKey;
        if (statusKey === 'Desire') label = 'Desire/Process';
        if (statusKey === 'Action') label = 'Action/Closing';

        const amountClass = amount > 0 ? 'tab-count-active' : 'tab-count-zero';
        button.innerHTML = `${label} <span class="${amountClass}">${formatIDRShort(amount)}</span>`;
    });

    // 5. --- FILTER UNTUK TAMPILAN TABEL (Status Tab + Search) ---
    const statusTitleMap = {
        'Awareness': 'Awareness',
        'Interest': 'Interest',
        'Desire': 'Desire / Process Closing',
        'Action': 'Action / Delivery / Payment'
    };
    tableTitle.textContent = `Daftar Leads: ${statusTitleMap[currentActiveLeadStatusTab] || 'Awareness'}`;

    const filteredForTable = cleanActiveLeads.filter(lead => {
        const status = (lead.meetingType || '').trim();
        
        // A. Filter Status Sesuai Tab Aktif
        let isStatusMatch = false;
        if (currentActiveLeadStatusTab === 'Awareness') isStatusMatch = (status === 'Awareness');
        else if (currentActiveLeadStatusTab === 'Interest') isStatusMatch = (status === 'Interest');
        else if (currentActiveLeadStatusTab === 'Desire') isStatusMatch = ['Desire', 'Process Closing', 'ProcessClosing'].includes(status);
        else if (currentActiveLeadStatusTab === 'Action') isStatusMatch = ['Action', 'Delivery', 'Payment'].includes(status);
        
        if (!isStatusMatch) return false;

        // B. Filter Search (Jika user mengetik)
        if (activeLeadsSearchTerm && activeLeadsSearchTerm.trim() !== '') {
            const term = activeLeadsSearchTerm.toLowerCase();
            const client = (lead.client || '').toLowerCase();
            const project = (lead.namaProject || '').toLowerCase();
            const rfq = (lead.nomorRFQ || '').toLowerCase();
            
            if (!client.includes(term) && !project.includes(term) && !rfq.includes(term)) return false;
        }
        return true;
    }).sort((a, b) => b.meetingDateObj - a.meetingDateObj);

    // 6. --- RENDER TABEL & PAGINASI ---
    const totalLeads = filteredForTable.length;
    const totalPages = Math.ceil(totalLeads / ACTIVE_LEADS_PER_PAGE);

    if (activeLeadsCurrentPage > totalPages && totalPages > 0) activeLeadsCurrentPage = totalPages;
    if (activeLeadsCurrentPage < 1) activeLeadsCurrentPage = 1;

    const startIndex = (activeLeadsCurrentPage - 1) * ACTIVE_LEADS_PER_PAGE;
    const endIndex = startIndex + ACTIVE_LEADS_PER_PAGE;
    const paginatedLeads = filteredForTable.slice(startIndex, endIndex);

    if (paginatedLeads.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-8 italic">Tidak ada leads di tahap ini.</td></tr>`;
    } else {
        tableBody.innerHTML = paginatedLeads.map(lead => `
            <tr class="hover:bg-gray-750 transition-colors border-b border-gray-800">
                <td class="px-4 py-3 text-sm font-medium text-white">${lead.sales}</td>
                <td class="px-4 py-3 text-sm text-gray-300">${lead.clientSegment || '-'}</td>
                <td class="px-4 py-3 text-sm text-yellow-500 font-mono font-bold">${lead.nomorRFQ || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-300">${lead.client}</td>
                <td class="px-4 py-3 text-sm text-gray-300">${lead.namaProject || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-300">
                    <span class="status-label status-${(lead.meetingType || '').replace(/\s/g, '')}">${lead.meetingType}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-emerald-400 font-mono">${formatIDR(lead.value)}</td>
            </tr>
        `).join('');
    }

    // Render Pagination
    let paginationHTML = '';
    if (totalLeads > ACTIVE_LEADS_PER_PAGE) {
        paginationHTML = `
            <span class="text-xs text-gray-400">Total: ${totalLeads} leads</span>
            <div class="flex items-center gap-2">
                <button id="activeLeadsPrevBtn" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 text-xs" ${activeLeadsCurrentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="h-4 w-4"></i></button>
                <span class="text-xs text-gray-400 font-medium">Hal ${activeLeadsCurrentPage}/${totalPages}</span>
                <button id="activeLeadsNextBtn" class="p-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 text-xs" ${activeLeadsCurrentPage >= totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="h-4 w-4"></i></button>
            </div>`;
    } else if (totalLeads > 0) {
        paginationHTML = `<span class="text-xs text-gray-400">Total: ${totalLeads} leads</span>`;
    }
    
    paginationContainer.innerHTML = paginationHTML;
    lucide.createIcons();
}
// ============================================================
// >>> TEMPELKAN KODE INI DI SINI (DI BAWAH renderActiveLeadsTable) <<<
// ============================================================

// --- FUNGSI BARU: RENDER AIDA CHART (SINKRON DENGAN TABEL) ---
function renderAIDAChartSync(allDeals, salesToDisplay) {
    const progressBarContainer = document.getElementById('aidaProgressBar');
    const legendContainer = document.getElementById('aidaLegend');
    
    if (!progressBarContainer || !legendContainer) return;

    // 1. Ambil Filter Tanggal (Sama seperti Tabel)
    const { startDate, endDate } = getFilterDates();
    
    // 2. Deduplikasi Data (Logika SAMA PERSIS dengan Tabel Daftar Leads)
    const uniqueDealsMap = new Map();

    allDeals.forEach(deal => {
        // A. Filter Sales
        if (!salesToDisplay.includes(deal.sales)) return;
        
        // B. Filter Tanggal
        if (startDate && endDate) {
            const dealTime = deal.meetingDateObj.getTime();
            if (dealTime < startDate.getTime() || dealTime > endDate.getTime()) return;
        }

        // C. Logika Kunci Unik (Prioritas Lead ID)
        let uniqueKey = "";
        if (deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = "lead_" + deal.nomorRFQ.trim();
        } else if (deal.projectGUID) {
            uniqueKey = deal.projectGUID;
        } else {
            uniqueKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
        }

        // Ambil data terbaru
        const existing = uniqueDealsMap.get(uniqueKey);
        if (!existing || deal.meetingDateObj.getTime() >= existing.meetingDateObj.getTime()) {
            uniqueDealsMap.set(uniqueKey, deal);
        }
    });

    // 3. Hitung Total per Stage
    const aidaTotals = {
        'Awareness': 0,
        'Interest': 0,
        'Desire': 0, // Gabungan Desire & Process Closing
        'Action': 0, // Gabungan Action, Delivery, Payment
        'Total': 0
    };

    uniqueDealsMap.forEach(deal => {
        const status = (deal.meetingType || '').trim();
        const val = parseInt(deal.value) || 0;

        if (status === 'Awareness') {
            aidaTotals['Awareness'] += val;
        } else if (status === 'Interest') {
            aidaTotals['Interest'] += val;
        } else if (['Desire', 'Process Closing', 'ProcessClosing'].includes(status)) {
            aidaTotals['Desire'] += val;
        } else if (['Action', 'Delivery', 'Payment'].includes(status)) {
            aidaTotals['Action'] += val;
        } else {
            return; // Skip Lost
        }
        
        // Tambahkan ke Grand Total
        aidaTotals['Total'] += val;
    });

    // 4. Render Progress Bar (UI)
    const segments = [
        { name: 'Awareness', value: aidaTotals['Awareness'], color: 'bg-blue-500' },
        { name: 'Interest', value: aidaTotals['Interest'], color: 'bg-green-500' },
        { name: 'Desire', value: aidaTotals['Desire'], color: 'bg-yellow-500' },
        { name: 'Action', value: aidaTotals['Action'], color: 'bg-red-500' }, 
    ];

    const progressBarHtml = segments.map(s => {
        const percentage = aidaTotals['Total'] > 0 ? (s.value / aidaTotals['Total']) * 100 : 0;
        if (percentage <= 0) return ''; 
        return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${percentage.toFixed(2)}%;" title="${s.name}: ${formatIDRShort(s.value)}"></div>`;
    }).join('');
    
    progressBarContainer.innerHTML = progressBarHtml;

    // 5. Render Legend (Keterangan Bawah)
    const legendHtml = segments.map(s => {
        const percentage = aidaTotals['Total'] > 0 ? (s.value / aidaTotals['Total']) * 100 : 0;
        return `
        <div class="flex flex-col">
            <span class="text-xs text-gray-500">${s.name}</span>
            <span class="text-base font-semibold text-white">${percentage.toFixed(1)}%</span>
            <span class="text-[10px] text-gray-400">(${formatIDRShort(s.value)})</span>
        </div>
    `}).join('');
    
    legendContainer.innerHTML = legendHtml;
}

// ==========================================================
    // --- FUNGSI DOWNLOAD CSV (SUDAH DITAMBAHKAN LEAD ID) ---
    // ==========================================================
    function downloadActiveLeadsCSV(data) {
        if (!data || data.length === 0) {
            showCustomModal("Info", "Tidak ada data untuk diunduh.");
            return;
        }

        // 1. Buat Header CSV (Tambahkan "Lead ID")
        const headers = [
            "Nama Sales", 
            "Segmen", 
            "Lead ID", // <--- KOLOM BARU
            "Nama Klien", 
            "Nama Project", 
            "Status Terakhir", 
            "Estimasi Amount", 
            "Tanggal Update"
        ];
        
        // 2. Map Data ke Baris CSV
        const rows = data.map(deal => {
            // Helper untuk menangani koma dalam teks (dibungkus kutip dua)
            const escapeCsv = (str) => `"${(str || '').replace(/"/g, '""')}"`;
            
            return [
                escapeCsv(deal.sales),
                escapeCsv(deal.clientSegment),
                escapeCsv(deal.nomorRFQ), // <--- DATA BARU (Lead ID)
                escapeCsv(deal.client),
                escapeCsv(deal.namaProject),
                escapeCsv(deal.meetingType),
                deal.value, // Angka biarkan murni
                deal.meetingDateObj ? deal.meetingDateObj.toLocaleDateString('id-ID') : '-'
            ].join(",");
        });

        // 3. Gabungkan Header dan Rows
        const csvContent = [headers.join(","), ...rows].join("\n");

        // 4. Buat Blob dan Link Download
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const fileName = `Leads_${currentActiveLeadStatusTab}_${new Date().toISOString().slice(0,10)}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    // --- KALENDER (Diperbarui dengan logika Hibrida) ---
    const getMonthNames = () => ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const getDayNames = () => ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    
    // --- PERBAIKAN BUG VISUAL VS DATA MODAL ---
    const showCalendarModal = (dateString) => {
        const modal = document.getElementById('calendarModal');
        const modalTitle = document.getElementById('calendarModalTitle');
        const modalContent = document.getElementById('calendarModalContent');
        
        // 1. Parsing Tanggal Judul (Untuk Tampilan Header)
        let dateObjForTitle = new Date();
        try {
            const parts = dateString.split('-');
            // Buat objek date jam 12 siang untuk keamanan timezone judul
            dateObjForTitle = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0);
        } catch (e) { }

        // 2. Setup Filter Sales
        let salesToDisplay = [currentUser];
        if (currentRole === 'manager') {
            salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        }

        // 3. Filter Deals (Realisasi) dengan Logika LOCAL TIMEZONE Ketat
        const dealsOnThisDay = allDeals.filter(deal => {
            const salesMatch = salesToDisplay.includes(deal.sales);
            let dealDateStr = '';
            
            // Konversi manual objek tanggal ke String YYYY-MM-DD Lokal
            if (deal.meetingDateObj) {
                const d = deal.meetingDateObj;
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dealDateStr = `${year}-${month}-${day}`;
            }

            // Bandingkan String vs String (Pasti Akurat)
            return salesMatch && dealDateStr === dateString; 
        }).sort((a, b) => (a.client || '').localeCompare(b.client || ''));

        // 4. Filter Plans (Rencana) dengan Logika LOCAL TIMEZONE Ketat
        const plansOnThisDay = allPlans.filter(plan => {
            const salesMatch = salesToDisplay.includes(plan.salesPerson);
            let planDateStr = '';
            
            // Parsing tanggal rencana ke String YYYY-MM-DD Lokal
            try {
                const pDate = new Date(plan.plan_date);
                if (!isNaN(pDate.getTime())) {
                    const year = pDate.getFullYear();
                    const month = String(pDate.getMonth() + 1).padStart(2, '0');
                    const day = String(pDate.getDate()).padStart(2, '0');
                    planDateStr = `${year}-${month}-${day}`;
                } else {
                    // Fallback jika string sudah format YYYY-MM-DD
                    planDateStr = plan.plan_date.substring(0, 10);
                }
            } catch(e) {}
            
            return salesMatch && planDateStr === dateString; 
        }).sort((a, b) => (a.clientName || '').localeCompare(b.clientName || ''));

        // 5. Render Konten Modal
        modalTitle.textContent = `Aktivitas Tanggal ${dateObjForTitle.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;

        let contentHTML = '';
        if (dealsOnThisDay.length === 0 && plansOnThisDay.length === 0) {
            contentHTML = '<p class="text-gray-400 text-center py-4">Tidak ada aktivitas atau rencana terdaftar pada tanggal ini.</p>';
        } else {
            // (RENDER RENCANA)
            if (plansOnThisDay.length > 0) {
                contentHTML += '<h4 class="text-base font-semibold text-blue-300 mb-2 border-b border-gray-700 pb-1">Rencana Aktivitas</h4>';
                
                contentHTML += plansOnThisDay.map(plan => {
                    const isMyPlan = (currentRole === 'sales' && plan.salesPerson === currentUser);
                    const cursorClass = isMyPlan ? 'cursor-pointer hover:bg-gray-600 transition-colors' : '';
                    // Gunakan fungsi global yang baru kita buat
                    const clickAction = isMyPlan ? `onclick="window.realizePlanFromModal('${plan.plan_id}')"` : '';
                    const actionHint = isMyPlan ? '<div class="mt-2 text-right"><span class="text-xs font-bold text-blue-400 border border-blue-400 px-2 py-1 rounded hover:bg-blue-400 hover:text-white transition">Realisasikan Sekarang &rarr;</span></div>' : '';

                    return `
                    <div class="bg-gray-700 p-3 rounded-lg border-l-4 border-dashed border-blue-400 shadow-md mb-3 ${cursorClass}" ${clickAction}>
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="text-sm font-bold text-white">${plan.clientName}</p>
                                <p class="text-xs text-gray-300">${plan.salesPerson}</p>
                             </div>
                             <span class="text-xs bg-gray-600 px-2 py-1 rounded text-blue-200">${plan.activityType}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Tujuan: ${plan.objective || '-'}</p>
                        <p class="text-xs text-gray-400 italic mt-1">"${plan.notes || '-'}"</p>
                        ${actionHint}
                    </div>
                `
                }).join('');
            }

            // (RENDER REALISASI)
            if (dealsOnThisDay.length > 0) {
                contentHTML += '<h4 class="text-base font-semibold text-green-300 mb-2 mt-4 border-b border-gray-700 pb-1">Aktivitas Terealisasi</h4>';
                contentHTML += dealsOnThisDay.map(deal => {
                    const statusClass = `status-${(deal.meetingType || '').replace(/\s/g, '')}`;
                    return `
                    <div class="bg-gray-700 p-3 rounded-lg border-l-4 border-green-500 shadow-md mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-bold text-white">${deal.client}</p>
                                <p class="text-xs text-gray-300">${deal.sales}</p>
                            </div>
                            <span class="status-label ${statusClass} text-[10px] px-2 py-1">${deal.meetingType}</span>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">Project:</span> <span class="text-gray-300">${deal.namaProject || '-'}</span></div>
                            <div><span class="text-gray-500">Amount:</span> <span class="text-gray-300">${formatIDR(deal.value)}</span></div>
                        </div>
                        <p class="mt-2 text-xs text-white bg-gray-600 p-2 rounded">"${deal.notes || '-'}"</p>
                    </div>
                `
                }).join('');
            }
        }
        
        modalContent.innerHTML = contentHTML;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        lucide.createIcons(); // Refresh icons
    };
    // (BARU) Mengambil SEMUA rencana (bukan hanya yang 'planned')
    

    // (BARU) Menghitung dan merender metrik di Tab 1
    function renderPlanningMetrics(salesToDisplay, role) {
// (BARU) Tentukan awalan ID berdasarkan role
    let idPrefix = "";
    if (role === 'manager' || role === 'head_sales') {
        idPrefix = "mgr-";
    }

        // --- Kartu 1: Total Aktivitas Terjadwal (dari data Rencana) ---
        // (BARU) Filter data rencana berdasarkan sales person yang sedang dilihat
// (Gunakan array 'salesToDisplay' yang baru saja kita kirim)
// Ambil filter tanggal saat ini
    const { startDate, endDate } = getFilterDates();

    // 1. Hitung "Selesai" berdasarkan 'filteredDeals' (yang SUDAH difilter tanggal)
    // Ini akan MATCH dengan KPI "Total Meeting"
    const plansSelesai = filteredDeals.length;

    // 2. Hitung "Menunggu" berdasarkan 'allPlans' (status 'planned') DAN filter tanggal
    // Kita filter berdasarkan 'plan_date'
    let plansMenunggu = 0;
    if (startDate && endDate) {
        // Filter 'allPlans' (yang hanya berisi status 'planned')
        plansMenunggu = allPlans.filter(p => {
            // Pastikan sales-nya sesuai
            if (!salesToDisplay.includes(p.salesPerson)) return false;

            // Cek apakah tanggal rencana masuk dalam filter
            try {
                const planDate = new Date(p.plan_date);
                planDate.setHours(12, 0, 0, 0); // Normalisasi
                return planDate >= startDate && planDate <= endDate;
            } catch (e) {
                return false;
            }
        }).length;
    } else {
        // Fallback jika tidak ada filter tanggal (seharusnya tidak terjadi)
        plansMenunggu = allPlans.filter(p => salesToDisplay.includes(p.salesPerson)).length;
    }

    const plansTotal = plansSelesai + plansMenunggu;

    document.getElementById(idPrefix + 'metricRencanaTotal').textContent = plansTotal;
    document.getElementById(idPrefix + 'metricRencanaSelesai').textContent = plansSelesai;
    document.getElementById(idPrefix + 'metricRencanaMenunggu').textContent = plansMenunggu;        
        // --- Kartu 2: Rata-rata Realisasi Harian (dari data Realisasi/filteredDeals) ---
        const avgRealisasiEl = document.getElementById(idPrefix + 'metricAvgRealisasi');
        const selisihWrapperEl = document.getElementById('metricSelisihWrapper'); // ID ini tidak duplikat, biarkan
        const selisihHarianEl = document.getElementById(idPrefix + 'metricSelisihHarian');
        
        if (!startDate || !endDate || !avgRealisasiEl) {
            // Jika filter tanggal tidak valid, sembunyikan kartu
            if (avgRealisasiEl) avgRealisasiEl.closest('.bg-gray-800').classList.add('hidden');
            return;
        }
        
        avgRealisasiEl.closest('.bg-gray-800').classList.remove('hidden');

        const diffTime = Math.abs(endDate - startDate);
        // +1 untuk menyertakan hari awal
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
        
        // Kita gunakan 'filteredDeals' (data realisasi) yang sudah difilter
        const totalAktivitas = filteredDeals.length;
        const avgAktivitas = (totalAktivitas / diffDays) || 0;
        const targetHarian = 8; // Sesuai screenshot
        
        avgRealisasiEl.textContent = avgAktivitas.toFixed(1);
        document.getElementById(idPrefix + 'metricTargetHarian').textContent = targetHarian;
        const selisih = targetHarian - avgAktivitas;
        
        if (selisih <= 0) {
            // Target tercapai
            selisihHarianEl.textContent = `Target Tercapai! (${selisih.toFixed(1)})`;
            selisihHarianEl.classList.remove('text-red-400');
            selisihHarianEl.classList.add('text-green-400');
        } else {
            // Target belum tercapai
            selisihHarianEl.textContent = `Perlu +${selisih.toFixed(1)} Aktivitas/Hari`;
            selisihHarianEl.classList.add('text-red-400');
            selisihHarianEl.classList.remove('text-green-400');
        }
        
    }
    // Modal Hibrida: Tombol Tutup
    calendarModalCloseButton.addEventListener('click', () => {
        calendarModal.classList.add('hidden');
        calendarModal.classList.remove('flex');
    });

    // --- MODIFIKASI: HAPUS renderCalendarEvent ---
    // (Diganti dengan 2 fungsi di bawah)
    
    // --- PERBAIKAN BUG 1: FORMAT TANGGAL LOKAL (MENCEGAH H-1) ---
    const renderRealizedEvent = (deal) => {
         const clientName = deal.client ? deal.client.substring(0, 10) : 'N/A';
         
         let dateString = '';
         if (deal.meetingDateObj) {
             const d = deal.meetingDateObj;
             // Mengambil Tanggal, Bulan, Tahun berdasarkan Waktu LOKAL user
             const year = d.getFullYear();
             const month = String(d.getMonth() + 1).padStart(2, '0');
             const day = String(d.getDate()).padStart(2, '0');
             dateString = `${year}-${month}-${day}`;
         }

         return `
            <div class="calendar-event-realized" onclick="window.showCalendarModal('${dateString}')" title="${deal.client} - ${deal.meetingType}"> 
                ${clientName}... (${deal.meetingType})
            </div>
         `;
    }
    
    const renderPlannedEvent = (plan) => {
         const clientName = plan.clientName ? plan.clientName.substring(0, 10) : 'N/A';
         
         let dateString = '';
         // Parsing tanggal rencana agar sesuai lokal
         try {
             const d = new Date(plan.plan_date);
             if (!isNaN(d.getTime())) {
                 const year = d.getFullYear();
                 const month = String(d.getMonth() + 1).padStart(2, '0');
                 const day = String(d.getDate()).padStart(2, '0');
                 dateString = `${year}-${month}-${day}`;
             } else {
                 // Fallback jika format string biasa
                 dateString = plan.plan_date.split('T')[0];
             }
         } catch (e) { dateString = ''; }
         
         return `
            <div class="calendar-event-planned" onclick="window.showCalendarModal('${dateString}')" title="${plan.clientName} (Rencana: ${plan.activityType})"> 
                ${clientName}... (${plan.activityType})
            </div>
         `;
    }
    
    // Ekspos fungsi ke scope global agar dapat dipanggil dari HTML inline onclick
    window.showCalendarModal = showCalendarModal;
    
    // (MODIFIKASI TOTAL - FIX BUG TANGGAL MUNDUR) 
    function renderCalendar(year, month) {
        if (!currentMonthYearEl || currentMonthYearEl.offsetParent === null) return;

        const monthNames = getMonthNames();
        currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

        const firstDayOfMonthObj = new Date(year, month, 1);
        const firstDay = firstDayOfMonthObj.getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        // Buat string untuk hari ini: "YYYY-MM-DD"
        const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        let calendarHTML = `<div class="calendar-grid">`;
        let date = 1;
        const dayOffset = (firstDay === 0) ? 6 : firstDay - 1; 

        // Filter sales person
        let salesToDisplay = [currentUser];
        if (currentRole === 'manager') {
            salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        }

        for (let i = 0; i < 6; i++) { 
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < dayOffset) {
                    calendarHTML += `<div class="calendar-cell other-month"></div>`; 
                } else if (date > daysInMonth) {
                     calendarHTML += `<div class="calendar-cell other-month"></div>`; 
                } else {
                    // --- KUNCI PERBAIKAN: BUAT ID TANGGAL UNIK (YYYY-MM-DD) ---
                    // Kita buat string tanggal untuk sel kalender ini secara manual
                    const currentMonthStr = String(month + 1).padStart(2, '0');
                    const currentDateStr = String(date).padStart(2, '0');
                    const cellDateKey = `${year}-${currentMonthStr}-${currentDateStr}`; // Contoh: "2025-11-20"
                    
                    const isToday = cellDateKey === todayString;
                    
                    // 1. Filter Realisasi (Bandingkan String vs String)
                    const dealsOnThisDay = allDeals.filter(deal => {
                         const salesMatch = salesToDisplay.includes(deal.sales);
                         let dealDateStr = '';
                         
                         // Ambil tanggal dari objek deal, format ke YYYY-MM-DD
                         if (deal.meetingDateObj) {
                             const d = deal.meetingDateObj;
                             dealDateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                         }
                         
                         // Bandingkan String: "2025-11-20" === "2025-11-20" (Pasti Akurat)
                         return salesMatch && dealDateStr === cellDateKey;
                    });
                    
                    // 2. Filter Rencana (Bandingkan String vs String)
                    let plansOnThisDay = allPlans.filter(plan => {
                        const salesMatch = salesToDisplay.includes(plan.salesPerson);
                        let planDateStr = '';
                        
                        // Parsing manual tanggal rencana (biasanya format string YYYY-MM-DD)
                        try {
                            const pDate = new Date(plan.plan_date);
                            if (!isNaN(pDate)) {
                                planDateStr = `${pDate.getFullYear()}-${String(pDate.getMonth() + 1).padStart(2, '0')}-${String(pDate.getDate()).padStart(2, '0')}`;
                            }
                        } catch(e) {}
                        
                        return salesMatch && planDateStr === cellDateKey;
                     });

                    // --- RENDER EVENT (Logika Max 5) ---
                    let eventsHTML = '';
                    const maxEventsToShow = 5;
                    let itemsShownCount = 0;
                    const totalItems = plansOnThisDay.length + dealsOnThisDay.length;

                    // Render Rencana
                    for (const plan of plansOnThisDay) {
                        if (itemsShownCount < maxEventsToShow) {
                            eventsHTML += renderPlannedEvent(plan);
                            itemsShownCount++;
                        } else { break; }
                    }

                    // Render Realisasi
                    for (const deal of dealsOnThisDay) {
                        if (itemsShownCount < maxEventsToShow) {
                            eventsHTML += renderRealizedEvent(deal);
                            itemsShownCount++;
                        } else { break; }
                    }

                    // Tombol Lainnya
                    if (totalItems > itemsShownCount) {
                        const remainingCount = totalItems - itemsShownCount;
                        eventsHTML += `<div class="calendar-others" onclick="window.showCalendarModal('${cellDateKey}')" title="Lihat detail">+ ${remainingCount} lainnya...</div>`;
                    }

                    calendarHTML += `
                        <div class="calendar-cell ${isToday ? 'today' : ''}">
                            <div class="calendar-date">${date}</div>
                            ${eventsHTML}
                        </div>`;
                    date++;
                }
            }
             if (date > daysInMonth) { break; }
        }
        calendarHTML += `</div>`;

        const oldGrid = calendarContainer.querySelector('.calendar-grid');
        if (oldGrid) oldGrid.remove();
        calendarContainer.insertAdjacentHTML('beforeend', calendarHTML); 
        lucide.createIcons();
    }
    
    // [MODIFIKASI] Kalkulasi Rata-rata Durasi Sales Cycle (Grouping by Project_GUID)
    // --- PERBAIKAN: Menghapus duplikasi kode ---
    function calculateSalesCycle(allDeals, salesToDisplay) { 
        const relevantDeals = allDeals.filter(d => d.sales && salesToDisplay.includes(d.sales));
        
        const projectGroups = relevantDeals.reduce((acc, deal) => {
            const projectGUID = deal.projectGUID; 
            if (!projectGUID) return acc; 

            acc[projectGUID] = acc[projectGUID] || [];
            acc[projectGUID].push(deal);
            return acc;
        }, {});
        
        const salesData = {};
        
        for(const guid in projectGroups){
            const projectDeals = projectGroups[guid].sort((a,b) => (a.meetingDateObj?.getTime() || 0) - (b.meetingDateObj?.getTime() || 0));
            
            const awarenessDeal = projectDeals.find(d => d.meetingType === 'Awareness');
            const actionDeal = projectDeals.find(d => d.meetingType === 'Action');

            if(awarenessDeal && actionDeal && awarenessDeal.meetingDateObj && actionDeal.meetingDateObj){
                const awarenessDate = awarenessDeal.meetingDateObj;
                const actionDate = actionDeal.meetingDateObj;
                if (isNaN(awarenessDate.getTime()) || isNaN(actionDate.getTime())) continue; 

                const duration = Math.ceil((actionDate - awarenessDate) / (1000 * 60 * 60 * 24));
                const closingSales = actionDeal.sales;
                
                if(duration >= 0){
                    salesData[closingSales] = salesData[closingSales] || { totalDuration: 0, dealCount: 0 };
                    salesData[closingSales].totalDuration += duration;
                    salesData[closingSales].dealCount++;
                }
            }
        }
        
        const result = [];
        for(const salesName in salesData){
            const data = salesData[salesName];
            if (data.dealCount > 0) {
                 result.push({
                    sales: salesName,
                    dealCount: data.dealCount,
                    averageDuration: Math.round(data.totalDuration / data.dealCount)
                 });
             }
        }
        return result;
    }
// --- PERBAIKAN BUG 2: FUNGSI TOMBOL REALISASI DARI MODAL ---
    window.realizePlanFromModal = (planId) => {
        // 1. Tutup Modal Kalender
        const modal = document.getElementById('calendarModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');

        // 2. Pindah ke Tab 2 (Realisasi)
        const tab2Btn = document.getElementById('tab-btn-2');
        if (tab2Btn) tab2Btn.click();

        // 3. Set Nilai Dropdown "Pilih Rencana" di Tab 2
        const selector = document.getElementById('planSelector');
        if (selector) {
            selector.value = planId;

            // 4. Picu event 'change' agar form otomatis terisi (trigger listener)
            const event = new Event('change');
            selector.dispatchEvent(event);
            
            // Scroll ke bagian form agar user sadar form sudah terisi
            const formContainer = document.getElementById('inputFormContainer');
            if (formContainer) {
                formContainer.scrollIntoView({ behavior: 'smooth' });
            }
        }
    };
    // --- Event Listeners ---
    function setupEventListeners() {
        

        // Filter Periode (Minggu, Bulan, Custom)
        globalPeriodFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                globalPeriodFilters.querySelector('.active')?.classList.remove('active');
                e.target.classList.add('active');
                customDateContainer.classList.toggle('hidden', e.target.dataset.period !== 'custom');
                if (e.target.dataset.period !== 'custom') {
                     const { startDate } = getFilterDates();
                     if (startDate && !isNaN(startDate.getTime())) {
                        currentCalendarDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                     }
                     renderFilteredDashboard();
                }
            }
        });
// (BARU) Listener untuk Sub-Tab Status Leads Aktif
        const leadsStatusTabsContainer = document.getElementById('leadsStatusTabsContainer');
        if (leadsStatusTabsContainer) {
            leadsStatusTabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.leads-status-tab');
                if (!clickedTab) return;

                const newStatus = clickedTab.dataset.status;
                if (newStatus === currentActiveLeadStatusTab) return; // Jangan lakukan apa-apa jika tab yang sama diklik

                // Update state global
                currentActiveLeadStatusTab = newStatus;
                activeLeadsCurrentPage = 1; // Reset halaman ke 1

                // Update UI Tab
                leadsStatusTabsContainer.querySelectorAll('.leads-status-tab').forEach(tab => {
                    tab.classList.remove('active-tab');
                    tab.classList.add('inactive-tab');
                });
                clickedTab.classList.add('active-tab');
                clickedTab.classList.remove('inactive-tab');

                // Render ulang dashboard untuk menerapkan filter status dan paginasi baru
                renderFilteredDashboard();
            });
        }
// (MODIFIKASI) Listener untuk dropdown Tujuan Meeting (Tab 1)
    const planObjectiveSelect = document.getElementById('planObjective');
    const planFollowUpContainer = document.getElementById('planFollowUpContainer');

    if (planObjectiveSelect) {
        planObjectiveSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Follow up inisiasi atau Leads') {
                planFollowUpContainer.classList.remove('hidden');
                document.getElementById('planFollowUpLead').required = true;
                // (BARIS BARU) Ambil nama klien yang sudah diketik
                const currentClientName = document.getElementById('planClientName').value;
                // (BARIS BARU) Panggil renderer dinamis saat dropdown diubah
                renderFollowUpLeadSelector(currentClientName);
            } else {
                planFollowUpContainer.classList.add('hidden');
                document.getElementById('planFollowUpLead').required = false;
            }
        });
    }
// (BARU) Listener untuk "Nama Klien" di Tab 1, untuk memfilter dropdown follow-up
    const planClientNameInput = document.getElementById('planClientName');
    if (planClientNameInput) {
        planClientNameInput.addEventListener('blur', (e) => { // 'blur' = event saat user klik keluar dari field
            const clientName = e.target.value;
            const objective = document.getElementById('planObjective').value;

            // Jika tujuannya follow up, update dropdown
            if (objective === 'Follow up inisiasi atau Leads') {
                renderFollowUpLeadSelector(clientName);
            }
        });
    }
        // --- (GANTI TOTAL BLOK DI BAWAH INI) ---
// (MODIFIKASI TOTAL) Listener untuk dropdown Realisasi Rencana (Tab 2)
if (planSelector) {
    planSelector.addEventListener('change', (e) => {
        const selectedPlanId = e.target.value;

        // 1. Ambil semua elemen DOM form yang akan di-lock
        const clientNameInput = document.getElementById('clientName');
        const nomorRFQInput = document.getElementById('nomorRFQ');
        const namaProjectInput = document.getElementById('namaProject');
        const meetingDateInput = document.getElementById('meetingDate');
        const provinsiInput = document.getElementById('lokasiProvinsi');
        const kotaInput = document.getElementById('lokasiKota');
        const segmentInput = document.getElementById('clientSegment');

        // 2. Reset dan Buka Kunci SEMUA field
        clientNameInput.value = '';
        nomorRFQInput.value = '';
        namaProjectInput.value = '';
        
        // Buka kunci (enable) semua field
        meetingDateInput.disabled = false;
        provinsiInput.disabled = false;
        kotaInput.disabled = false;
        segmentInput.disabled = false;

        // Reset dropdown lokasi & AIDA
        provinsiInput.value = "";
        segmentInput.value = "Enterprise"; // default
        kotaInput.innerHTML = '<option value="">-- Pilih Provinsi Dulu --</option>';
        lockActivityType(null); // 'null' akan membuka semua kunci AIDA

        // 3. Jika user memilih "Tidak, ini aktivitas baru"
        if (!selectedPlanId) {
            // Set tanggal ke hari ini (karena baru)
            document.getElementById('meetingDate').valueAsDate = new Date();
            return; // Selesai, form kosong dan tidak dikunci
        }

        // --- Mulai Logika Penguncian ---

        // 4. Temukan Rencana yang dipilih dari state global
        const selectedPlan = allPlans.find(p => p.plan_id === selectedPlanId);
        if (!selectedPlan) return;

        // 5. Isi Nama Klien (dari Rencana)
        clientNameInput.value = selectedPlan.clientName || '';
// [TAMBAHAN BARU] Cek Otomatis History untuk Rencana yang dipilih
        const nameToCheck = (selectedPlan.clientName || '').trim().toLowerCase();
        
        // Cek di allDeals
        const foundInHistory = allDeals.some(deal => 
            (deal.client || '').trim().toLowerCase() === nameToCheck
        );

        const existingRadio = document.querySelector('input[name="clientType"][value="existing"]');
        const newRadio = document.querySelector('input[name="clientType"][value="new"]');

        if (foundInHistory) {
            // Jika ada di history -> Pilih Existing
            if (existingRadio) {
                existingRadio.checked = true;
                // Efek visual sebentar
                existingRadio.parentElement.classList.add('bg-yellow-500/20', 'rounded-lg');
                setTimeout(() => existingRadio.parentElement.classList.remove('bg-yellow-500/20', 'rounded-lg'), 1000);
            }
        } else {
            // Jika tidak ada -> Pilih Baru
            if (newRadio) newRadio.checked = true;
        }
// Ambil elemen dropdown Capability di form realisasi
        const capabilityInput = document.getElementById('capability');
        
        // Jika data rencana memiliki 'capability', isi dropdown secara otomatis
        if (selectedPlan.capability) {
            capabilityInput.value = selectedPlan.capability;
        }
        // 6. (PERMINTAAN 1) Isi dan Kunci Tanggal Meeting (dari Rencana)
        // --- UPDATE PERBAIKAN BUG TANGGAL (FIX GMT/TIMEZONE) ---
        let rawDate = selectedPlan.plan_date;
        let cleanDate = "";

        if (rawDate) {
            // Cek apakah formatnya ISO String (mengandung 'T' atau 'Z')
            // Contoh kasus: "2025-11-20T17:00:00.000Z" (Ini sebenarnya tgl 21 di WIB)
            if (rawDate.includes('T') || rawDate.includes('Z')) {
                const dateObj = new Date(rawDate);
                
                // Validasi apakah tanggal valid
                if (!isNaN(dateObj.getTime())) {
                    // Ambil tahun, bulan, tanggal berdasarkan Waktu LOKAL Browser (WIB)
                    const year = dateObj.getFullYear();
                    // getMonth() mulai dari 0, jadi +1. padStart biar jadi "01", "02", dst
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    
                    cleanDate = `${year}-${month}-${day}`;
                } else {
                    // Fallback jika gagal parsing, ambil string depannya saja
                    cleanDate = rawDate.split('T')[0];
                }
            } else {
                // Jika data dari server sudah format "YYYY-MM-DD" bersih
                cleanDate = rawDate;
            }
        }
        
        meetingDateInput.value = cleanDate;
        meetingDateInput.disabled = true;

        // 7. Cek apakah rencana ini adalah follow-up dari deal (project) yang sudah ada
        let followUpGUID = null;
        if (selectedPlan.followUpTarget && selectedPlan.followUpTarget.startsWith('deal_')) {
            followUpGUID = selectedPlan.followUpTarget.replace('deal_', '');
        }

        // 8. Logika Inti: Tergantung ini follow-up ATAU aktivitas pertama
        if (followUpGUID) {
            // --- INI ADALAH FOLLOW-UP (Sudah ada data realisasi sebelumnya) ---

            // Cari deal terkait TERBARU di allDeals menggunakan GUID
            const projectDeals = allDeals
                .filter(d => (d.projectGUID || d.id) === followUpGUID)
                .sort((a,b) => b.meetingDateObj?.getTime() - a.meetingDateObj?.getTime());

            if (projectDeals.length > 0) {
                const latestDeal = projectDeals[0];

                // Isi Lead ID dan Nama Project
                nomorRFQInput.value = latestDeal.nomorRFQ || '';
                namaProjectInput.value = latestDeal.namaProject || '';

                // (PERMINTAAN 2) Isi dan Kunci Lokasi & Segmen
                if (latestDeal.lokasiProvinsi) {
                    provinsiInput.value = latestDeal.lokasiProvinsi;
                    provinsiInput.disabled = true;

                    // (PENTING) Isi manual dropdown kota berdasarkan provinsi
                    const cities = allWilayah[latestDeal.lokasiProvinsi] || [];
                    kotaInput.innerHTML = cities
                        .map(kota => `<option value="${kota}">${kota}</option>`)
                        .join('');
                    
                    if (latestDeal.lokasiKota) {
                        kotaInput.value = latestDeal.lokasiKota;
                    }
                    kotaInput.disabled = true;
                }
                if (latestDeal.clientSegment) {
                    segmentInput.value = latestDeal.clientSegment;
                    segmentInput.disabled = true;
                }

                // (PERMINTAAN 3) Kunci Tipe Aktivitas (AIDA)
                // Panggil helper, kirim tahap terakhir (misal: "Desire")
                lockActivityType(latestDeal.meetingType);
            }
        
        } else {
            // --- INI ADALAH AKTIVITAS PERTAMA (Rencana baru, belum ada realisasi) ---
            
            // (PERMINTAAN 3) Kunci Tipe Aktivitas HANYA ke "Awareness"
            lockActivityType(null); // Buka semua dulu
            Array.from(document.getElementById('meetingType').options).forEach(opt => {
                // Nonaktifkan semua KECUALI "Awareness"
                if (opt.value !== 'Awareness') {
                    opt.disabled = true;
                }
            });
            document.getElementById('meetingType').value = 'Awareness';
        }
    });
}
// ============================================================
// >>> FITUR BARU: AUTO-DETECT TIPE KLIEN (NEW vs EXISTING) <<<
// ============================================================
        
        const activityClientNameInput = document.getElementById('clientName');
        
        if (activityClientNameInput) {
            // Gunakan event 'blur' (saat user selesai mengetik/pindah kolom)
            activityClientNameInput.addEventListener('blur', (e) => {
                const nameToCheck = e.target.value.trim().toLowerCase();
                
                // Jika kosong, jangan lakukan apa-apa
                if (!nameToCheck) return;

                // Cek apakah nama ini ada di data 'allDeals' (History)
                // Kita cek apakah ada deal sebelumnya dengan nama yang sama
                const foundInHistory = allDeals.some(deal => 
                    (deal.client || '').trim().toLowerCase() === nameToCheck
                );

                const existingRadio = document.querySelector('input[name="clientType"][value="existing"]');
                const newRadio = document.querySelector('input[name="clientType"][value="new"]');

                if (foundInHistory) {
                    // JIKA ADA DI HISTORY -> Set ke 'Klien Existing'
                    if (existingRadio) {
                        existingRadio.checked = true;
                        // Opsional: Beri efek visual agar user sadar berubah
                        existingRadio.parentElement.classList.add('ring-2', 'ring-blue-400', 'rounded');
                        setTimeout(() => existingRadio.parentElement.classList.remove('ring-2', 'ring-blue-400', 'rounded'), 1000);
                    }
                } else {
                    // JIKA TIDAK ADA -> Set ke 'Klien Baru'
                    if (newRadio) newRadio.checked = true;
                }
            });
        }
        // ============================================================
        // Listener untuk filter tanggal custom dan filter sales
        [startDateInput, endDateInput, salesFilter].forEach(el => el.addEventListener('change',() => {
             const { startDate } = getFilterDates();
             if (startDate && !isNaN(startDate.getTime())) {
                currentCalendarDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
             }
             renderFilteredDashboard();
        }));
        // --- LOGIKA TOMBOL REFRESH FILTER (BARU) ---
        const refreshFilterBtn = document.getElementById('refreshFilterBtn');

        if (refreshFilterBtn) {
            refreshFilterBtn.addEventListener('click', () => {
                // 1. Validasi: Pastikan tanggal sudah dipilih
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                if (!start || !end) {
                    showCustomModal("Filter Tanggal", "Harap pilih Tanggal Mulai dan Tanggal Akhir terlebih dahulu.");
                    return;
                }

                // 2. Efek Visual Loading (Putar Icon)
                const icon = refreshFilterBtn.querySelector('i');
                if (icon) icon.classList.add('animate-spin');

                // 3. Ubah state filter menjadi 'custom' secara paksa
                // Hapus kelas active dari tombol lain
                globalPeriodFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                // Tambahkan active ke tombol custom
                const customBtn = document.querySelector('.filter-btn[data-period="custom"]');
                if (customBtn) customBtn.classList.add('active');

                // 4. Render Ulang Dashboard (Paksa Refresh)
                renderFilteredDashboard();

                // 5. Hentikan animasi setelah 500ms (Feedback ke user)
                setTimeout(() => {
                    if (icon) icon.classList.remove('animate-spin');
                }, 500);
            });
        }
        // Tombol navigasi kalender
        prevMonthBtn.addEventListener('click', () => {
             if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        });
        nextMonthBtn.addEventListener('click', () => {
             if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        });
        
        // Logika dropdown login
        // --- PERBAIKAN ---
roleSelector.addEventListener('change', () => {
    const role = roleSelector.value;

    if (role === 'sales') {
        // Tampilkan sales, sembunyikan manager
        salesPersonSelectorContainer.classList.remove('hidden');
        managerSelectorContainer.classList.add('hidden');
    } else if (role === 'manager') {
        // Sembunyikan sales, tampilkan manager
        salesPersonSelectorContainer.classList.add('hidden');
        managerSelectorContainer.classList.remove('hidden');
    } else { // Ini untuk 'head_sales'
        // Sembunyikan keduanya
        salesPersonSelectorContainer.classList.add('hidden');
        managerSelectorContainer.classList.add('hidden');
    }
});

        // Tombol Login
        // ---- SALIN DAN TEMPEL KODE BARU INI ----
loginBtn.addEventListener('click', () => { 
    const role = roleSelector.value;
    const password = passwordInput.value;
    
    let user; // Variabel untuk NAMA BERSIH yang akan disimpan (cth: 'Head Sales')
    let credentialKey; // Variabel untuk KUNCI password (cth: 'head_sales')
    let expectedPassword;

    if (role === 'sales') {
        user = salesPersonSelector.value;
        credentialKey = user; // Untuk sales, nama dan kunci sama
        
    } else if (role === 'manager') {
        user = managerSelector.value;
        credentialKey = user; // Untuk manager, nama dan kunci sama
        
    } else if (role === 'head_sales') {
        user = 'Head Sales'; // NAMA BERSIH (H besar) untuk disimpan ke sesi
        credentialKey = 'head_sales'; // KUNCI (h kecil) untuk cek password
    }
    
    // Ambil password menggunakan KUNCI yang benar
    expectedPassword = userCredentials[credentialKey];

    // Lakukan pengecekan
    if (password === expectedPassword) {
        sessionStorage.setItem('salesRole', role);
        sessionStorage.setItem('salesUser', user); // Menyimpan NAMA BERSIH ('Head Sales')
        currentRole = role;
        currentUser = user;
        showDashboard();
    } else {
        loginError.classList.remove('hidden');
        passwordInput.value = '';
    }
});
// ---- BATAS AKHIR KODE BARU ----
        passwordInput.addEventListener('input', () => loginError.classList.add('hidden'));
        logoutBtn.addEventListener('click', showLogin);

        // Form: Tampilkan/sembunyikan 'Recurring' dan 'Obstacle'
        meetingTypeSelect.addEventListener('change',e=>{
            const selectedType = e.target.value;
            obstacleSection.classList.toggle('hidden', selectedType !== 'Lost');
        });
        
        // --- (BARU) Listener untuk Form Perencanaan (Tab 1) ---
        planForm.addEventListener('submit', async (e) => {
            // FIX: Mencegah reload halaman yang menyebabkan logout
            e.preventDefault(); 

            const saveBtn = document.getElementById('savePlanBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Menyimpan...';

            // Ambil semua data dari form
            const planData = {
                action: 'addPlan', // Aksi untuk Google Apps Script
                salesPerson: currentUser,
                // --- PERBAIKAN: 'date' diubah menjadi 'plan_date' agar sesuai GSheet ---
                plan_date: document.getElementById('planDate').value,
                // --- AKHIR PERBAIKAN ---
                clientName: document.getElementById('planClientName').value,
                activityType: document.getElementById('planActivityType').value,
capability: document.getElementById('planCapability').value,
                objective: document.getElementById('planObjective').value,
                followUpTarget: document.getElementById('planFollowUpLead').value || '', // Kirim ID deal/plan jika ada
                notes: document.getElementById('planNotes').value,
                status: 'planned' // Status default saat dibuat
            };

            // Validasi sederhana
            if (!planData.plan_date || !planData.clientName) { // <--- PERBAIKAN: 'date' diubah menjadi 'plan_date'
                showCustomModal("Error", "Tanggal dan Nama Klien wajib diisi.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana';
                lucide.createIcons();
                return;
            }

            try {
                // Kirim data menggunakan jsonpRequest
                const result = await jsonpRequest(GOOGLE_SCRIPT_URL, planData);
                
                if (result.status !== 'sukses') {
                    throw new Error(result.message || 'Gagal menyimpan di server');
                }

                // --- Jika Sukses ---
                planSuccessMessage.textContent = 'Rencana berhasil disimpan!';
                planSuccessMessage.classList.remove('hidden');
                setTimeout(() => planSuccessMessage.classList.add('hidden'), 3000);

                // Reset form (tapi pertahankan tanggal yang dipilih)
                const keptDate = planData.plan_date; // <--- PERBAIKAN: 'date' diubah menjadi 'plan_date'
                planForm.reset();
                document.getElementById('planDate').value = keptDate;
                document.getElementById('planFollowUpContainer').classList.add('hidden');

                // Muat ulang data rencana dari server
                let params = { 
                    action: 'getPlans', 
                    role: currentRole,
                    salesPerson: currentUser,
                    // (BARU) Cache-buster untuk memaksa data baru
                    _timestamp: new Date().getTime()
                };
                allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, params);
                
                // --- (HAPUS) DEBUGGING DIHAPUS (DIKOMENTARI) ---
                console.log("Data Rencana (LENGKAP) yang baru diambil (SETELAH ADD):", allPlansFull);
                // alert("Alert 1 (ADD): Jumlah data (allPlansFull) yang diambil: " + allPlansFull.length);
                // --- AKHIR DEBUGGING ---

                allPlans = allPlansFull.filter(p => p.status === 'planned');
                
                // --- (HAPUS) DEBUGGING 2 DIHAPUS (DIKOMENTARI) ---
                console.log("Data Rencana (SETELAH FILTER 'planned') (SETELAH ADD):", allPlans);
                // alert("Alert 2 (ADD): Jumlah data (allPlans) SETELAH filter: " + allPlans.length);
                // --- AKHIR DEBUGGING 2 ---
// Render ulang UI yang bergantung pada 'allPlans'
renderPlanList(); // Update tabel di Tab 1
renderPlanSelector(); // Update dropdown di Tab 2
renderFollowUpLeadSelector(); // Update dropdown follow-up di Tab 1
populateClientDatalist(); // Update auto-complete klien

// (PERBAIKAN) Panggil HANYA metrik Tab 1, BUKAN seluruh dashboard
let salesToDisplay = [currentUser];
renderPlanningMetrics(salesToDisplay, currentRole);

            } catch (error) {
                showCustomModal("Error Simpan Rencana", "Gagal menyimpan: " + error.message);
            
            } finally {
                // Kembalikan tombol ke status normal
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana';
                lucide.createIcons({ nodes: [document.getElementById('savePlanBtn')] });
            }
        });

        // --- (PERBAIKAN FINAL) Listener untuk Hapus/Batal Rencana (Tab 1) ---
        planListContainer.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-plan-btn');
            if (deleteButton) {
                // Ambil ID dari GSheet (sekarang plan_id)
                const planId = deleteButton.dataset.planId; 
                
                // Menggunakan Modal Konfirmasi Kustom
                showCustomConfirmModal("Konfirmasi Hapus", "Anda yakin ingin MEMBATALKAN rencana ini? (Status akan diubah menjadi 'cancelled')", async () => {
                    // Ini adalah callback 'onConfirm'
                    try {
                        // Kirim update status ke GAS
                        const result = await jsonpRequest(GOOGLE_SCRIPT_URL, {
                            action: 'updatePlanStatus',
                            id: planId, // GScript mencari 'id'
                            status: 'cancelled' // GScript mencari 'status'
                        });

                        if (result.status !== 'sukses') {
                            throw new Error(result.message);
                        }

                        // Jika sukses, muat ulang data rencana
                        let params = { 
                            action: 'getPlans',
                            role: currentRole, 
                            salesPerson: currentUser,
                            // (BARU) Cache-buster untuk memaksa data baru
                            _timestamp: new Date().getTime()
                        };
                        allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, params);
                        allPlans = allPlansFull.filter(p => p.status === 'planned');

                       // Render ulang UI (CARA YANG BENAR)
                        renderPlanList();
                        renderPlanSelector();
                        renderFollowUpLeadSelector();
                        populateClientDatalist();

                        // (MODIFIKASI) Panggil HANYA renderPlanningMetrics
                        // Ini akan me-refresh kartu metrik di Tab 1 tanpa beralih tab.
                        let salesToDisplay = [currentUser];
                        
                        // Panggil fungsi spesifik untuk metrik Tab 1
                        renderPlanningMetrics(salesToDisplay, currentRole);
                        
                        // --- PANGGILAN renderCalendar() SUDAH DIHAPUS DARI SINI ---
                        
                        showCustomModal("Sukses", "Rencana telah dibatalkan."); // Modal notifikasi standar

                    } catch (error) {
                        showCustomModal("Error", "Gagal membatalkan rencana: " + error.message);
                    }
                });
            }
        });
        // --- (PERBAIKAN) LISTENER UNTUK SUBMIT REALISASI (TAB 2) YANG HILANG ---
        activityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitBtn');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyimpan...';

            const selectedPlanId = document.getElementById('planSelector').value;
            let projectGUID = null;
            let selectedPlan = null;

            // 1. Cek apakah ini realisasi dari rencana
            if (selectedPlanId) {
                selectedPlan = allPlans.find(p => p.plan_id === selectedPlanId);
                // 2. Ambil Project_GUID jika rencana ini adalah follow-up
                if (selectedPlan && selectedPlan.followUpTarget && selectedPlan.followUpTarget.startsWith('deal_')) {
                    projectGUID = selectedPlan.followUpTarget.replace('deal_', '');
                }
            }

            // 3. Jika bukan dari rencana follow-up, buat GUID baru
            if (!projectGUID) {
                projectGUID = generateGUID(); // Asumsikan ini project/lead baru
            }

            // 4. Kumpulkan semua data dari form
            const dealData = {
                action: 'addData', // Sesuai dengan GScript
                Nama_Klien: document.getElementById('clientName').value,
                Tanggal_Meeting: document.getElementById('meetingDate').value,
                Lokasi_Provinsi: document.getElementById('lokasiProvinsi').value,
                Lokasi_Kota: document.getElementById('lokasiKota').value,
                Client_Segment: document.getElementById('clientSegment').value,
                Nama_Sales: document.getElementById('salesPerson').value,
                Tipe_Klien: document.querySelector('input[name="clientType"]:checked').value,
                ID_DEAL: document.getElementById('nomorRFQ').value,
                Nama_Project: document.getElementById('namaProject').value,
                Hasil_Meeting: document.getElementById('meetingNotes').value,
                Type_Aktivitas: document.getElementById('meetingType').value,
                Capability: document.getElementById('capability').value,
Program_Champion: document.getElementById('programChampion').value,
                Nilai_Deal: document.getElementById('dealValue').value.replace(/\./g, ''), // Hapus titik
                Unit_in_Charge: document.getElementById('unitInCharge').value,
                Kategori_Support: document.getElementById('supportCategory').value,
                Support_Status: (document.getElementById('unitInCharge').value !== 'Tidak perlu support') ? 'On Process' : 'N/A',
                Hambatan: (document.getElementById('meetingType').value === 'Lost') 
          ? document.getElementById('salesObstacle')?.value 
          : '',
                Project_GUID: projectGUID // Kunci terpenting
            };

            try {
                // 5. Kirim data realisasi ke GScript
                const createResult = await jsonpRequest(GOOGLE_SCRIPT_URL, dealData);
                if (createResult.status !== 'sukses') {
                    throw new Error(createResult.message || 'Gagal menyimpan realisasi');
                }

                // 6. Jika ini dari rencana, update status rencana tsb
                if (selectedPlanId) {
                    await jsonpRequest(GOOGLE_SCRIPT_URL, {
                        action: 'updatePlanStatus',
                        id: selectedPlanId,
                        status: 'realized'
                    });
                }

                // 7. Muat ulang SEMUA data (Realisasi & Rencana)
                allDeals = await fetchDataFromScript();
                
                let planParams = { 
                    action: 'getPlans',
                    role: currentRole, 
                    salesPerson: currentUser,
                    _timestamp: new Date().getTime()
                };
                allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, planParams);
                allPlans = allPlansFull.filter(p => p.status === 'planned');

// Render ulang UI yang bergantung pada 'allPlans'
renderPlanList(); // Update tabel di Tab 1 (rencana akan hilang)
renderPlanSelector(); // Update dropdown di Tab 2 (rencana akan hilang)
renderFollowUpLeadSelector(); // Update dropdown follow-up di Tab 1
populateClientDatalist(); // Update auto-complete klien

                // 8. Reset form dan tampilkan pesan sukses
                document.getElementById('successMessage').textContent = 'Aktivitas realisasi berhasil disimpan!';
                document.getElementById('successMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 4000);
                
                activityForm.reset();
                document.getElementById('meetingDate').valueAsDate = new Date(); // Set tanggal hari ini
                document.getElementById('salesPerson').value = currentUser; // Set sales

                
                // Render ulang dashboard utama (termasuk kalender & semua grafik)
                renderFilteredDashboard(); 

            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Gagal menyimpan: ' + error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 4000);
            
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Simpan';
                lucide.createIcons();
            }
        });
       // --- Listener Baru untuk Paginasi (Delegasi Event) ---
        mainContent.addEventListener('click', (e) => {
            // Tombol Support
            const supportPrevBtn = e.target.closest('#supportPrevBtn');
            const supportNextBtn = e.target.closest('#supportNextBtn');
            
            // Tombol Leads Aktif
            const activeLeadsPrevBtn = e.target.closest('#activeLeadsPrevBtn');
            const activeLeadsNextBtn = e.target.closest('#activeLeadsNextBtn');

            // Tombol Stale Leads
            const stalePrevBtn = e.target.closest('#stalePrevBtn');
            const staleNextBtn = e.target.closest('#staleNextBtn');

            // Tombol Zoom & Portfolio (BARU)
            const resetZoomBtn = e.target.closest('#resetZoomBtn');
            const portfolioPrevBtn = e.target.closest('#portfolioPrevBtn'); // Tambahan
            const portfolioNextBtn = e.target.closest('#portfolioNextBtn'); // Tambahan

            // 1. Logika Support
            if (supportPrevBtn && !supportPrevBtn.disabled) {
                supportCurrentPage--;
                displayPaginatedSupportTable();
            } else if (supportNextBtn && !supportNextBtn.disabled) {
                supportCurrentPage++;
                displayPaginatedSupportTable();
            
            // 2. Logika Leads Aktif
            } else if (activeLeadsPrevBtn && !activeLeadsPrevBtn.disabled) {
                activeLeadsCurrentPage--;
                renderFilteredDashboard();
            } else if (activeLeadsNextBtn && !activeLeadsNextBtn.disabled) {
                activeLeadsCurrentPage++;
                renderFilteredDashboard();

            // 3. Logika Stale Leads
            } else if (stalePrevBtn && !stalePrevBtn.disabled) {
                staleLeadsCurrentPage--;
                displayPaginatedStaleLeadsTable(); 
            } else if (staleNextBtn && !staleNextBtn.disabled) {
                staleLeadsCurrentPage++;
                displayPaginatedStaleLeadsTable(); 

            // 4. Logika Portfolio Matrix (FIX BUG)
            } else if (portfolioPrevBtn && !portfolioPrevBtn.disabled) {
                portfolioCurrentPage--;
                renderPortfolioTable();
            } else if (portfolioNextBtn && !portfolioNextBtn.disabled) {
                portfolioCurrentPage++;
                renderPortfolioTable();

            // 5. Logika Reset Zoom
            } else if (resetZoomBtn) {
                if (charts.projectScatter) {
                    charts.projectScatter.resetZoom();
                }
            }
        });


// --- LISTENER UNTUK SEARCH LEADS ---
        const searchInput = document.getElementById('searchActiveLeadsInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                // Update variabel global
                activeLeadsSearchTerm = e.target.value;
                
                // Reset halaman ke 1 setiap kali mengetik
                activeLeadsCurrentPage = 1; 
                
                // Render ulang tabel
                renderFilteredDashboard(); 
            });
        }
// --- LISTENER UNTUK SEARCH REAKTIVASI (SLEEPER ASSETS) ---
        const reactivationSearchEl = document.getElementById('reactivationSearchInput');
        if (reactivationSearchEl) {
            reactivationSearchEl.addEventListener('input', (e) => {
                // 1. Update variabel global search term
                reactivationSearchTerm = e.target.value;
                
                // 2. Reset halaman ke 1
                reactivationCurrentPage = 1; 
                
                // 3. Render ulang tabel (gunakan null karena data sudah ada di global)
                renderReactivationTable(null); 
            });
        }
        // --- LISTENER UNTUK DOWNLOAD LEADS ---
        const downloadBtn = document.getElementById('downloadActiveLeadsBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                // Kita perlu mengambil data yang SAMA PERSIS dengan yang ada di tabel saat ini
                // Sayangnya kita tidak menyimpan 'filteredByStatusLeads' di global.
                // Jadi kita harus melakukan filter ulang (Cara paling aman).
                
                // 1. Ambil data dasar
                let dealsToProcess = allDeals;
                // Terapkan logika Sales Filter yang sama seperti di renderFilteredDashboard
                let salesToDisplay = [currentUser];
                if (currentRole === 'manager') {
                    salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
                } else if (currentRole === 'head_sales') {
                    salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
                }
                
                // 2. Filter & Deduplikasi (Copy logika dari renderActiveLeadsTable)
                const latestMap = new Map();
                dealsToProcess.forEach(deal => {
                    if (!salesToDisplay.includes(deal.sales)) return;
                    let key = deal.projectGUID; 
                    if (!key && deal.nomorRFQ && deal.nomorRFQ.length > 1) key = "rfq_" + deal.nomorRFQ;
                    if (!key) key = deal.client + "_" + deal.namaProject;
                    
                    const existing = latestMap.get(key);
                    if (!existing || deal.meetingDateObj >= existing.meetingDateObj) {
                        latestMap.set(key, deal);
                    }
                });

                // 3. Terapkan Filter Tanggal & Search & Status Tab
                const { startDate, endDate } = getFilterDates();
                const term = activeLeadsSearchTerm.toLowerCase();

                const finalData = Array.from(latestMap.values()).filter(deal => {
                    // Filter Tanggal
                    if (startDate && endDate) {
                        const dt = deal.meetingDateObj.getTime();
                        if (dt < startDate.getTime() || dt > endDate.getTime()) return false;
                    }
                    // Filter Search
                    if (term) {
                        const client = (deal.client || '').toLowerCase();
                        const proj = (deal.namaProject || '').toLowerCase();
                        if (!client.includes(term) && !proj.includes(term)) return false;
                    }
                    // Filter Status Tab (PENTING)
                    const status = (deal.meetingType || '').trim();
                    if (currentActiveLeadStatusTab === 'Awareness') return status === 'Awareness';
                    if (currentActiveLeadStatusTab === 'Interest') return status === 'Interest';
                    if (currentActiveLeadStatusTab === 'Desire') return ['Desire', 'Process Closing', 'ProcessClosing'].includes(status);
                    if (currentActiveLeadStatusTab === 'Action') return ['Action', 'Delivery', 'Payment'].includes(status);
                    
                    return false;
                });

                // 4. Download
                downloadActiveLeadsCSV(finalData);
            });
        }
        // Listener untuk tabel support (saat Sales mengubah status)
        document.getElementById('supportTableBody').addEventListener('change', async (e) => {
            if (e.target.classList.contains('support-status-select') && currentRole === 'sales') {
                const selectEl = e.target;
                const dealId = selectEl.dataset.id; // Ini adalah Record_ID (deal.id)
                const newStatus = selectEl.value;

                const dealIndex = allDeals.findIndex(d => d.id == dealId);
                if (dealIndex === -1) return;
                
                const originalStatus = allDeals[dealIndex].supportStatus;
                allDeals[dealIndex].supportStatus = newStatus; 
                renderFilteredDashboard(); // Optimistic UI update

                try {
                    // Kirim update ke Apps Script
                    // Kita mengirim 'idToFind' sebagai Record_ID (deal.id)
                    await postDataToScript({ action: 'update', idToFind: dealId, data: { Support_Status: newStatus } });
                    showCustomModal("Sukses", "Status Support berhasil diupdate.");

                } catch (error) {
                    // Rollback jika Gagal
                    allDeals[dealIndex].supportStatus = originalStatus;
                    renderFilteredDashboard();
                    showCustomModal("Error", "Gagal mengupdate status: " + error.message);
                }
            }

        });
    }
    // --- FUNGSI BARU: SHOW PROJECT HISTORY POPUP ---
window.showProjectHistory = (key) => {
    // 1. Filter Data Mentah (allDeals) untuk menemukan project yang cocok dengan KEY
    const historyDeals = allDeals.filter(deal => {
        // Replikasi logika Key Generator dari renderProjectAnalytics
        let dealKey = deal.projectGUID;
        if (!dealKey && deal.nomorRFQ && deal.nomorRFQ.length > 2) dealKey = "rfq_" + deal.nomorRFQ;
        if (!dealKey) dealKey = (deal.client + "_" + deal.namaProject).trim().toLowerCase();
        
        return dealKey === key;
    });

    if (historyDeals.length === 0) return;

    // 2. Urutkan dari Terlama ke Terbaru (Timeline)
    historyDeals.sort((a, b) => a.meetingDateObj - b.meetingDateObj);

    // 3. Ambil Info Header
    const latestDeal = historyDeals[historyDeals.length - 1]; // Status terakhir
    const clientName = latestDeal.client;
    const projectName = latestDeal.namaProject || '(Tanpa Nama Project)';
    const totalAmount = Math.max(...historyDeals.map(d => parseInt(d.value) || 0)); // Nilai tertinggi

    // 4. Update UI Header Modal
    document.getElementById('histModalTitle').innerHTML = `${projectName} <span class="ml-2 text-xs bg-blue-900 text-blue-200 px-2 py-0.5 rounded border border-blue-700">${formatIDRShort(totalAmount)}</span>`;
    document.getElementById('histModalSubtitle').textContent = `Client: ${clientName} | Sales: ${latestDeal.sales}`;
    document.getElementById('histModalFooter').textContent = `Total ${historyDeals.length} aktivitas tercatat.`;

    // 5. Generate HTML Timeline
    const contentContainer = document.getElementById('histModalContent');
    contentContainer.innerHTML = historyDeals.map((deal, index) => {
        const dateStr = deal.meetingDateObj ? deal.meetingDateObj.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        
        // Tentukan warna icon berdasarkan status
        let statusColor = 'bg-gray-600';
        let icon = 'circle';
        if(['Action', 'Delivery', 'Payment'].includes(deal.meetingType)) { statusColor = 'bg-green-500'; icon = 'check'; }
        else if(deal.meetingType === 'Lost') { statusColor = 'bg-red-500'; icon = 'x'; }
        else if(['Desire', 'Process Closing'].includes(deal.meetingType)) { statusColor = 'bg-yellow-500'; icon = 'arrow-up'; }
        else { statusColor = 'bg-blue-500'; }

        // Garis penghubung (kecuali item terakhir)
        const line = index !== historyDeals.length - 1 ? `<div class="absolute left-3.5 top-8 bottom-0 w-0.5 bg-gray-700"></div>` : '';

        return `
            <div class="relative pl-10 py-3 pr-4 hover:bg-gray-700/30 transition-colors border-b border-gray-700/50 last:border-0">
                <div class="absolute left-2 top-4 w-3 h-3 rounded-full ${statusColor} z-10 border border-gray-800 shadow-sm"></div>
                ${line}

                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-[10px] font-mono text-gray-400 uppercase tracking-wider">${dateStr}</span>
                        <h4 class="text-sm font-bold text-white mt-0.5">${deal.meetingType}</h4>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] px-2 py-0.5 rounded bg-gray-700 text-gray-300 border border-gray-600">${deal.capability || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="mt-2 text-xs text-gray-300 bg-gray-800/50 p-2 rounded border border-gray-700/50">
                    ${deal.notes || '<span class="text-gray-600 italic">Tidak ada catatan.</span>'}
                </div>
                
                ${deal.obstacle ? `<div class="mt-1 text-[10px] text-red-400 flex items-center"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Hambatan: ${deal.obstacle}</div>` : ''}
            </div>
        `;
    }).join('');

    // 6. Tampilkan Modal
    const modal = document.getElementById('projectHistoryModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    lucide.createIcons();
};
// --- [REVISI V2] Quick Plan dengan Auto-Switch & Custom Objective ---
window.quickPlanFollowUp = (clientName, projectName, capability, leadValue, targetObjective = null) => {
    // 1. PINDAH TAB SECARA PAKSA
    const tab1Btn = document.getElementById('tab-btn-1');
    const salesTabsContainer = document.getElementById('salesTabsContainer');
    const managerTabsContainer = document.getElementById('managerTabsContainer');
    
    if (tab1Btn && (!tab1Btn.classList.contains('hidden') || (salesTabsContainer && !salesTabsContainer.classList.contains('hidden')))) {
        tab1Btn.click();
    } else {
        if(salesTabsContainer) salesTabsContainer.classList.remove('hidden');
        if(managerTabsContainer) managerTabsContainer.classList.add('hidden');
        if(tab1Btn) tab1Btn.click();
    }

    // 2. ISI FORM (Delay agar Tab render dulu)
    setTimeout(() => {
        const clientInput = document.getElementById('planClientName');
        const capInput = document.getElementById('planCapability');
        const objectiveSelect = document.getElementById('planObjective');
        const leadSelect = document.getElementById('planFollowUpLead');
        const notesInput = document.getElementById('planNotes');
        const formContainer = document.getElementById('planForm');

        if (!formContainer) return;

        // Isi Nama Klien
        if (clientInput) {
            clientInput.value = clientName;
            clientInput.dispatchEvent(new Event('input'));
            clientInput.dispatchEvent(new Event('blur'));
        }

        // Isi Capability
        if (capInput && capability) {
            capInput.value = capability;
        }

        // [LOGIKA BARU] Set Objective Sesuai Parameter
        if (objectiveSelect) {
            if (targetObjective) {
                // Jika ada instruksi khusus (misal: "Perkenalan...")
                objectiveSelect.value = targetObjective;
            } else {
                // Default: Follow Up
                objectiveSelect.value = 'Follow up inisiasi atau Leads';
            }
            // Trigger change agar dropdown follow-up muncul/hilang sesuai pilihan
            objectiveSelect.dispatchEvent(new Event('change'));
        }

        // Populate Dropdown Lead & Pilih (Hanya jika objective adalah Follow Up)
        if (!targetObjective || targetObjective === 'Follow up inisiasi atau Leads') {
            if (typeof renderFollowUpLeadSelector === 'function') {
                renderFollowUpLeadSelector(clientName);
            }
            setTimeout(() => {
                if (leadSelect && leadValue) {
                    leadSelect.value = leadValue;
                }
            }, 150);
        }

        // Isi Catatan
        if (notesInput) {
            notesInput.value = `Strategy Action: ${targetObjective ? 'Akuisisi Baru' : 'Follow Up'} untuk ${projectName}`;
        }

        // 3. EFEK VISUAL
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        formContainer.parentElement.classList.add('ring-4', 'ring-blue-500', 'rounded-lg');
        setTimeout(() => {
            formContainer.parentElement.classList.remove('ring-4', 'ring-blue-500');
            document.getElementById('planDate').focus();
        }, 1200);

    }, 100);
};
// --- FITUR DIAGNOSTIK: AUDIT DATA (POSISI POJOK KANAN ATAS) ---
window.auditDataIntegrity = () => {
    console.log("Memulai Audit Data...");
    const rfqMap = new Map();

    // 1. Kelompokkan Data
    allDeals.forEach(deal => {
        if (!deal.nomorRFQ || deal.nomorRFQ.trim().length < 2) return;
        const id = deal.nomorRFQ.trim();
        if (!rfqMap.has(id)) rfqMap.set(id, []);
        rfqMap.get(id).push(deal);
    });

    // 2. Cek Anomali
    const errors = [];
    rfqMap.forEach((deals, id) => {
        const guids = new Set(deals.map(d => d.projectGUID).filter(g => g));
        if (guids.size > 1) {
            errors.push(`Lead ID: ${id}\n-> Konflik GUID: ${Array.from(guids).join(', ')}`);
        }
    });

    // 3. Tampilkan Hasil
    if (errors.length > 0) {
        const errorText = errors.join('\n\n----------------------------\n\n'); 

        // A. Ambil Elemen Modal Baru
        const modal = document.getElementById('auditReportModal');
        const msgBody = document.getElementById('auditMsgBody');
        const textArea = document.getElementById('auditErrorBox');
        const copyBtn = document.getElementById('auditCopyBtn');

        // B. Isi Konten
        if (msgBody) msgBody.innerHTML = `Ditemukan <b>${errors.length} Lead ID</b> dengan data ganda.`;
        if (textArea) textArea.value = errorText;

        // C. Setup Tombol Salin
        if (copyBtn) {
            // Reset tombol (hapus listener lama dengan clone)
            const newCopyBtn = copyBtn.cloneNode(true);
            copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);

            newCopyBtn.addEventListener('click', () => {
                textArea.select();
                navigator.clipboard.writeText(errorText).then(() => {
                    newCopyBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i> Tersalin';
                    newCopyBtn.classList.add('text-green-400', 'border-green-500');
                    setTimeout(() => {
                        newCopyBtn.innerHTML = '<i data-lucide="copy" class="w-3 h-3 mr-1"></i> Salin';
                        newCopyBtn.classList.remove('text-green-400', 'border-green-500');
                        lucide.createIcons();
                    }, 2000);
                });
            });
        }

        // D. Tampilkan Modal (Hapus class hidden)
        modal.classList.remove('hidden');
        
        // Animasi masuk sedikit
        modal.classList.add('animate-bounce-in'); // Opsional jika ada CSS animasi, jika tidak tetap muncul
        
        lucide.createIcons();

    } else {
        // Jika Sehat, tetap pakai modal tengah biasa (lebih sopan)
        showCustomModal("Audit Data", "✅ Data Sehat! Tidak ditemukan konflik Lead ID vs Project GUID.");
    }
};
// --- FUNGSI BARU UNTUK FITUR REAKTIVASI ---

// 1. Fungsi Navigasi Pagination
window.changeReactivationPage = (direction) => {
    reactivationCurrentPage += direction;
    renderReactivationTable(null); // null karena data sudah ada di global
};

// 2. Fungsi Tombol "Aktifkan" (Landing ke Tab Perencanaan)
window.activateSleeperClient = (clientName) => {
    // A. Pindah ke Tab 1 (Perencanaan)
    const tab1Btn = document.getElementById('tab-btn-1');
    if (tab1Btn) tab1Btn.click();

    // B. Isi Form Otomatis
    const clientInput = document.getElementById('planClientName');
    const objectiveSelect = document.getElementById('planObjective');
    const notesInput = document.getElementById('planNotes');

    if (clientInput) {
        clientInput.value = clientName;
        // Trigger event blur agar logic follow-up dropdown jalan (jika ada)
        clientInput.dispatchEvent(new Event('blur')); 
    }

    if (objectiveSelect) {
        // Set tujuan meeting spesifik
        objectiveSelect.value = 'Perkenalan dan mencari Leads';
        // Trigger change agar UI update jika diperlukan
        objectiveSelect.dispatchEvent(new Event('change'));
    }
    
    if (notesInput) {
        notesInput.value = `Program Reaktivasi Akun Tidur: ${clientName}`;
    }

    // C. Scroll ke Form agar user melihat field yang terisi
    const formEl = document.getElementById('planForm');
    if (formEl) {
        formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Beri highlight visual sejenak
        formEl.classList.add('ring-2', 'ring-orange-500');
        setTimeout(() => formEl.classList.remove('ring-2', 'ring-orange-500'), 1500);
    }
};

// 2. Fungsi Tombol "Aktifkan" (Landing ke Tab Perencanaan) - REVISI
window.activateSleeperClient = (clientName) => {
    // A. Pindah ke Tab 1 (Perencanaan)
    const tab1Btn = document.getElementById('tab-btn-1');
    if (tab1Btn) tab1Btn.click();

    // B. Isi Form Otomatis
    const clientInput = document.getElementById('planClientName');
    const objectiveSelect = document.getElementById('planObjective');
    const capabilitySelect = document.getElementById('planCapability'); // ID Input Capability
    const notesInput = document.getElementById('planNotes');

    if (clientInput) {
        clientInput.value = clientName;
        clientInput.dispatchEvent(new Event('blur')); 
    }

    if (objectiveSelect) {
        // Set tujuan meeting: Perkenalan dan mencari Leads
        objectiveSelect.value = 'Perkenalan dan mencari Leads';
        objectiveSelect.dispatchEvent(new Event('change'));
    }

    // --- REVISI: Set Capability ke IT Outsourcing ---
    if (capabilitySelect) {
        capabilitySelect.value = 'IT Outsourcing';
        capabilitySelect.dispatchEvent(new Event('change'));
    }

    if (notesInput) {
        notesInput.value = `Program Reaktivasi Akun Tidur: ${clientName}`;
    }

    // C. Scroll ke Form
    const formEl = document.getElementById('planForm');
    if (formEl) {
        formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        formEl.classList.add('ring-2', 'ring-orange-500');
        setTimeout(() => formEl.classList.remove('ring-2', 'ring-orange-500'), 1500);
    }
};
// --- FUNGSI PENDUKUNG FITUR REAKTIVASI (SLEEPER ASSETS) ---

// 1. Fungsi Navigasi Pagination
window.changeReactivationPage = (direction) => {
    reactivationCurrentPage += direction;
    renderReactivationTable(null); 
};

// 2. Fungsi Tombol "Aktifkan" (Sales Only)
window.activateSleeperClient = (clientName) => {
    // Pindah ke Tab Perencanaan
    const tab1Btn = document.getElementById('tab-btn-1');
    if (tab1Btn) tab1Btn.click();

    // Isi Form Otomatis
    const clientInput = document.getElementById('planClientName');
    const objectiveSelect = document.getElementById('planObjective');
    const capabilitySelect = document.getElementById('planCapability'); // ID Input Capability
    const notesInput = document.getElementById('planNotes');

    if (clientInput) {
        clientInput.value = clientName;
        // Trigger event blur untuk memancing logika lain (jika ada)
        clientInput.dispatchEvent(new Event('blur')); 
    }

    if (objectiveSelect) {
        objectiveSelect.value = 'Perkenalan dan mencari Leads';
        objectiveSelect.dispatchEvent(new Event('change'));
    }

    if (capabilitySelect) {
        capabilitySelect.value = 'IT Outsourcing';
        capabilitySelect.dispatchEvent(new Event('change'));
    }

    if (notesInput) {
        notesInput.value = `Program Reaktivasi Akun Tidur: ${clientName}`;
    }

    // Scroll ke Form
    const formEl = document.getElementById('planForm');
    if (formEl) {
        formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        formEl.classList.add('ring-2', 'ring-orange-500');
        setTimeout(() => formEl.classList.remove('ring-2', 'ring-orange-500'), 1500);
    }
};

// 3. FUNGSI POPUP HISTORY CLIENT (Ini yang membuat nama klien bisa diklik)
window.showClientHistory = (clientName) => {
    // A. Cari data deal milik klien ini dari 'allDeals'
    const clientDeals = allDeals.filter(d => 
        (d.client || '').trim().toLowerCase() === clientName.trim().toLowerCase()
    );

    if (clientDeals.length === 0) {
        // Fallback jika data lokal belum siap
        alert("Data history detail untuk klien ini belum tersedia.");
        return;
    }

    // B. Urutkan dari terbaru
    clientDeals.sort((a, b) => b.meetingDateObj - a.meetingDateObj);

    // C. Hitung Total Revenue
    const totalRevenue = clientDeals
        .filter(d => ['Action','Delivery','Payment'].includes(d.meetingType))
        .reduce((sum, d) => sum + (parseInt(d.value) || 0), 0);

    // D. Isi Modal History (#projectHistoryModal sudah ada di HTML asli)
    document.getElementById('histModalTitle').innerHTML = `${clientName}`;
    document.getElementById('histModalSubtitle').textContent = `Total Revenue (All Time): ${formatIDRShort(totalRevenue)}`;
    document.getElementById('histModalFooter').textContent = `Menampilkan ${clientDeals.length} riwayat aktivitas.`;

    // E. Render List Project
    const contentContainer = document.getElementById('histModalContent');
    contentContainer.innerHTML = clientDeals.map((deal) => {
        const dateStr = deal.meetingDateObj ? deal.meetingDateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        
        let statusColor = 'bg-gray-600';
        if(['Action', 'Delivery', 'Payment'].includes(deal.meetingType)) statusColor = 'bg-green-500';
        else if(deal.meetingType === 'Lost') statusColor = 'bg-red-500';
        else if(['Desire', 'Process Closing'].includes(deal.meetingType)) statusColor = 'bg-yellow-500';
        else statusColor = 'bg-blue-500';

        return `
            <div class="relative pl-4 py-3 pr-4 hover:bg-gray-700/30 transition-colors border-b border-gray-700/50 last:border-0">
                <div class="flex justify-between items-start mb-1">
                    <div>
                        <span class="text-[10px] font-mono text-gray-400 block">${dateStr}</span>
                        <div class="text-sm font-bold text-white">${deal.namaProject || '(Tanpa Nama Project)'}</div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] px-2 py-0.5 rounded text-white ${statusColor} font-bold">${deal.meetingType}</span>
                    </div>
                </div>
                
                <div class="flex justify-between items-end mt-2">
                    <div class="text-xs text-gray-300">
                         Sales: <span class="text-gray-400">${deal.sales}</span>
                    </div>
                    <div class="font-mono text-sm font-semibold text-emerald-400">
                        ${formatIDRShort(deal.value)}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // F. Tampilkan Modal
    const modal = document.getElementById('projectHistoryModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};
// --- FUNGSI PERBAIKAN: Render Sleeper Assets (Cek Rencana Aktif) ---
function renderGlobalSleeperAssets(allDeals) {
    const today = new Date();
    const clientStats = {};
    
    // 1. [BARU] Buat Daftar Klien yang Punya RENCANA AKTIF (Tab 1)
    // Agar klien yang sedang diprospek tidak dianggap "Tidur"
    const activePlanClients = new Set();
    if (typeof allPlans !== 'undefined' && Array.isArray(allPlans)) {
        allPlans.forEach(p => {
            if (p.clientName) {
                // Simpan nama klien dalam huruf kecil agar pencocokan akurat
                activePlanClients.add(p.clientName.trim().toLowerCase());
            }
        });
    }

    // 2. Aggregasi Data Global (History Realisasi)
    allDeals.forEach(deal => {
        const clientName = (deal.client || '').trim();
        if (!clientName) return;

        if (!clientStats[clientName]) {
            clientStats[clientName] = {
                name: clientName,
                sales: deal.sales, 
                revTotal: 0,
                lastOrderDate: null
            };
        }
        
        const stats = clientStats[clientName];
        
        // Cek Tanggal Terakhir Order / Aktivitas
        if (deal.meetingDateObj) {
            if (!stats.lastOrderDate || deal.meetingDateObj > stats.lastOrderDate) {
                stats.lastOrderDate = deal.meetingDateObj;
                stats.sales = deal.sales; 
            }
        }

        // Hitung Total Revenue (Hanya deal WON)
        const status = deal.meetingType;
        const val = parseInt(deal.value) || 0;
        if (['Action', 'Delivery', 'Payment'].includes(status)) {
            stats.revTotal += val;
        }
    });

    // 3. Filter Kriteria Sleeper Assets
    const reactivationTargets = [];
    
    Object.values(clientStats).forEach(client => {
        if (client.revTotal > 0 && client.lastOrderDate) {
            const diffTime = Math.abs(today - client.lastOrderDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            client.dormantDays = diffDays;
            
            // [LOGIKA BARU] Cek apakah klien ini ada di daftar Rencana?
            const isBeingWorkedOn = activePlanClients.has(client.name.toLowerCase());

            // Masuk daftar Sleeper HANYA JIKA:
            // 1. Tidak ada aktivitas > 180 hari
            // 2. DAN Tidak sedang dikerjakan (Tidak ada di Rencana)
            if (diffDays > 180 && !isBeingWorkedOn) {
                reactivationTargets.push(client);
            }
        }
    });

    // 4. Sorting Prioritas Revenue
    reactivationTargets.sort((a, b) => b.revTotal - a.revTotal);

    // 5. Render ke Tabel
    reactivationCurrentPage = 1; 
    renderReactivationTable(reactivationTargets);
}
// --- FITUR RAHASIA: ANALISA KERANCUAN TANGGAL (TIME TRAVEL CHECK) ---
window.auditDateSequence = () => {
    console.log("Memulai Analisa Kronologis...");
    
    // 1. Definisi Urutan Logis Pipeline
    const stageOrder = {
        'Awareness': 1,
        'Interest': 2,
        'Desire': 3,
        'Process Closing': 3, 
        'Action': 4,
        'Delivery': 5,
        'Payment': 6
    };

    const groupedDeals = new Map();

    // 2. Grouping Data
    allDeals.forEach(deal => {
        if (!stageOrder[deal.meetingType]) return;
        if (!deal.meetingDateObj) return;

        let uniqueKey = "";
        // Prioritas Lead ID untuk ditampilkan
        if (deal.nomorRFQ && deal.nomorRFQ.trim().length > 1) {
            uniqueKey = deal.nomorRFQ.trim();
        } else if (deal.projectGUID) {
            uniqueKey = deal.projectGUID;
        } else {
            uniqueKey = deal.client; // Fallback
        }

        if (!groupedDeals.has(uniqueKey)) {
            groupedDeals.set(uniqueKey, []);
        }
        groupedDeals.get(uniqueKey).push(deal);
    });

    // Array untuk menampung Data Mentah (Objek)
    const anomalyList = [];

    // 3. Analisa Setiap Grup
    groupedDeals.forEach((activities, key) => {
        // Urutkan aktivitas berdasarkan TAHAP PIPELINE (Logika Bisnis)
        activities.sort((a, b) => stageOrder[a.meetingType] - stageOrder[b.meetingType]);

        let maxDateSoFar = null;
        let prevStage = "";
        let prevDateStr = "";

        activities.forEach(act => {
            const currentDate = act.meetingDateObj;
            const currDateStr = currentDate.toLocaleDateString('id-ID');

            // LOGIKA DETEKSI: Tanggal mundur
            if (maxDateSoFar && currentDate < maxDateSoFar) {
                
                // Simpan data bersih ke array untuk keperluan Copy
                anomalyList.push({
                    leadId: key,
                    client: act.client, // Opsional: untuk tampilan UI
                    errorDetail: `Tahap ${act.meetingType} (${currDateStr}) terjadi SEBELUM ${prevStage} (${prevDateStr})`
                });
            }

            // Update acuan tanggal hanya jika maju
            if (!maxDateSoFar || currentDate > maxDateSoFar) {
                maxDateSoFar = currentDate;
                prevStage = act.meetingType;
                prevDateStr = currDateStr;
            }
        });
    });

    // 4. Tampilkan Hasil di Modal
    const modal = document.getElementById('auditReportModal');
    const msgBody = document.getElementById('auditMsgBody');
    const textArea = document.getElementById('auditErrorBox');
    const title = modal.querySelector('h3');
    const copyBtn = document.getElementById('auditCopyBtn');

    // Update Judul
    if (title) title.innerHTML = '<i data-lucide="history" class="w-4 h-4 text-purple-400 mr-2"></i> Analisa Kronologis';

    if (anomalyList.length > 0) {
        if (msgBody) msgBody.innerHTML = `Ditemukan <b>${anomalyList.length} Kerancuan Alur Tanggal</b>.`;
        
        // A. SIAPKAN TEKS UNTUK COPY (FORMAT TABULAR UTK EXCEL)
        // Header: Lead ID [TAB] Error Detail
        const header = "LEAD ID\tDETAIL ERROR";
        const content = anomalyList.map(item => `${item.leadId}\t${item.errorDetail}`).join('\n');
        const textForClipboard = header + '\n' + content;

        // Masukkan ke textarea (ini yang akan disalin)
        if (textArea) {
            textArea.value = textForClipboard;
            textArea.style.display = 'none'; // Sembunyikan textarea asli
        }

        // B. SIAPKAN TAMPILAN VISUAL (PRETTY UI)
        const parent = textArea.parentNode;
        // Hapus tampilan lama jika ada
        const oldDiv = parent.querySelector('.custom-audit-list');
        if(oldDiv) oldDiv.remove();

        const displayDiv = document.createElement('div');
        displayDiv.className = "custom-audit-list w-full h-64 bg-gray-900 text-gray-300 text-xs p-3 rounded-lg border border-gray-700 overflow-y-auto custom-scrollbar space-y-2 font-mono";
        
        // Render UI yang cantik
        displayDiv.innerHTML = anomalyList.map(item => `
            <div class="p-2 border-b border-gray-700/50 pb-2 last:border-0 hover:bg-gray-800 transition">
                <span class="text-yellow-500 font-bold">${item.leadId}</span> <span class="text-gray-500">(${item.client})</span><br>
                <span class="text-red-300">↳ ${item.errorDetail}</span>
            </div>
        `).join('');
        
        parent.insertBefore(displayDiv, textArea);

        // C. PERBAIKAN LOGIKA TOMBOL COPY
        if (copyBtn) {
            // Hapus listener lama dengan cloning
            const newCopyBtn = copyBtn.cloneNode(true);
            copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);

            newCopyBtn.addEventListener('click', () => {
                // Salin isi variable textForClipboard, bukan tampilan HTML
                navigator.clipboard.writeText(textForClipboard).then(() => {
                    newCopyBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3 mr-1"></i> Tersalin';
                    newCopyBtn.classList.remove('bg-gray-800', 'text-white', 'border-gray-600');
                    newCopyBtn.classList.add('bg-green-900', 'text-green-300', 'border-green-500');
                    
                    setTimeout(() => {
                        newCopyBtn.innerHTML = '<i data-lucide="copy" class="w-3 h-3 mr-1"></i> Salin';
                        newCopyBtn.classList.add('bg-gray-800', 'text-white', 'border-gray-600');
                        newCopyBtn.classList.remove('bg-green-900', 'text-green-300', 'border-green-500');
                        lucide.createIcons();
                    }, 2000);
                });
            });
        }

        modal.classList.remove('hidden');
    } else {
        showCustomModal("Analisa Waktu", "✅ Alur Waktu Sempurna! Semua tahap berjalan kronologis.");
    }
    
    lucide.createIcons();
};
// ==========================================
// --- FITUR TAMBAHAN: ADVANCED INSIGHTS ---
// ==========================================
function renderAdvancedFeatures(allDeals, salesToDisplay, metrics) {
    // Pastikan DOM sudah ada
    if (!document.getElementById('worryListCard')) return;

    // --- 1. RENDER WORRY LIST (Risk Management) ---
    const worryContainer = document.getElementById('worryListContent');
    const worryCard = document.getElementById('worryListCard');
    const worryBadge = document.getElementById('worryCountBadge');
    const today = new Date();
    const RISK_THRESHOLD_AMOUNT = 500000000; // 500 Juta
    const RISK_THRESHOLD_DAYS = 30; // 30 Hari Vakum

    const riskyDeals = [];
    const processedGuids = new Set();
    const sortedDeals = [...allDeals].sort((a, b) => b.meetingDateObj - a.meetingDateObj);

    sortedDeals.forEach(deal => {
        if (!salesToDisplay.includes(deal.sales)) return;
        
        let guid = deal.projectGUID || (deal.client + "_" + deal.namaProject);
        if (processedGuids.has(guid)) return; 
        processedGuids.add(guid);

        if (['Action', 'Delivery', 'Payment', 'Lost'].includes(deal.meetingType)) return;

        const val = parseInt(deal.value) || 0;
        if (val < RISK_THRESHOLD_AMOUNT) return;

        const lastDate = deal.meetingDateObj;
        const diffDays = Math.ceil(Math.abs(today - lastDate) / (1000 * 60 * 60 * 24));

        if (diffDays > RISK_THRESHOLD_DAYS) {
            riskyDeals.push({ ...deal, days: diffDays });
        }
    });

    // --- 1. RENDER WORRY LIST (Risk Management) ---
    // Pastikan kartu selalu muncul
    worryCard.classList.remove('hidden'); 

    if (riskyDeals.length > 0) {
        // Tampilan jika ada resiko (Warna Merah)
        worryBadge.textContent = `${riskyDeals.length} Deal`;
        worryBadge.className = "text-xs bg-red-900 text-red-200 px-2 py-1 rounded font-bold";
        worryCard.className = "bg-red-900/10 border border-red-500/30 p-6 rounded-xl shadow-lg mt-6 mb-6";
        
        worryContainer.innerHTML = riskyDeals.slice(0, 6).map(d => `
            <div class="bg-gray-900/50 p-3 rounded border-l-4 border-red-500 hover:bg-gray-900 transition relative group">
                <div class="flex justify-between items-start">
                    <div class="w-3/4">
                        <p class="text-xs font-bold text-white truncate" title="${d.client}">${d.client}</p>
                        <p class="text-[10px] text-gray-400 truncate">${d.namaProject || '-'}</p>
                    </div>
                    <span class="text-[10px] bg-red-900 text-red-200 px-1 rounded">${d.days} Hari</span>
                </div>
                <p class="text-xs font-mono text-red-300 mt-1 font-bold">${formatIDRShort(parseInt(d.value))}</p>
                <div class="text-[10px] text-gray-500 mt-1 flex justify-between">
                    <span>${d.sales}</span>
                    <span>${d.meetingType}</span>
                </div>
                <button onclick="window.quickPlanFollowUp('${(d.client||'').replace(/'/g,"\\\\'")}', '${(d.namaProject||'').replace(/'/g,"\\\\'")}', '${d.capability}', '', 'Rescue Follow Up')" 
                    class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 bg-red-600 text-white text-[10px] px-2 py-1 rounded transition">
                    Rescue
                </button>
            </div>
        `).join('');
    } else {
        // Tampilan jika AMAN (Warna Hijau)
        worryBadge.textContent = `0 Deal`;
        worryBadge.className = "text-xs bg-emerald-900 text-emerald-200 px-2 py-1 rounded font-bold";
        worryCard.className = "bg-emerald-900/10 border border-emerald-500/30 p-6 rounded-xl shadow-lg mt-6 mb-6";
        
        worryContainer.innerHTML = `
            <div class="col-span-full py-8 flex flex-col items-center justify-center text-emerald-400">
                <i data-lucide="shield-check" class="w-12 h-12 mb-2 opacity-50"></i>
                <p class="text-sm font-bold">Semua Aman</p>
                <p class="text-[10px] text-emerald-500/70">Tidak ada project besar (>500Jt) yang vakum lebih dari 30 hari.</p>
            </div>
        `;
    }
    // Refresh icon agar ikon baru (shield-check) muncul
    if(window.lucide) window.lucide.createIcons();

    // --- 2. RENDER FUNNEL DROP-OFF ---
    const funnelDiv = document.getElementById('funnelAnalysis');
    const f1 = document.getElementById('convRate1');
    const f2 = document.getElementById('convRate2');
    const f3 = document.getElementById('convRate3');

    if (funnelDiv && metrics) {
        funnelDiv.classList.remove('hidden');
        const amts = metrics.aidaAmount;
        
        const c1 = amts.awareness > 0 ? (amts.interest / amts.awareness) * 100 : 0;
        const c2 = amts.interest > 0 ? (amts.desire / amts.interest) * 100 : 0;
        const c3 = amts.desire > 0 ? (amts.action / amts.desire) * 100 : 0;

        f1.textContent = c1 > 0 ? c1.toFixed(1) + '%' : '0%';
        f2.textContent = c2 > 0 ? c2.toFixed(1) + '%' : '0%';
        f3.textContent = c3 > 0 ? c3.toFixed(1) + '%' : '0%';

        f1.className = `block font-bold text-sm ${c1 < 20 ? 'text-red-400' : 'text-emerald-400'}`;
        f2.className = `block font-bold text-sm ${c2 < 20 ? 'text-red-400' : 'text-yellow-400'}`;
        f3.className = `block font-bold text-sm ${c3 < 20 ? 'text-red-400' : 'text-blue-400'}`;
    }

// --- 3. RENDER SALES CONSISTENCY (METRIK: AMOUNT/REVENUE) ---
    const effContainer = document.getElementById('efficiencyLeaderboard');
    if (effContainer) {
        const consistencyMap = {};

        // A. Kumpulkan Data Tahun & Total Amount per Sales
        allDeals.forEach(d => {
            // Filter Sales yang sedang dilihat
            if (!salesToDisplay.includes(d.sales)) return;
            
            // Filter Tanggal Valid
            if (!d.meetingDateObj) return;

            // HANYA hitung deal yang WON
            if (['Action', 'Delivery', 'Payment'].includes(d.meetingType)) {
                
                if (!consistencyMap[d.sales]) {
                    consistencyMap[d.sales] = { 
                        years: new Set(),
                        totalAmount: 0 // Ganti totalDeals dengan totalAmount
                    };
                }
                
                const year = d.meetingDateObj.getFullYear();
                const val = parseInt(d.value) || 0; // Ambil nilai deal

                consistencyMap[d.sales].years.add(year);
                consistencyMap[d.sales].totalAmount += val; // Akumulasi nilai rupiah
            }
        });

        // B. Ubah ke Array dan Urutkan
        const consistencyList = Object.entries(consistencyMap)
            .map(([name, data]) => {
                const sortedYears = Array.from(data.years).sort(); 
                return { 
                    name, 
                    yearCount: data.years.size, 
                    yearsList: sortedYears,
                    totalAmount: data.totalAmount // Simpan Total Amount
                };
            })
            // Urutkan Ranking: 
            // 1. Tetap berdasarkan Jumlah Tahun (Konsistensi Waktu)
            // 2. Jika tahun sama, ranking berdasarkan Total Amount Terbesar
            .sort((a, b) => {
                if (b.yearCount !== a.yearCount) return b.yearCount - a.yearCount;
                return b.totalAmount - a.totalAmount;
            });

        // C. Render ke HTML
        if (consistencyList.length === 0) {
            effContainer.innerHTML = '<p class="text-xs text-gray-500 italic">Belum ada data closing tercatat.</p>';
        } else {
            effContainer.innerHTML = consistencyList.map((s, i) => {
                // Formatting List Tahun
                const yearsDisplay = s.yearsList.map(y => `'${String(y).slice(-2)}`).join(', ');
                
                // Warna Peringkat
                let rankColor = 'text-gray-400';
                if (i === 0) rankColor = 'text-yellow-400';
                else if (i === 1) rankColor = 'text-gray-300'; 
                else if (i === 2) rankColor = 'text-orange-400';

                return `
                <div class="flex justify-between items-center text-xs p-3 bg-gray-900/30 rounded border border-gray-700/50 hover:bg-gray-700 transition">
                    <div class="flex items-center gap-3">
                        <span class="font-bold font-mono text-sm ${rankColor}">#${i+1}</span>
                        <div>
                            <span class="text-white font-bold block truncate w-32" title="${s.name}">${s.name}</span>
                            <span class="text-[10px] text-gray-500 block">Thn: ${yearsDisplay}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="font-bold text-lg text-emerald-400">${s.yearCount} Thn</span>
                        <span class="text-[10px] text-gray-400 block font-mono">Rp ${formatIDRShort(s.totalAmount)}</span>
                    </div>
                </div>
            `}).join('');
        }
    }
}
    // Mulai aplikasi
    init();
    lucide.createIcons();
});
</script>
</body>
</html>
